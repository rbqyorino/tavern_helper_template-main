<head>
  <style>
    body {
      background: #000000bf !important;
      color: #f5f5f7 !important;
    }
  </style>
  <script type="module">
    var e = {
        387: (e, t, a) => {
          (a.d(t, {
            forceUpdate: () => S,
            getAppInstances: () => k,
            onLoad: () => C,
            onUnload: () => w,
            saveGameState: () => x,
          }),
            a.r(t));
          class n {
            dataManager;
            uiController;
            bindingMap = new Map();
            mvuUpdateCallback;
            prevSnapshot = {
              favor: {},
              currency: {
                lira: 0,
                platinum: 0,
              },
            };
            constructor(e, t) {
              ((this.dataManager = e), (this.uiController = t));
            }
            initialize() {
              (this.setupDataBindings(),
                this.setupMVUEventListening(),
                this.warmupSnapshot(),
                this.forceSync(),
                console.log('数据绑定管理器初始化完成'));
            }
            setupDataBindings() {
              (this.bindData('世界状态', () => {
                (this.updateWorldStateUI(),
                  this.uiController.updateGameInfo(),
                  this.uiController.updateHoverInfoBar(),
                  'quests' === this.uiController.getCurrentView() && this.uiController.renderQuestsView());
              }),
                this.bindData('玩家状态', () => {
                  (this.updatePlayerStateUI(),
                    'status' === this.uiController.getCurrentView() && this.uiController.renderStatusView());
                }),
                this.bindData('角色', () => {
                  (this.updateCharacterStateUI(), this.uiController.updateCharacterDisplay());
                }),
                this.bindData('mapData', () => {
                  this.uiController.renderMapData();
                }),
                this.bindData('inventory', () => {
                  this.updateInventoryUI();
                }),
                this.bindData('hummingbirdData', () => {
                  this.updateHummingbirdUI();
                }));
            }
            bindData(e, t) {
              (this.bindingMap.has(e) || this.bindingMap.set(e, []), this.bindingMap.get(e).push(t));
            }
            triggerDataBinding(e) {
              const t = this.bindingMap.get(e);
              t &&
                t.forEach(t => {
                  try {
                    t();
                  } catch (t) {
                    console.error(`数据绑定回调执行失败 (${e}):`, t);
                  }
                });
            }
            warmupSnapshot() {
              try {
                const e = e => (Array.isArray(e) ? e[0] : e),
                  t = this.dataManager.getMvuData('玩家状态');
                if (t) {
                  const a = e(t.货币) || {};
                  ((this.prevSnapshot.currency.lira = Number(a['里拉(R)'] ?? 0)),
                    (this.prevSnapshot.currency.platinum = Number(a['白金币'] ?? 0)));
                }
                const a = this.dataManager.getMvuData('角色');
                a &&
                  'object' == typeof a &&
                  Object.keys(a).forEach(t => {
                    if ('$meta' === t) return;
                    const n = a[t],
                      s = e(n?.favorability ?? n?.['好感度']);
                    this.prevSnapshot.favor[t] = Number(s ?? 0);
                  });
              } catch (e) {
                console.warn('warmupSnapshot 失败:', e);
              }
            }
            updateWorldStateUI() {
              const e = this.dataManager.getMvuData('世界状态');
              if (!e) return;
              const t = e => (Array.isArray(e) ? e[0] : e),
                a = t(e.当前日期);
              a && $('#current-date').text(a);
              const n = t(e.当前时间段);
              n && $('#current-time-period').text(n);
              const s = t(e.当前地点);
              s && $('#current-location').text(s);
              const i = t(e.报纸);
              i && this.updateNewspaperFromWorldState(i);
            }
            updatePlayerStateUI() {
              const e = this.dataManager.getMvuData('玩家状态');
              if (!e) return;
              const t = e => (Array.isArray(e) ? e[0] : e),
                a = t(e.姓名);
              a && $('#player-name').text(a);
              const n = t(e.货币);
              n &&
                (void 0 !== n['里拉(R)'] &&
                  ($('#player-money').text(`${n['里拉(R)'].toLocaleString()} R`),
                  $('#player-lira').text(`${n['里拉(R)'].toLocaleString()} R`)),
                void 0 !== n['白金币'] && $('#player-platinum').text(`${n['白金币']}`));
              const s = t(e.物品栏);
              s && this.updateInventoryFromPlayerState(s);
            }
            updateCharacterStateUI() {
              this.uiController.updateCharacterDisplay();
            }
            updateNewspaperFromWorldState(e) {
              console.log('🔄 [DataBinding] 从世界状态更新报纸内容:', e);
              const t = e => (Array.isArray(e) ? e[0] : e),
                a = t(e);
              if ((console.log('📰 [DataBinding] 提取后的报纸数据对象:', a), !a || 'object' != typeof a))
                return void console.warn('⚠️ [DataBinding] 报纸数据对象为空');
              const n = t(a.报刊名) || '三界日报',
                s = t(a.头条标题) || '';
              (console.log('📑 [DataBinding] 报刊名:', n),
                console.log('📰 [DataBinding] 头条标题:', s),
                $('#newspaper-name').text(n),
                $('#main-headline').text(s));
              const i = $('#left-column'),
                o = $('#right-column');
              (i.empty(), o.empty());
              const r = a.头条配图;
              if ((console.log('🖼️ [DataBinding] 头条配图:', r), r && Array.isArray(r) && r.length >= 2)) {
                const [e, t] = r;
                if (e) {
                  const a = this.addImageExtensionIfNeeded(e);
                  o.append(
                    `\n          <div class="headline-image-section">\n            <div class="news-image-frame">\n              <img src="${a}" alt="头条配图" class="news-image" />\n              <p class="image-caption">${t || ''}</p>\n            </div>\n          </div>\n        `,
                  );
                }
              }
              const c = a.头条内容;
              (console.log('📄 [DataBinding] 头条内容:', c),
                c &&
                  i.append(
                    `\n        <div class="headline-content">\n          <p class="news-content">${c}</p>\n        </div>\n      `,
                  ));
              const l = a.次要新闻;
              if ((console.log('📋 [DataBinding] 次要新闻:', l), l && Array.isArray(l) && l.length >= 2)) {
                const e = l[0],
                  t = l[1];
                e &&
                  t &&
                  i.append(
                    `\n          <div class="secondary-news">\n            <h3 class="secondary-news-title">${e}</h3>\n            <p class="news-content">${t}</p>\n          </div>\n        `,
                  );
              }
              const d = a.公告栏;
              if ((console.log('📢 [DataBinding] 公告栏:', d), d && Array.isArray(d) && d.length > 0)) {
                o.append(
                  `\n        <div class="announcements-section">\n          <h3 class="news-title">${d[0]}</h3>\n        </div>\n      `,
                );
                for (let e = 1; e < d.length; e++) {
                  const t = d[e];
                  t &&
                    'string' == typeof t &&
                    t.trim() &&
                    o.append(`\n            <p class="news-content announcement-item">${t}</p>\n          `);
                }
              }
              console.log('✅ [DataBinding] 报纸内容从世界状态更新完成');
            }
            addImageExtensionIfNeeded(e) {
              if (e.startsWith('http://') || e.startsWith('https://')) return e;
              return /\.(png|jpg|jpeg|webp|gif|svg)$/i.test(e)
                ? `https://60997b0.webp.li/${e}`
                : `https://60997b0.webp.li/${e}.png`;
            }
            updateInventoryFromPlayerState(e) {
              const t = $('#inventory-grid');
              t.empty();
              const a = Object.keys(e).filter(e => '$meta' !== e).length;
              $('#inventory-total').text(`${a}`);
              const n = Object.entries(e).filter(([e]) => '$meta' !== e);
              0 !== n.length
                ? n.forEach(([e, a]) => {
                    const n = $(
                      `\n        <div class="inventory-item" data-item-id="${e}">\n          <div class="inventory-item-icon"><i class="${a.icon || 'fas fa-question'}"></i></div>\n          <div class="inventory-item-info">\n            <div class="inventory-item-name">${a.name || ''}</div>\n            <div class="inventory-item-description">${a.description || ''}</div>\n          </div>\n          <div class="inventory-item-quantity">x${a.quantity}</div>\n        </div>\n      `,
                    );
                    t.append(n);
                  })
                : t.append(
                    '\n        <div class="inventory-empty">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ',
                  );
            }
            updateInventoryUI() {
              const e = this.dataManager.getMvuData('玩家状态');
              e && e.物品栏 && this.updateInventoryFromPlayerState(e.物品栏);
            }
            updateHummingbirdUI() {}
            forceSync() {
              this.bindingMap.forEach((e, t) => {
                this.triggerDataBinding(t);
              });
            }
            setupMVUEventListening() {
              try {
                if ('undefined' == typeof window || void 0 === window.Mvu)
                  return void console.warn('MVU框架不可用，跳过MVU事件监听设置');
                ((this.mvuUpdateCallback = e => {
                  (console.log('🔔 [DataBinding] 收到 MVU VARIABLE_UPDATE_ENDED 事件'), this.handleMVUDataUpdate(e));
                }),
                  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, this.mvuUpdateCallback),
                  console.log('✅ MVU事件监听设置完成'));
              } catch (e) {
                console.error('❌ 设置MVU事件监听失败:', e);
              }
            }
            handleMVUDataUpdate(e) {
              try {
                ('hummingbird' === this.uiController.getCurrentView() && this.uiController.checkForNewMessages(),
                  this.bindingMap.forEach((e, t) => {
                    e.forEach(e => {
                      try {
                        e();
                      } catch (e) {
                        console.error(`执行数据绑定回调失败 (${t}):`, e);
                      }
                    });
                  }));
              } catch (e) {
                console.error('处理MVU数据更新失败:', e);
              }
            }
            diffAndNotify(e) {
              try {
                const t = e => (Array.isArray(e) ? e[0] : e),
                  a = (e && e['玩家状态']) || this.dataManager.getMvuData('玩家状态');
                if ((console.log('🔔 [DataBinding] diffAndNotify: 玩家状态 =', !!a), a)) {
                  const e = t(a.货币) || {},
                    n = Number(e['里拉(R)'] ?? 0),
                    s = Number(e['白金币'] ?? 0),
                    i = n - (this.prevSnapshot.currency.lira || 0),
                    o = s - (this.prevSnapshot.currency.platinum || 0);
                  (console.log('🔔 [DataBinding] 货币 delta:', i, o),
                    i &&
                      this.uiController.showStatToast({
                        type: 'money',
                        label: '里拉',
                        delta: i,
                      }),
                    o &&
                      this.uiController.showStatToast({
                        type: 'platinum',
                        label: '白金币',
                        delta: o,
                      }),
                    (this.prevSnapshot.currency.lira = n),
                    (this.prevSnapshot.currency.platinum = s));
                }
                const n = (e && e['角色']) || this.dataManager.getMvuData('角色');
                (console.log('🔔 [DataBinding] diffAndNotify: 角色 =', !!n),
                  n &&
                    'object' == typeof n &&
                    Object.keys(n).forEach(e => {
                      if ('$meta' === e) return;
                      const a = n[e],
                        s = t(a?.favorability ?? a?.['好感度']),
                        i = Number(s ?? 0),
                        o = i - Number(this.prevSnapshot.favor[e] ?? i);
                      (console.log('🔔 [DataBinding] 好感 delta:', e, o),
                        o &&
                          this.uiController.showStatToast({
                            type: 'favor',
                            label: `${e} 好感度`,
                            delta: o,
                          }),
                        (this.prevSnapshot.favor[e] = i));
                    }));
              } catch (e) {
                console.warn('diffAndNotify 失败:', e);
              }
            }
            destroy() {
              if (this.mvuUpdateCallback)
                try {
                  ('undefined' != typeof window &&
                    void 0 !== window.Mvu &&
                    (eventRemoveListener(Mvu.events.VARIABLE_UPDATE_ENDED, this.mvuUpdateCallback),
                    console.log('MVU事件监听已清理')),
                    (this.mvuUpdateCallback = void 0));
                } catch (e) {
                  console.error('清理MVU事件监听失败:', e);
                }
              (this.bindingMap.clear(), console.log('数据绑定管理器已销毁'));
            }
          }
          class s {
            static testLLMRPParsing() {
              console.log('测试LLMRP解析功能...');
              const { llmrpParser: e } = k();
              if (e)
                try {
                  if ('undefined' == typeof getCurrentMessageId || 'undefined' == typeof getChatMessages)
                    return void console.warn('酒馆助手API不可用，无法获取当前消息');
                  const t = getCurrentMessageId(),
                    a = getChatMessages(t)[0];
                  if (!a || !a.message) return void console.log('当前没有消息内容');
                  a.message.includes('<game_response>')
                    ? (console.log('发现LLMRP格式消息，开始解析...'),
                      console.log('消息内容预览:', a.message.substring(0, 200) + '...'),
                      e.parseAndExecute(a.message),
                      console.log('✅ LLMRP解析完成'))
                    : (console.log('当前消息不包含LLMRP格式内容'),
                      console.log('消息内容预览:', a.message.substring(0, 100) + '...'));
                } catch (e) {
                  console.error('❌ 测试LLMRP解析时出错:', e);
                }
              else console.error('LLMRP解析器未初始化');
            }
            static testDataBinding() {
              const { gameDataManager: e, dataBindingManager: t } = k();
              if (!e || !t) return void console.error('数据管理器或数据绑定管理器未初始化');
              console.log('测试数据绑定...');
              const a = e.getGameState();
              (a &&
                (e.updateGameState({
                  ...a,
                  timePeriod: '夜晚',
                  currentDate: {
                    month: '火之月',
                    day: 20,
                  },
                }),
                console.log('游戏状态已更新')),
                e.updateCharacter('克罗', {
                  affection: 100,
                }),
                console.log('角色好感度已更新'),
                t.forceSync(),
                console.log('数据绑定测试完成'));
            }
            static testViewSwitching() {
              const { uiController: e } = k();
              if (!e) return void console.error('UI控制器未初始化');
              console.log('测试界面切换...');
              const t = ['status', 'hummingbird', 'inventory', 'map', 'memoir', 'quests', 'newspaper'];
              let a = 0;
              const n = () => {
                if (a < t.length) {
                  const s = t[a];
                  (console.log(`切换到${s}界面`), e.switchView(s), a++, setTimeout(n, 2e3));
                } else (console.log('回到主界面'), e.switchView('novel'), console.log('界面切换测试完成'));
              };
              n();
            }
            static testMVUStorage() {
              const { gameDataManager: e } = k();
              if (!e) return void console.error('数据管理器未初始化');
              console.log('测试MVU变量存储...');
              const t = {
                testKey: 'testValue',
                timestamp: new Date().toISOString(),
                number: Math.random(),
              };
              e.saveMvuData('debugTest', t);
              const a = e.getMvuData('debugTest');
              (console.log('保存的数据:', t),
                console.log('读取的数据:', a),
                JSON.stringify(t) === JSON.stringify(a)
                  ? console.log('✅ MVU变量存储测试通过')
                  : console.log('❌ MVU变量存储测试失败'));
            }
            static testImageLoading() {
              console.log('测试网络图片加载...');
              [
                'https://60997b0.webp.li/克罗 克罗姆艾娜 クロムエイナ (2).png',
                'https://60997b0.webp.li/爱西丝.png',
                'https://60997b0.webp.li/魔界-地图1.png',
                'https://60997b0.webp.li/人界-地图1.png',
              ].forEach((e, t) => {
                const a = new Image();
                ((a.onload = () => {
                  console.log(`✅ 图片${t + 1}加载成功: ${e}`);
                }),
                  (a.onerror = () => {
                    console.log(`❌ 图片${t + 1}加载失败: ${e}`);
                  }),
                  (a.src = e));
              });
            }
            static performanceTest() {
              console.log('开始性能测试...');
              const e = performance.now(),
                { gameDataManager: t } = k();
              if (t) for (let e = 0; e < 100; e++) (t.getGameState(), t.getCharacters(), t.getMvuData('世界状态'));
              const a = performance.now() - e;
              (console.log(`性能测试完成，耗时: ${a.toFixed(2)}ms`),
                a < 100 ? console.log('✅ 性能测试通过') : console.log('⚠️ 性能可能需要优化'));
            }
            static checkMemoryUsage() {
              if ('memory' in performance) {
                const e = performance.memory;
                (console.log('内存使用情况:'),
                  console.log(`已使用: ${(e.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`),
                  console.log(`总计: ${(e.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`),
                  console.log(`限制: ${(e.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`));
              } else console.log('浏览器不支持内存监控');
            }
            static runAllTests() {
              (console.log('🚀 开始运行所有测试...'),
                this.showStatus(),
                this.showMVUVariables(),
                this.checkMemoryUsage(),
                this.testMVUStorage(),
                this.testImageLoading(),
                this.performanceTest(),
                setTimeout(() => {
                  this.testDataBinding();
                }, 1e3),
                setTimeout(() => {
                  this.testLLMRPParsing();
                }, 2e3),
                setTimeout(() => {
                  this.testBGMPlayback();
                }, 3e3),
                setTimeout(() => {
                  this.testViewSwitching();
                }, 12e3),
                setTimeout(() => {
                  (console.log('✅ 所有测试完成'), this.checkMemoryUsage());
                }, 3e4));
            }
            static showStatus() {
              const e = k();
              if (
                (console.log('=== 异世界和平应用状态 ==='),
                console.log('数据管理器:', e.gameDataManager ? '✅ 已初始化' : '❌ 未初始化'),
                console.log('UI控制器:', e.uiController ? '✅ 已初始化' : '❌ 未初始化'),
                console.log('事件处理器:', e.eventHandler ? '✅ 已初始化' : '❌ 未初始化'),
                console.log('LLMRP解析器:', e.llmrpParser ? '✅ 已初始化' : '❌ 未初始化'),
                console.log('渲染管理器:', e.renderManager ? '✅ 已初始化' : '❌ 未初始化'),
                console.log('数据绑定管理器:', e.dataBindingManager ? '✅ 已初始化' : '❌ 未初始化'),
                e.gameDataManager)
              ) {
                const t = e.gameDataManager.getGameState(),
                  a = e.gameDataManager.getCharacters();
                (console.log('游戏状态:', t ? '✅ 已加载' : '❌ 未加载'),
                  console.log('角色数据:', a ? '✅ 已加载' : '❌ 未加载'));
              }
            }
            static showMVUVariables() {
              console.log('=== 当前MVU变量状态 ===');
              try {
                if ('undefined' == typeof window || void 0 === window.Mvu)
                  return void console.error('❌ MVU框架不可用');
                if ('undefined' == typeof getCurrentMessageId)
                  return void console.error('❌ getCurrentMessageId函数不可用');
                console.log('✅ MVU框架可用');
                const e = getCurrentMessageId();
                console.log('当前消息ID:', e);
                const t = Mvu.getMvuData({
                  type: 'message',
                  message_id: e,
                });
                (console.log('完整MVU数据:', t),
                  t && t.stat_data
                    ? (console.log('=== stat_data 内容 ==='),
                      console.log('世界状态:', t.stat_data['世界状态'] || '无数据'),
                      console.log('玩家状态:', t.stat_data['玩家状态'] || '无数据'),
                      console.log('角色:', t.stat_data['角色'] || '无数据'),
                      console.log('所有可用的键:', Object.keys(t.stat_data)))
                    : console.log('❌ 没有stat_data或MVU数据为空'),
                  console.log('=== MVU变量状态查看完成 ==='));
              } catch (e) {
                console.error('❌ 查看MVU变量时出错:', e);
              }
            }
            static testThemeSwitch() {
              console.log('测试主题切换...');
              const e = ['light', 'dark', 'glass'];
              let t = 0;
              const a = () => {
                if (t < e.length) {
                  const n = e[t];
                  (console.log(`切换到${n}主题`),
                    $('.theme-btn').removeClass('active'),
                    $(`.theme-btn[data-theme="${n}"]`).addClass('active'),
                    $('body').attr('data-theme', n),
                    t++,
                    setTimeout(a, 3e3));
                } else console.log('主题切换测试完成');
              };
              a();
            }
            static resetAllData() {
              const { gameDataManager: e } = k();
              if (!e) return void console.error('数据管理器未初始化');
              confirm('确定要重置所有游戏数据吗？此操作不可撤销！') &&
                (console.log('重置所有数据...'), console.log('数据重置完成'));
            }
            static testBGMPlayback() {
              console.log('测试BGM播放功能...');
              const { llmrpParser: e } = k();
              if (!e) return void console.error('LLMRP解析器未初始化');
              const t = ['[bgm|yousei no mori rythm]', '[bgm|peaceful morning]', '[bgm|battle theme intense]'];
              (console.log('准备测试以下BGM指令：', t),
                t.forEach((t, a) => {
                  setTimeout(() => {
                    console.log(`🎵 测试BGM指令 ${a + 1}:`, t);
                    try {
                      (e.parseAndExecute(`<game_response>\n${t}\n</game_response>`),
                        console.log(`✅ BGM指令 ${a + 1} 执行完成`));
                    } catch (e) {
                      console.error(`❌ BGM指令 ${a + 1} 执行失败:`, e);
                    }
                  }, 3e3 * a);
                }),
                setTimeout(
                  () => {
                    console.log('BGM播放功能测试完成');
                  },
                  3e3 * t.length + 1e3,
                ));
            }
          }
          'undefined' != typeof window &&
            ((window.DebugTools = s), console.log('调试工具已加载，使用 DebugTools.showStatus() 查看状态'));
          const i = toastr;
          var o = a.n(i);
          class r {
            dataManager;
            uiController;
            llmrpParser;
            constructor(e, t) {
              ((this.dataManager = e), (this.uiController = t));
            }
            setLLMRPParser(e) {
              this.llmrpParser = e;
            }
            initialize() {
              (this.setupNavigationEvents(),
                this.setupDialogueEvents(),
                this.setupMapEvents(),
                this.setupSettingsEvents(),
                this.setupModalEvents(),
                this.setupMessageListener(),
                this.initializeBreathingEffect(),
                this.initializeKeyboardShortcuts(),
                this.initializeFullscreen(),
                console.log('事件处理器初始化完成'));
            }
            initializeKeyboardShortcuts() {
              this.getKeyboardShortcutsEnabled()
                ? (this.setupKeyboardShortcuts(), console.log('⌨️ 初始化键盘快捷键: 开启'))
                : console.log('⌨️ 初始化键盘快捷键: 关闭');
            }
            initializeFullscreen() {
              this.getFullscreenEnabled()
                ? (this.setupFullscreenListener(), console.log('🖥️ 初始化双击全屏: 开启'))
                : console.log('🖥️ 初始化双击全屏: 关闭');
            }
            initializeBreathingEffect() {
              const e = this.getBreathingEffectSetting();
              (this.setBreathingEffect(e), console.log('🫁 初始化呼吸效果: ' + (e ? '开启' : '关闭')));
            }
            setupNavigationEvents() {
              ($('.nav-btn').off('click.navigation'),
                $('.nav-btn').on('click.navigation', e => {
                  const t = $(e.currentTarget),
                    a = t.data('view');
                  a &&
                    ($('.nav-btn').removeClass('active'),
                    t.addClass('active'),
                    this.uiController.switchView(a),
                    this.sendViewChangeMessage(a));
                }));
            }
            setupDialogueEvents() {
              console.log('🔧 设置对话事件...');
              const e = $('#prev-btn'),
                t = $('#next-btn');
              (console.log('🔍 按钮检查:', {
                prevBtn: e.length,
                nextBtn: t.length,
              }),
                e.off('click.dialogue').on('click.dialogue', () => {
                  (console.log('🔙 Prev按钮被点击'), this.handleDialogueNavigation('prev'));
                }),
                t.off('click.dialogue').on('click.dialogue', () => {
                  (console.log('▶️ Next按钮被点击'), this.handleDialogueNavigation('next'));
                }),
                console.log('✅ 对话事件绑定完成'),
                $('.dialogue-box')
                  .off('click.dialogue')
                  .on('click.dialogue', e => {
                    $(e.target).closest('.dialogue-controls').length > 0 || this.handleDialogueAdvance();
                  }));
            }
            setupMapEvents() {
              ($('.sg-btn').off('click.map'),
                $('.sg-btn').on('click.map', e => {
                  const t = $(e.currentTarget),
                    a = t.data('map');
                  a && ($('.sg-btn').removeClass('active'), t.addClass('active'), this.switchMap(a));
                }));
            }
            setupSettingsEvents() {
              ($('#settings-btn').off('click.settings'),
                $('.theme-btn').off('click.settings'),
                $('#breathing-toggle').off('change.settings'),
                $('#text-animation-type, #text-speed-slider, #font-size-slider').off('change.settings input.settings'),
                $('#bgm-toggle').off('change.settings'),
                $('#hover-bar-position').off('change.settings'),
                $('#keyboard-shortcuts-toggle').off('change.settings'),
                $('#fullscreen-toggle').off('change.settings'),
                $('#reset-settings-btn').off('click.settings'),
                $(document).off('click.settings'),
                $('#settings-btn').on('click.settings', e => {
                  e.stopPropagation();
                  const t = $('#settings-menu'),
                    a = $('#app-container');
                  (t.toggleClass('active'),
                    t.hasClass('active')
                      ? (a.addClass('modal-active'),
                        this.initBreathingToggleState(),
                        this.initTextSettingsState(),
                        this.initBGMSettingsState(),
                        this.initHoverBarPositionState(),
                        this.initKeyboardShortcutsState(),
                        this.initFullscreenState(),
                        console.log('🎨 激活背景模糊效果'))
                      : (a.removeClass('modal-active'), console.log('🎨 取消背景模糊效果')));
                }),
                $('.theme-btn').on('click.settings', e => {
                  const t = $(e.currentTarget),
                    a = t.data('theme');
                  a && ($('.theme-btn').removeClass('active'), t.addClass('active'), this.applyTheme(a));
                }),
                $('#breathing-toggle').on('change.settings', e => {
                  const t = $(e.currentTarget).is(':checked');
                  (this.setBreathingEffect(t), console.log('🫁 呼吸效果已' + (t ? '开启' : '关闭')));
                }),
                $('#text-animation-type').on('change.settings', e => {
                  const t = $(e.currentTarget).val();
                  console.log(`📝 文字动画类型切换为: ${t}`);
                  const a = this.llmrpParser?.getTextAnimationManager();
                  a && a.setAnimationType(t);
                }),
                $('#text-speed-slider').on('input.settings', e => {
                  let t = 210 - parseInt($(e.currentTarget).val(), 10);
                  (Number.isNaN(t) && (t = 50),
                    (t = Math.max(10, Math.min(200, t))),
                    $('#text-speed-value').text(`${t}ms`));
                  const a = this.llmrpParser?.getTextAnimationManager();
                  a && a.setAnimationSpeed(t);
                }),
                $('#font-size-slider').on('input.settings', e => {
                  const t = parseInt($(e.currentTarget).val(), 10);
                  $('#font-size-value').text(`${t}px`);
                  const a = this.llmrpParser?.getTextAnimationManager();
                  a && a.setFontSize(t);
                }),
                $('#bgm-toggle').on('change.settings', async e => {
                  const t = $(e.currentTarget).is(':checked');
                  (await this.setBGMEnabled(t), console.log(`🎵 BGM播放器${t ? '开启' : '关闭'}完成`));
                }),
                $('#hover-bar-position').on('change.settings', e => {
                  const t = $(e.currentTarget).val();
                  (this.setHoverBarPosition(t), console.log(`📍 悬浮条位置已设置为: ${t}`));
                }),
                $('#keyboard-shortcuts-toggle').on('change.settings', e => {
                  const t = $(e.currentTarget).is(':checked');
                  (this.setKeyboardShortcutsEnabled(t), console.log('⌨️ 键盘快捷键已' + (t ? '开启' : '关闭')));
                }),
                $('#fullscreen-toggle').on('change.settings', e => {
                  const t = $(e.currentTarget).is(':checked');
                  (this.setFullscreenEnabled(t), console.log('🖥️ 双击全屏已' + (t ? '开启' : '关闭')));
                }),
                $('#reset-settings-btn').on('click.settings', e => {
                  e.stopPropagation();
                  confirm('确定要恢复所有设置为默认值吗？') &&
                    (this.resetToDefaultSettings(), console.log('🔄 设置已恢复为默认值'));
                }),
                $(document).on('click.settings', e => {
                  if (!$(e.target).closest('#settings-btn, #settings-menu').length) {
                    const e = $('#settings-menu'),
                      t = $('#app-container');
                    e.hasClass('active') &&
                      (e.removeClass('active'),
                      t.removeClass('modal-active'),
                      console.log('🎨 关闭设置菜单，取消背景模糊'));
                  }
                }));
            }
            setupModalEvents() {
              ($('#modal-close-btn').off('click.modal'),
                $('#modal-container').off('click.modal'),
                $('#update-newspaper-btn').off('click.modal'),
                $('#modal-close-btn').on('click.modal', () => {
                  (this.uiController.switchView('novel'), $('.nav-btn').removeClass('active'));
                }),
                $('#modal-container').on('click.modal', e => {
                  e.target === e.currentTarget &&
                    (this.uiController.switchView('novel'), $('.nav-btn').removeClass('active'));
                }),
                $('#update-newspaper-btn').on('click.modal', () => {
                  this.handleUpdateNewspaper();
                }));
            }
            handleUpdateNewspaper() {
              (this.uiController.getCommandManager().addCustomCommand('{{user}}查看最新报纸'),
                o().success('已将"更新报纸"添加到行动计划'),
                console.log('📰 更新报纸已添加到行动计划'));
            }
            async handleDialogueNavigation(e) {
              if ((console.log(`📖 对话导航: ${e}`), 'next' === e)) {
                if (this.llmrpParser) {
                  if (await this.llmrpParser.navigateNext()) return void console.log('📄 显示下一条对话');
                }
                console.log('📄 已是最新对话 (不自动发送)');
              } else {
                if (this.llmrpParser) {
                  if (await this.llmrpParser.navigatePrevious()) return void console.log('📄 显示上一条对话');
                }
                console.log('📄 已是最早对话 (不自动发送)');
              }
            }
            handleDialogueAdvance() {
              const e = this.llmrpParser?.getTextAnimationManager();
              if (e && e.isPlaying()) return (e.skipAnimation(), void console.log('📝 点击对话框：跳过文字动画'));
              (this.handleDialogueNavigation('next'), console.log('📖 点击对话框：尝试进入下一句对话'));
            }
            switchMap(e) {
              (this.dataManager.setCurrentMapType(e),
                this.uiController.renderMapData(),
                console.log(`切换到地图: ${e}`));
            }
            applyTheme(e) {
              $('body').attr('data-theme', e);
              try {
                localStorage.setItem('iswp_theme', e);
              } catch {}
              try {
                document.cookie = `iswp_theme=${encodeURIComponent(e)}; path=/; max-age=31536000`;
              } catch {}
              console.log(`应用主题并已保存: ${e}`);
            }
            setBreathingEffect(e) {
              try {
                localStorage.setItem('iswp_breathing', e.toString());
              } catch (e) {
                console.warn('Could not save breathing setting to localStorage', e);
              }
              try {
                document.cookie = `iswp_breathing=${e}; path=/; max-age=31536000`;
              } catch (e) {
                console.warn('Could not save breathing setting to cookie', e);
              }
              e ? window.enableBreathing?.() : window.disableBreathing?.();
            }
            initBreathingToggleState() {
              const e = this.getBreathingEffectSetting();
              $('#breathing-toggle').prop('checked', e);
            }
            initTextSettingsState() {
              const e = this.llmrpParser?.getTextAnimationManager();
              if (!e) return;
              const t = e.getSettings();
              $('#text-animation-type').val(t.type);
              const a = t.speed,
                n = 210 - a;
              ($('#text-speed-slider').val(n),
                $('#text-speed-value').text(`${a}ms`),
                $('#font-size-slider').val(t.fontSize),
                $('#font-size-value').text(`${t.fontSize}px`));
            }
            getBreathingEffectSetting() {
              try {
                const e = localStorage.getItem('iswp_breathing');
                if (null !== e) return 'true' === e;
                const t = document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);
                if (t) return 'true' === t[1];
              } catch {}
              return !0;
            }
            async sendViewChangeMessage(e) {
              console.log(`🎮 界面切换到: ${this.getViewDisplayName(e)} (不发送消息)`);
            }
            getViewDisplayName(e) {
              return (
                {
                  status: '状态',
                  hummingbird: '蜂鸟通讯',
                  inventory: '背包',
                  map: '地图',
                  memoir: '回忆录',
                  quests: '任务',
                  newspaper: '报纸',
                }[e] || e
              );
            }
            setupMessageListener() {
              console.log('消息监听器设置完成（由统一监听器处理）');
            }
            resetToDefaultSettings() {
              try {
                (this.applyTheme('dark'),
                  $('.theme-btn').removeClass('active'),
                  $('.theme-btn[data-theme="dark"]').addClass('active'),
                  $('#breathing-toggle').prop('checked', !0),
                  this.setBreathingEffect(!0));
                const e = 50,
                  t = 210 - e;
                ($('#text-animation-type').val('typewriter'),
                  $('#text-speed-slider').val(t),
                  $('#text-speed-value').text(`${e}ms`),
                  $('#font-size-slider').val('16'),
                  $('#font-size-value').text('16px'));
                const a = this.llmrpParser?.getTextAnimationManager();
                (a && (a.setAnimationType('typewriter'), a.setAnimationSpeed(e), a.setFontSize(16)),
                  $('#bgm-toggle').prop('checked', !0),
                  this.setBGMEnabled(!0),
                  $('#fullscreen-toggle').prop('checked', !1),
                  this.setFullscreenEnabled(!1),
                  o().success('设置已恢复为默认值'));
              } catch (e) {
                (console.error('恢复默认设置时出错:', e), o().error('恢复默认设置失败'));
              }
            }
            initBGMSettingsState() {
              const e = this.getBGMEnabledSetting();
              ($('#bgm-toggle').prop('checked', e), this.setBGMEnabled(e));
            }
            async setBGMEnabled(e) {
              try {
                localStorage.setItem('iswp_bgm_enabled', e.toString());
              } catch (e) {
                console.warn('Could not save BGM enabled setting to localStorage', e);
              }
              try {
                (console.log(`🎵 正在${e ? '开启' : '关闭'}BGM播放器...`),
                  e
                    ? ('undefined' != typeof audioEnable &&
                        (await audioEnable({
                          type: 'bgm',
                          state: 'true',
                        }),
                        console.log('✅ BGM播放器已启用')),
                      'undefined' != typeof audioPlay &&
                        (await audioPlay({
                          type: 'bgm',
                          play: 'true',
                        }),
                        console.log('✅ BGM播放已开始/恢复')))
                    : ('undefined' != typeof audioPlay &&
                        (await audioPlay({
                          type: 'bgm',
                          play: 'false',
                        }),
                        console.log('✅ BGM播放已暂停')),
                      'undefined' != typeof audioEnable &&
                        (await audioEnable({
                          type: 'bgm',
                          state: 'false',
                        }),
                        console.log('✅ BGM播放器已禁用'))),
                  console.log(`🎵 BGM${e ? '开启' : '关闭'}操作完成`));
              } catch (e) {
                console.error('❌ 设置BGM开关时出错:', e);
                const t = Object.keys(window).filter(e => e.startsWith('audio'));
                (console.log('可用的音频API:', t),
                  t.length || console.warn('⚠️ 酒馆助手音频API完全不可用，可能需要先启用音频播放器插件'));
              }
            }
            getBGMEnabledSetting() {
              try {
                const e = localStorage.getItem('iswp_bgm_enabled');
                if (null !== e) return 'true' === e;
              } catch {}
              return !0;
            }
            initHoverBarPositionState() {
              const e = this.getHoverBarPositionSetting();
              ($('#hover-bar-position').val(e), this.setHoverBarPosition(e));
            }
            setHoverBarPosition(e) {
              try {
                localStorage.setItem('iswp_hover_bar_position', e);
              } catch (e) {
                console.warn('Could not save hover bar position setting to localStorage', e);
              }
              const t = $('#hover-info-bar');
              (t.removeClass('position-top-left position-top-right position-hidden'), t.addClass(`position-${e}`));
            }
            getHoverBarPositionSetting() {
              try {
                const e = localStorage.getItem('iswp_hover_bar_position');
                if (null !== e) return e;
              } catch {}
              return 'top-right';
            }
            initKeyboardShortcutsState() {
              const e = this.getKeyboardShortcutsEnabled();
              $('#keyboard-shortcuts-toggle').prop('checked', e);
            }
            setKeyboardShortcutsEnabled(e) {
              try {
                localStorage.setItem('iswp_keyboard_shortcuts_enabled', e.toString());
              } catch (e) {
                console.warn('Could not save keyboard shortcuts setting', e);
              }
              e ? this.setupKeyboardShortcuts() : this.cleanupKeyboardShortcuts();
            }
            getKeyboardShortcutsEnabled() {
              try {
                const e = localStorage.getItem('iswp_keyboard_shortcuts_enabled');
                if (null !== e) return 'true' === e;
              } catch {}
              return !1;
            }
            setupKeyboardShortcuts() {
              (this.cleanupKeyboardShortcuts(),
                $(document).on('keydown.shortcuts', e => {
                  if ('Escape' === e.key && $('#modal-container').hasClass('active'))
                    return (e.preventDefault(), void $('#modal-close-btn').trigger('click'));
                  if (this.shouldHandleKeyboard())
                    switch (e.key) {
                      case ' ':
                      case 'ArrowRight':
                        (e.preventDefault(), $('#next-btn').trigger('click'));
                        break;
                      case 'ArrowLeft':
                        (e.preventDefault(), $('#prev-btn').trigger('click'));
                    }
                }));
            }
            shouldHandleKeyboard() {
              return (
                !($('input:focus, textarea:focus').length > 0) &&
                !$('#modal-container').hasClass('active') &&
                !($('.dialogue-choices').length > 0)
              );
            }
            cleanupKeyboardShortcuts() {
              $(document).off('.shortcuts');
            }
            initFullscreenState() {
              const e = this.getFullscreenEnabled();
              $('#fullscreen-toggle').prop('checked', e);
            }
            setFullscreenEnabled(e) {
              try {
                localStorage.setItem('iswp_fullscreen_enabled', e.toString());
              } catch (e) {
                console.warn('Could not save fullscreen setting', e);
              }
              e ? this.setupFullscreenListener() : this.cleanupFullscreenListener();
            }
            getFullscreenEnabled() {
              try {
                const e = localStorage.getItem('iswp_fullscreen_enabled');
                if (null !== e) return 'true' === e;
              } catch {}
              return !1;
            }
            setupFullscreenListener() {
              (this.cleanupFullscreenListener(),
                $('#app-container').on('dblclick.fullscreen', e => {
                  $(e.target).closest('.dialogue-box').length > 0 ||
                    $(e.target).closest('#modal-container').length > 0 ||
                    $(e.target).closest('#settings-menu').length > 0 ||
                    this.toggleFullscreen();
                }));
            }
            cleanupFullscreenListener() {
              $('#app-container').off('.fullscreen');
            }
            toggleFullscreen() {
              try {
                document.fullscreenElement
                  ? document.exitFullscreen().catch(e => {
                      console.log(`无法退出全屏模式: ${e.message}`);
                    })
                  : document.documentElement.requestFullscreen().catch(e => {
                      console.log(`无法进入全屏模式: ${e.message}`);
                    });
              } catch (e) {
                console.error('全屏切换失败:', e);
              }
            }
            destroy() {
              (this.cleanupKeyboardShortcuts(),
                this.cleanupFullscreenListener(),
                $('.nav-btn').off('.navigation'),
                $('#prev-btn, #next-btn').off('.dialogue'),
                $('.dialogue-box').off('.dialogue'),
                $('.sg-btn').off('.map'),
                $('#settings-btn, .theme-btn').off('.settings'),
                $('#text-animation-type, #text-speed-slider, #font-size-slider').off('.settings'),
                $('#bgm-toggle, #fullscreen-toggle').off('.settings'),
                $(document).off('.settings'),
                $('#modal-close-btn, #modal-container').off('.modal'),
                console.log('事件处理器已销毁'));
            }
          }
          class c {
            initialized = !1;
            mvuUpdateCallback;
            currentMapType = 'demonRealm';
            setCurrentMapType(e) {
              this.currentMapType = e;
            }
            getCurrentMapType() {
              return this.currentMapType;
            }
            async initialize() {
              try {
                this.getGameData();
                (await this.initializeDefaultData(), (this.initialized = !0), console.log('游戏数据管理器初始化完成'));
              } catch (e) {
                throw (console.error('数据管理器初始化失败:', e), e);
              }
            }
            async initializeDefaultData() {
              if (!this.getMvuData('世界状态')) {
                const e = {
                  当前日期: '',
                  当前时间段: '',
                  当前地点: '',
                  报纸: {
                    报刊名: '',
                    头条标题: '',
                    头条配图: ['', ''],
                    头条内容: '',
                    次要新闻: [],
                    公告栏: [],
                  },
                };
                this.saveMvuData('世界状态', e);
              }
              if (!this.getMvuData('玩家状态')) {
                const e = {
                  姓名: '',
                  货币: {
                    '里拉(R)': 0,
                    白金币: 0,
                  },
                  物品栏: {},
                };
                this.saveMvuData('玩家状态', e);
              }
              if (!this.getMvuData('角色')) {
                const e = {};
                this.saveMvuData('角色', e);
              }
              if (!this.getMvuData('gameState')) {
                const e = {
                  currentView: 'novel',
                  currentDate: {
                    month: '',
                    day: 0,
                  },
                  timePeriod: '',
                  location: {
                    country: '',
                    city: '',
                    place: '',
                  },
                  playerName: '',
                  playerMoney: {
                    r: 0,
                    platinumCoins: 0,
                  },
                };
                this.saveGameState(e);
              }
              if (!this.getMvuData('characters')) {
                const e = {};
                this.saveCharacters(e);
              }
              const e = {
                currentMap: 'demonRealm',
                demonRealm: {
                  image: 'https://60997b0.webp.li/魔界-地图1.png',
                  points: [
                    {
                      id: 'war_domain',
                      name: '战城',
                      description:
                        '由六王之一的"战王"梅基多统治的区域。城市以一座巨大的角斗场为中心，是崇尚力量的魔族们的聚集地，时刻回响着战斗的轰鸣与胜利的欢呼。',
                      coords: {
                        x: 17.17,
                        y: 55.76,
                      },
                    },
                    {
                      id: 'central_great_forest',
                      name: '中央大森林',
                      description:
                        '由六王之一"界王"世界树的化身——莉莉伍德守护着这片领域魔界最广阔、魔力最丰沛的森林地带。森林都市"尤克弗莱西斯"坐落于此，是精灵与妖精们的乐土。',
                      coords: {
                        x: 30.5,
                        y: 50.33,
                      },
                    },
                    {
                      id: 'garden_of_flowers',
                      name: '万花之园',
                      description:
                        '"蔷薇姬"罗兹米爱尔的私人庭园。其入口被强大的结界隐藏在中央大森林边缘，而庭园本体则存在于一个独立的异空间中。园内培育着无数珍稀花卉，是仅有受邀者才能进入的幻之景点。',
                      coords: {
                        x: 34.42,
                        y: 55.19,
                      },
                    },
                    {
                      id: 'underworld_castle',
                      name: '冥王城',
                      description:
                        '六王之一"冥王"克罗姆艾娜的居城。与其说是城堡，更像是一个接纳了众多强大魔族的温馨家园。世界第一的瑟狄奇魔法具商会总部也坐落于此，彰显着此地的非凡地位。',
                      coords: {
                        x: 73.17,
                        y: 44.34,
                      },
                    },
                    {
                      id: 'land_of_death',
                      name: '死之大地',
                      description:
                        '由六王之一"死王"爱西丝统治的极寒之地。常年被永不融化的冰雪覆盖，万物绝迹。尽管如此，这片严酷的大地下确实蕴藏着蓝钻与冰晶等足以动摇世界的稀世珍宝。',
                      coords: {
                        x: 43.42,
                        y: 29.35,
                      },
                    },
                    {
                      id: 'dragon_mountains',
                      name: '龙之山脉',
                      description:
                        '由六王之一"龙王"马格纳威尔统治的区域，是无数龙种栖息的圣地。其麾下强大的"四大魔龙"守护着这片广阔的山脉，非请莫入。',
                      coords: {
                        x: 71.92,
                        y: 60.18,
                      },
                    },
                    {
                      id: 'forbidden_lands',
                      name: '禁忌之地',
                      description:
                        '位于魔界中心的荒芜之地。因六王们曾在此地修炼，残留的强大魔力使其环境极其危险。传闻中，由史莱姆萝泽管理的"六王迷宫"就坐落于此深处。',
                      coords: {
                        x: 52.83,
                        y: 50.62,
                      },
                    },
                  ],
                },
                humanRealm: {
                  image: 'https://60997b0.webp.li/人界-地图1.png',
                  points: [
                    {
                      id: 'symphonia_capital',
                      name: '新法尼亚王国 - 首都',
                      description:
                        '人界三大国之一。气候宜人，饮食文化发达，政治稳定，是一座繁华而和平的城市。也是你最初抵达这个世界的地方。',
                      coords: {
                        x: 85.75,
                        y: 46.91,
                      },
                    },
                    {
                      id: 'archlesia_capital',
                      name: '阿路克雷西亚帝国 - 首都',
                      description:
                        '人界三大国之一，以丰富的矿产资源、卓越的锻冶和建筑技术闻名的军事强国。现由锐意改革的女皇克里斯统治。',
                      coords: {
                        x: 25.08,
                        y: 27.77,
                      },
                    },
                    {
                      id: 'hydra_capital',
                      name: '海德拉王国 - 首都',
                      description:
                        '人界三大国之一，临海的港口国家。服装文化与商业极为发达，社会风气开放，鼓励革新与挑战。由初代勇者的同伴、人鱼女王拉古娜统治。',
                      coords: {
                        x: 45.67,
                        y: 84.61,
                      },
                    },
                    {
                      id: 'friendly_city_hikari',
                      name: '友好都市光',
                      description:
                        '为纪念初代勇者而建，是人、魔、神三界友好条约的签订地。由创造神亲自设立的教主奥莉薇亚守护，是一个独立于三国的和平中立都市。',
                      coords: {
                        x: 54.83,
                        y: 60.9,
                      },
                    },
                    {
                      id: 'falen_town',
                      name: '法伦镇',
                      description:
                        '位于新法尼亚王国，是东西交易的据点。由当代的勇者光永正义及其妻子卡特蕾雅公主共同治理，是一片充满活力的新兴贵族领地。',
                      coords: {
                        x: 79,
                        y: 65.9,
                      },
                    },
                    {
                      id: 'alices_shop',
                      name: '爱丽丝的杂货铺',
                      description:
                        '坐落在王都偏僻小巷里的一家奇特杂货店。店主是戴着面具、言行古怪的少女爱丽丝。店内似乎出售着一些品质极高的珍品，但生意总是异常冷清。',
                      coords: {
                        x: 74.5,
                        y: 34.34,
                      },
                    },
                    {
                      id: 'albert_residence',
                      name: '阿尔伯特公爵府邸',
                      description:
                        '新法尼亚王国的公爵莉莉娅·阿尔伯特的住所，也是你在这个世界最初的家。现在，你自己的宅邸也建在其旁边，两座府邸通过走廊相连，形成了一片广阔的庄园。',
                      coords: {
                        x: 69.67,
                        y: 35.48,
                      },
                    },
                  ],
                },
              };
              this.getMvuData('mapData') || this.saveMapData(e);
            }
            isMvuAvailable() {
              return 'undefined' != typeof window && void 0 !== window.Mvu && 'undefined' != typeof getCurrentMessageId;
            }
            getGameData() {
              try {
                if (!this.isMvuAvailable())
                  return (console.warn('MVU框架不可用，使用本地存储'), this.getLocalStorageData());
                const e = getCurrentMessageId(),
                  t = Mvu.getMvuData({
                    type: 'message',
                    message_id: e,
                  });
                return t?.stat_data || {};
              } catch (e) {
                return (console.warn('获取游戏数据失败，可能是首次运行:', e), this.getLocalStorageData());
              }
            }
            saveGameState(e) {
              this.saveMvuData('gameState', e);
            }
            getGameState() {
              try {
                const e = this.getMvuData('世界状态'),
                  t = this.getMvuData('玩家状态'),
                  a = this.getMvuData('gameState') || {};
                if (!e && !t && !a) return null;
                const n = Array.isArray(e?.当前日期) ? e.当前日期[0] : e?.当前日期,
                  s = Array.isArray(e?.当前时间段) ? e.当前时间段[0] : e?.当前时间段,
                  i = Array.isArray(e?.当前地点) ? e.当前地点[0] : e?.当前地点,
                  o = Array.isArray(t?.姓名) ? t.姓名[0] : t?.姓名,
                  r = Array.isArray(t?.货币) ? t.货币[0] : t?.货币;
                return {
                  currentDate: n
                    ? {
                        month: n.split(' ')[0] || '',
                        day: parseInt(n.split(' ')[1]?.replace('日', '')) || 0,
                      }
                    : {
                        month: '',
                        day: 0,
                      },
                  timePeriod: s || '',
                  location: {
                    country: '',
                    city: '',
                    place: i || '',
                  },
                  playerMoney: r
                    ? {
                        r: r['里拉(R)'] ?? r['人界货币R'] ?? 0,
                        platinumCoins: r['白金币'] ?? r['魔界货币P'] ?? 0,
                      }
                    : {
                        r: 0,
                        platinumCoins: 0,
                      },
                  currentCharacter: a.currentCharacter || '',
                  currentView: a.currentView || 'main',
                  playerName: o || a.playerName || '',
                };
              } catch (e) {
                return (console.error('获取游戏状态失败:', e), null);
              }
            }
            saveCharacters(e) {
              console.debug('[NO-OP] 前端禁写MVU：saveCharacters 被忽略');
            }
            getCharacters() {
              return this.getMvuData('角色');
            }
            saveMapData(e) {
              console.debug('[NO-OP] 前端禁写MVU：saveMapData 被忽略');
            }
            getMapData() {
              const e = this.getMvuData('mapData');
              return (
                e ||
                (console.warn('🗺️ Map data not found in MVU, using default static map data.'),
                {
                  currentMap: 'demonRealm',
                  demonRealm: {
                    image: 'https://60997b0.webp.li/魔界-地图1.png',
                    points: [
                      {
                        id: 'war_domain',
                        name: '战城',
                        description:
                          '由六王之一的"战王"梅基多统治的区域。城市以一座巨大的角斗场为中心，是崇尚力量的魔族们的聚集地，时刻回响着战斗的轰鸣与胜利的欢呼。',
                        coords: {
                          x: 17.17,
                          y: 55.76,
                        },
                      },
                      {
                        id: 'central_great_forest',
                        name: '中央大森林',
                        description:
                          '由六王之一"界王"世界树的化身——莉莉伍德守护着这片领域魔界最广阔、魔力最丰沛的森林地带。森林都市"尤克弗莱西斯"坐落于此，是精灵与妖精们的乐土。',
                        coords: {
                          x: 30.5,
                          y: 50.33,
                        },
                      },
                      {
                        id: 'garden_of_flowers',
                        name: '万花之园',
                        description:
                          '"蔷薇姬"罗兹米爱尔的私人庭园。其入口被强大的结界隐藏在中央大森林边缘，而庭园本体则存在于一个独立的异空间中。园内培育着无数珍稀花卉，是仅有受邀者才能进入的幻之景点。',
                        coords: {
                          x: 34.42,
                          y: 55.19,
                        },
                      },
                      {
                        id: 'underworld_castle',
                        name: '冥王城',
                        description:
                          '六王之一"冥王"克罗姆艾娜的居城。与其说是城堡，更像是一个接纳了众多强大魔族的温馨家园。世界第一的瑟狄奇魔法具商会总部也坐落于此，彰显着此地的非凡地位。',
                        coords: {
                          x: 73.17,
                          y: 44.34,
                        },
                      },
                      {
                        id: 'land_of_death',
                        name: '死之大地',
                        description:
                          '由六王之一"死王"爱西丝统治的极寒之地。常年被永不融化的冰雪覆盖，万物绝迹。尽管如此，这片严酷的大地下确实蕴藏着蓝钻与冰晶等足以动摇世界的稀世珍宝。',
                        coords: {
                          x: 43.42,
                          y: 29.35,
                        },
                      },
                      {
                        id: 'dragon_mountains',
                        name: '龙之山脉',
                        description:
                          '由六王之一"龙王"马格纳威尔统治的区域，是无数龙种栖息的圣地。其麾下强大的"四大魔龙"守护着这片广阔的山脉，非请莫入。',
                        coords: {
                          x: 71.92,
                          y: 60.18,
                        },
                      },
                      {
                        id: 'forbidden_lands',
                        name: '禁忌之地',
                        description:
                          '位于魔界中心的荒芜之地。因六王们曾在此地修炼，残留的强大魔力使其环境极其危险。传闻中，由史莱姆萝泽管理的"六王迷宫"就坐落于此深处。',
                        coords: {
                          x: 52.83,
                          y: 50.62,
                        },
                      },
                    ],
                  },
                  humanRealm: {
                    image: 'https://60997b0.webp.li/人界-地图1.png',
                    points: [
                      {
                        id: 'symphonia_capital',
                        name: '新法尼亚王国 - 首都',
                        description:
                          '人界三大国之一。气候宜人，饮食文化发达，政治稳定，是一座繁华而和平的城市。也是你最初抵达这个世界的地方。',
                        coords: {
                          x: 85.75,
                          y: 46.91,
                        },
                      },
                      {
                        id: 'archlesia_capital',
                        name: '阿路克雷西亚帝国 - 首都',
                        description:
                          '人界三大国之一，以丰富的矿产资源、卓越的锻冶和建筑技术闻名的军事强国。现由锐意改革的女皇克里斯统治。',
                        coords: {
                          x: 25.08,
                          y: 27.77,
                        },
                      },
                      {
                        id: 'hydra_capital',
                        name: '海德拉王国 - 首都',
                        description:
                          '人界三大国之一，临海的港口国家。服装文化与商业极为发达，社会风气开放，鼓励革新与挑战。由初代勇者的同伴、人鱼女王拉古娜统治。',
                        coords: {
                          x: 45.67,
                          y: 84.61,
                        },
                      },
                      {
                        id: 'friendly_city_hikari',
                        name: '友好都市光',
                        description:
                          '为纪念初代勇者而建，是人、魔、神三界友好条约的签订地。由创造神亲自设立的教主奥莉薇亚守护，是一个独立于三国的和平中立都市。',
                        coords: {
                          x: 54.83,
                          y: 60.9,
                        },
                      },
                      {
                        id: 'falen_town',
                        name: '法伦镇',
                        description:
                          '位于新法尼亚王国，是东西交易的据点。由当代的勇者光永正义及其妻子卡特蕾雅公主共同治理，是一片充满活力的新兴贵族领地。',
                        coords: {
                          x: 79,
                          y: 65.9,
                        },
                      },
                      {
                        id: 'alices_shop',
                        name: '爱丽丝的杂货铺',
                        description:
                          '坐落在王都偏僻小巷里的一家奇特杂货店。店主是戴着面具、言行古怪的少女爱丽丝。店内似乎出售着一些品质极高的珍品，但生意总是异常冷清。',
                        coords: {
                          x: 74.5,
                          y: 34.34,
                        },
                      },
                      {
                        id: 'albert_residence',
                        name: '阿尔伯特公爵府邸',
                        description:
                          '新法尼亚王国的公爵莉莉娅·阿尔伯特的住所，也是你在这个世界最初的家。现在，你自己的宅邸也建在其旁边，两座府邸通过走廊相连，形成了一片广阔的庄园。',
                        coords: {
                          x: 69.67,
                          y: 35.48,
                        },
                      },
                    ],
                  },
                })
              );
            }
            getLocalStorageData() {
              try {
                const e = localStorage.getItem('gameData_异世界和平');
                return e ? JSON.parse(e) : null;
              } catch (e) {
                return (console.warn('获取本地存储数据失败:', e), null);
              }
            }
            saveLocalStorageData(e) {
              try {
                localStorage.setItem('gameData_异世界和平', JSON.stringify(e));
              } catch (e) {
                console.error('保存本地存储数据失败:', e);
              }
            }
            saveMvuData(e, t) {
              console.debug('[NO-OP] 前端禁写MVU，忽略保存:', e);
            }
            getMvuData(e) {
              try {
                if (!this.isMvuAvailable()) {
                  console.warn('MVU框架不可用，使用本地存储');
                  const t = this.getLocalStorageData();
                  return t ? t[e] : null;
                }
                const t = getCurrentMessageId(),
                  a = Mvu.getMvuData({
                    type: 'message',
                    message_id: t,
                  });
                return a?.stat_data?.[e] || null;
              } catch (t) {
                console.warn(`获取${e}数据失败:`, t);
                const a = this.getLocalStorageData();
                return a ? a[e] : null;
              }
            }
            updateGameState(e) {
              console.debug('[NO-OP] 前端禁写MVU：updateGameState 被忽略');
            }
            updateCharacter(e, t) {
              console.debug('[NO-OP] 前端禁写MVU：updateCharacter 被忽略');
            }
            extractValue(e) {
              return Array.isArray(e) ? e[0] : e;
            }
            findCharacterIdByName(e) {
              if (!e) return null;
              const t = String(e).trim();
              if (!t) return null;
              const a = e => e.replace(/\s+/g, '').toLowerCase(),
                n = a(t),
                s = this.getCharacters();
              if (!s) return null;
              for (const e of Object.keys(s)) {
                const t = s[e],
                  i = this.extractValue(t.nickname || ''),
                  o = this.extractValue(t.fullName || ''),
                  r = a(e),
                  c = a(i || ''),
                  l = a(o || '');
                if (n === r || (c && n === c) || (l && n === l)) return e;
              }
              let i = null;
              for (const e of Object.keys(s)) {
                const t = s[e],
                  o = this.extractValue(t.nickname || ''),
                  r = this.extractValue(t.fullName || ''),
                  c = a(e),
                  l = a(o || ''),
                  d = a(r || '');
                if (
                  (d && (d.includes(n) || n.includes(d))) ||
                  (l && (l.includes(n) || n.includes(l))) ||
                  (c && (c.includes(n) || n.includes(c)))
                ) {
                  const t = Math.max(c.length, l.length, d.length);
                  (!i || t > i.length) &&
                    (i = {
                      id: e,
                      length: t,
                    });
                }
              }
              return i ? i.id : null;
            }
            getCharacterAvatarUrl(e) {
              if (!e) return null;
              const t = this.findCharacterIdByName(e);
              return t ? `https://60997b0.webp.li/${encodeURIComponent(t)}-头像.png` : null;
            }
            getCharacter(e) {
              const t = this.getCharacters();
              return (t && t[e]) || null;
            }
            saveDialogueHistory(e) {
              console.debug('[NO-OP] 前端禁写MVU：saveDialogueHistory 被忽略');
            }
            getDialogueHistory() {
              return this.getMvuData('dialogueHistory') || [];
            }
            saveQuests(e) {
              console.debug('[NO-OP] 前端禁写MVU：saveQuests 被忽略');
            }
            getQuests() {
              return (
                this.getMvuData('quests') || {
                  main: [],
                  side: [],
                }
              );
            }
            getCurrentQuest() {
              try {
                const e = this.getMvuData('世界状态');
                if (!e || !e.当前任务) return null;
                const t = this.extractValue(e.当前任务);
                return t
                  ? {
                      名称: t.名称 || '无标题任务',
                      详情: t.详情 || '暂无详情',
                    }
                  : null;
              } catch (e) {
                return (console.error('获取当前任务数据失败:', e), null);
              }
            }
            saveHummingbirdData(e) {
              console.debug('[NO-OP] 前端禁写MVU：saveHummingbirdData 被忽略');
            }
            getHummingbirdData() {
              return (
                this.getMvuData('hummingbirdData') || {
                  contacts: [],
                  chats: {},
                }
              );
            }
            onDataChange(e) {
              try {
                if (!this.isMvuAvailable()) return void console.warn('MVU框架不可用，无法设置数据变化监听');
                ((this.mvuUpdateCallback = t => {
                  (console.log('检测到MVU变量更新'), e(t.stat_data));
                }),
                  eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, this.mvuUpdateCallback),
                  console.log('MVU数据变化监听已设置'));
              } catch (e) {
                console.error('设置MVU数据变化监听失败:', e);
              }
            }
            parseGameCommand(e) {
              const t = e.match(/\[游戏指令:(.+?):(.+?)\]/);
              return t
                ? {
                    type: t[1],
                    parameter: t[2],
                  }
                : null;
            }
            executeGameCommand(e) {
              switch (e.type) {
                case '切换角色':
                  this.switchCharacter(e.parameter);
                  break;
                case '更新金钱':
                  this.updateMoney(parseInt(e.parameter));
                  break;
                case '切换位置':
                  this.updateLocation(e.parameter);
                  break;
                default:
                  console.log('未知游戏指令:', e);
              }
            }
            switchCharacter(e) {
              console.debug('[NO-OP] 前端禁写MVU：switchCharacter 被忽略');
            }
            updateMoney(e) {
              console.debug('[NO-OP] 前端禁写MVU：updateMoney 被忽略');
            }
            updateLocation(e) {
              console.debug('[NO-OP] 前端禁写MVU：updateLocation 被忽略');
            }
            destroy() {
              if (this.mvuUpdateCallback && this.isMvuAvailable())
                try {
                  (eventRemoveListener(Mvu.events.VARIABLE_UPDATE_ENDED, this.mvuUpdateCallback),
                    (this.mvuUpdateCallback = void 0),
                    console.log('MVU事件监听已清理'));
                } catch (e) {
                  console.error('清理MVU事件监听失败:', e);
                }
              ((this.initialized = !1), console.log('游戏数据管理器已销毁'));
            }
          }
          class l {
            currentAnimation = null;
            isAnimating = !1;
            currentText = '';
            targetElement = null;
            animationSpeed = 50;
            animationType = 'typewriter';
            constructor() {
              this.loadSettings();
            }
            loadSettings() {
              const e = localStorage.getItem('textAnimationSpeed'),
                t = localStorage.getItem('textAnimationType'),
                a = localStorage.getItem('dialogueFontSize');
              (e && (this.animationSpeed = parseInt(e, 10)),
                t && ['typewriter', 'fade', 'instant'].includes(t) && (this.animationType = t),
                a && this.applyFontSize(parseInt(a, 10)));
            }
            saveSettings() {
              (localStorage.setItem('textAnimationSpeed', this.animationSpeed.toString()),
                localStorage.setItem('textAnimationType', this.animationType));
            }
            setAnimationSpeed(e) {
              ((this.animationSpeed = Math.max(5, Math.min(500, e))),
                localStorage.setItem('textAnimationSpeed', this.animationSpeed.toString()));
            }
            setAnimationType(e) {
              ((this.animationType = e), localStorage.setItem('textAnimationType', e));
            }
            setFontSize(e) {
              (localStorage.setItem('dialogueFontSize', e.toString()), this.applyFontSize(e));
            }
            applyFontSize(e) {
              const t = Math.max(12, Math.min(32, e));
              $('#dialogue-content').css('font-size', `${t}px`);
            }
            async displayText(e, t, a) {
              (this.stopCurrentAnimation(), (this.currentText = e), (this.targetElement = t), (this.isAnimating = !0));
              try {
                switch (this.animationType) {
                  case 'typewriter':
                    await this.typewriterEffect(e, t);
                    break;
                  case 'fade':
                    await this.fadeInEffect(e, t);
                    break;
                  default:
                    this.instantDisplay(e, t);
                }
              } catch (e) {
              } finally {
                ((this.isAnimating = !1), a && a());
              }
            }
            async typewriterEffect(e, t) {
              return (
                t.empty(),
                new Promise((a, n) => {
                  let s = 0;
                  const i = Array.from(e);
                  let o = 0;
                  Date.now();
                  const r = Math.max(0.35, Math.min(2, this.animationSpeed / 50)),
                    c = Math.min(1, this.animationSpeed / 120),
                    l = () => {
                      if (!this.isAnimating) return void n(new Error('Animation stopped'));
                      if (s >= i.length) return void a();
                      const e = i[s];
                      (t.append(e), s++);
                      let d = this.animationSpeed;
                      Date.now();
                      if ('。' === e || '！' === e || '？' === e || '…' === e)
                        ((d *= (1.8 + Math.random() * (0.8 * c)) * r), (o = 0));
                      else if ('，' === e || '、' === e || '；' === e || '：' === e)
                        ((d *= (1.3 + Math.random() * (0.6 * c)) * r), (o = 0));
                      else if (' ' === e) d *= (0.8 + Math.random() * (0.2 * c)) * Math.max(0.5, r);
                      else {
                        const e = Math.random();
                        e < 0.08 && 0 === o
                          ? ((o = 2 + Math.floor(2 * Math.random())), (d *= 0.6))
                          : o > 0
                            ? ((d *= 0.45 + 0.25 * Math.random()), o--)
                            : (d *=
                                e < 0.2
                                  ? (1.8 + Math.random() * (0.8 * c)) * r
                                  : e < 0.4
                                    ? 0.85 + 0.25 * Math.random()
                                    : (0.9 + Math.random() * (0.3 * c)) * r);
                      }
                      this.currentAnimation = window.setTimeout(l, Math.max(d, 12));
                    };
                  l();
                })
              );
            }
            async fadeInEffect(e, t) {
              return (
                t.empty(),
                new Promise((a, n) => {
                  let s = 0;
                  const i = Array.from(e),
                    o = () => {
                      if (!this.isAnimating) return void n(new Error('Animation stopped'));
                      if (s >= i.length) return void a();
                      const e = i[s];
                      (t.append(e), s++);
                      const r = Math.max(1 * this.animationSpeed, 20);
                      this.currentAnimation = window.setTimeout(o, r);
                    };
                  o();
                })
              );
            }
            instantDisplay(e, t) {
              t.text(e).css('opacity', '1');
            }
            stopCurrentAnimation() {
              ((this.isAnimating = !1),
                this.currentAnimation && (clearTimeout(this.currentAnimation), (this.currentAnimation = null)),
                this.targetElement &&
                  this.currentText &&
                  this.targetElement.stop(!0, !0).text(this.currentText).css('opacity', '1'));
            }
            skipAnimation() {
              this.isAnimating && this.targetElement && this.currentText && this.stopCurrentAnimation();
            }
            isPlaying() {
              return this.isAnimating;
            }
            getSettings() {
              const e = parseInt(localStorage.getItem('dialogueFontSize') || '16', 10);
              return {
                speed: this.animationSpeed,
                type: this.animationType,
                fontSize: e,
              };
            }
          }
          class d {
            uiController;
            dataManager;
            stage = [];
            MAX_CHARACTERS = 3;
            characterIdCounter = 0;
            imageCache = new Map();
            MAX_CACHE_SIZE = 20;
            animatingCharacters = new Set();
            currentSpeaker = null;
            constructor(e, t) {
              ((this.uiController = e), (this.dataManager = t));
            }
            normalizeCharacterName(e) {
              return e.replace(/-/g, '').trim();
            }
            async speakCharacter(e, t) {
              console.log('🎭 角色说话:', {
                name: e,
                spriteUrl: t,
              });
              const a = this.normalizeCharacterName(e);
              if (this.animatingCharacters.has(a)) return void console.log('⏭️ 角色正在动画中，跳过:', e);
              await this.preloadImage(t);
              const n = this.stage.findIndex(e => this.normalizeCharacterName(e.name) === a);
              if (n >= 0) {
                const a = this.stage[n];
                (console.log('🔄 更新现有角色立绘:', e),
                  await this.updateCharacterSprite(a, t),
                  this.highlightSpeakingCharacter(a));
              } else (console.log('👋 新角色入场:', e), await this.addCharacter(e, t));
              (await this.relayoutCharacters(), this.syncCurrentCharacterState(e));
            }
            syncCurrentCharacterState(e) {
              try {
                const t = this.dataManager.findCharacterIdByName(e) ?? e;
                (this.dataManager.updateGameState({
                  currentCharacter: t,
                }),
                  this.uiController.updateCharacterDisplay(),
                  console.log('🔄 已同步角色状态:', {
                    characterName: e,
                    matchedId: t,
                  }));
              } catch (e) {
                console.warn('⚠️ 同步角色状态失败:', e);
              }
            }
            async preloadImage(e) {
              if (this.imageCache.has(e)) return (console.log('📷 使用缓存图片:', e), this.imageCache.get(e));
              if (this.imageCache.size >= this.MAX_CACHE_SIZE) {
                const e = this.imageCache.keys().next().value;
                e && (this.imageCache.delete(e), console.log('🧹 清理旧图片缓存:', e));
              }
              return new Promise(t => {
                const a = new Image();
                ((a.onload = () => {
                  (console.log('✅ 图片预加载成功:', e), this.imageCache.set(e, a), t(a));
                }),
                  (a.onerror = () => {
                    console.error('❌ 图片加载失败:', e);
                    const a = new Image();
                    ((a.src =
                      'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4='),
                      this.imageCache.set(e, a),
                      t(a));
                  }),
                  (a.src = e),
                  setTimeout(() => {
                    a.complete || a.onerror?.(new Event('timeout'));
                  }, 5e3));
              });
            }
            async addCharacter(e, t) {
              const a = this.normalizeCharacterName(e);
              this.animatingCharacters.add(a);
              try {
                if (this.stage.length >= this.MAX_CHARACTERS) {
                  const e = this.stage.shift();
                  (console.log('🚪 移除最早角色:', e.name), await this.removeCharacterFromDOM(e));
                }
                const a = {
                  name: e,
                  spriteUrl: t,
                  elementId: 'character-stage-' + ++this.characterIdCounter,
                  entryTime: Date.now(),
                };
                (this.stage.push(a),
                  await this.createCharacterElement(a),
                  await this.playEntryAnimation(a),
                  this.highlightSpeakingCharacter(a),
                  console.log(
                    '✅ 角色已入场，当前舞台:',
                    this.stage.map(e => e.name),
                  ));
              } finally {
                this.animatingCharacters.delete(a);
              }
            }
            async updateCharacterSprite(e, t) {
              if (e.spriteUrl !== t) {
                this.animatingCharacters.add(e.name);
                try {
                  e.spriteUrl = t;
                  const a = $(`#${e.elementId}`);
                  a.length > 0 &&
                    (a.addClass('sprite-changing'),
                    await this.sleep(100),
                    a.attr('src', t),
                    await this.sleep(50),
                    a.removeClass('sprite-changing'),
                    console.log('🔄 立绘切换完成:', e.name));
                } finally {
                  this.animatingCharacters.delete(e.name);
                }
              }
            }
            async relayoutCharacters() {
              const e = this.stage.length;
              console.log('🎯 重新布局角色，数量:', e);
              const t = [];
              for (let a = 0; a < this.stage.length; a++) {
                const n = this.stage[a],
                  s = $(`#${n.elementId}`);
                if (0 === s.length) continue;
                let i;
                ((i =
                  1 === e
                    ? 'center'
                    : 2 === e
                      ? 0 === a
                        ? 'left'
                        : 'right'
                      : ['three-left', 'three-center', 'three-right'][a]),
                  t.push(this.moveToPosition(s, i)));
              }
              await Promise.all(t);
            }
            async createCharacterElement(e) {
              const t = $('.character-container');
              if (0 === t.length) return void console.error('❌ character-container 容器不存在！');
              console.log('🏗️ 创建角色元素:', e.name, '图片:', e.spriteUrl);
              const a = $(
                `\n      <img id="${e.elementId}"\n           class="character-sprite dynamic"\n           src="${e.spriteUrl}"\n           alt="${e.name}"\n           style="opacity: 0;" />\n    `,
              );
              (a.addClass('entering'),
                a
                  .on('load', () => {
                    console.log('✅ 角色图片加载成功:', e.spriteUrl);
                  })
                  .on('error', () => {
                    console.error('❌ 角色图片加载失败:', e.spriteUrl);
                  }));
              const n = t.find('.character-status-tooltip');
              (n.length > 0 ? a.insertBefore(n) : t.append(a), console.log('📦 角色元素已添加到DOM:', e.elementId));
              const s = this.dataManager.findCharacterIdByName(e.name) || e.name;
              (a.attr('data-character-id', s),
                a.on('mouseenter', () => {
                  (this.uiController.renderCharacterStatusTooltipFor(s),
                    this.uiController.positionCharacterTooltipNearElement(a[0]),
                    this.uiController.showCharacterTooltip());
                }),
                a.on('mousemove', () => {
                  this.uiController.positionCharacterTooltipNearElement(a[0]);
                }),
                a.on('mouseleave', () => {
                  this.uiController.hideCharacterTooltip();
                }));
            }
            async playEntryAnimation(e) {
              const t = $(`#${e.elementId}`);
              0 !== t.length
                ? (console.log('🎬 开始入场动画:', e.name),
                  t.addClass('entering'),
                  await this.sleep(300),
                  t.removeClass('entering'),
                  t.css('opacity', '1'),
                  console.log('✨ 入场动画完成:', e.name))
                : console.error('❌ 角色元素不存在:', e.elementId);
            }
            async moveToPosition(e, t) {
              (e
                .removeClass('pos-left pos-center pos-right pos-three-left pos-three-center pos-three-right')
                .addClass(`pos-${t}`),
                await this.sleep(400));
            }
            async removeCharacterFromDOM(e) {
              const t = $(`#${e.elementId}`);
              t.length > 0 && (t.addClass('exiting'), await this.sleep(200), t.remove());
            }
            getStageInfo() {
              return {
                count: this.stage.length,
                characters: this.stage.map(e => e.name),
              };
            }
            highlightSpeakingCharacter(e) {
              this.currentSpeaker !== e.name
                ? ((this.currentSpeaker = e.name),
                  $('.character-sprite.dynamic').removeClass('dimmed'),
                  $('.character-sprite.dynamic').each((t, a) => {
                    const n = $(a);
                    n.attr('id') !== e.elementId && n.addClass('dimmed');
                  }),
                  console.log('🗣️ 角色开始说话:', e.name))
                : console.log('🗣️ 角色继续说话:', e.name);
            }
            clearSpeakerHighlight() {
              ((this.currentSpeaker = null),
                $('.character-sprite.dynamic').removeClass('dimmed'),
                console.log('🗨️ 已清除所有角色暗化效果'));
            }
            async clearStage() {
              if (0 !== this.stage.length) {
                console.log(
                  '🧹 清空舞台，当前角色:',
                  this.stage.map(e => e.name),
                );
                for (const e of this.stage) await this.removeCharacterFromDOM(e);
                ((this.stage = []),
                  (this.characterIdCounter = 0),
                  this.animatingCharacters.clear(),
                  console.log('✅ 舞台已清空'));
              } else console.log('🧹 舞台已为空，无需清理');
            }
            executeCharacterAction(e, t) {
              console.log('🎭 在舞台上查找角色进行动作:', {
                targetCharacterName: e,
                actionType: t,
              });
              const a = this.normalizeCharacterName(e),
                n = this.stage.find(e => this.normalizeCharacterName(e.name) === a);
              if (!n) return void console.warn('⚠️ 目标角色不在舞台上，无法执行动作:', e);
              const s = $(`#${n.elementId}`);
              if (s.length)
                if ((console.log(`🎭 执行${e}的${t}动作`), this.animatingCharacters.has(n.elementId)))
                  console.log('⏳ 角色正在执行其他动画，跳过本次动作');
                else {
                  this.animatingCharacters.add(n.elementId);
                  try {
                    switch (t) {
                      case 'shake':
                        this.executeShakeAction(s, n.elementId);
                        break;
                      case 'jump_up':
                        this.executeJumpUpAction(s, n.elementId);
                        break;
                      case 'jump_down':
                        this.executeJumpDownAction(s, n.elementId);
                        break;
                      default:
                        (console.warn('⚠️ 未知的动作类型:', t), this.animatingCharacters.delete(n.elementId));
                    }
                  } catch (e) {
                    (console.error('❌ 执行角色动作时出错:', e), this.animatingCharacters.delete(n.elementId));
                  }
                }
              else console.warn('⚠️ 角色元素不存在:', n.elementId);
            }
            executeShakeAction(e, t) {
              (console.log('🫨 执行摇晃动作'),
                e.addClass('character-shake'),
                setTimeout(() => {
                  (e.removeClass('character-shake'),
                    this.animatingCharacters.delete(t),
                    console.log('🫨 摇晃动作完成'));
                }, 600));
            }
            executeJumpUpAction(e, t) {
              console.log('⬆️ 执行向上跳跃动作');
              const a = this.getAndRemoveBreathingClasses(e);
              (e.addClass('character-jump-up'),
                setTimeout(() => {
                  (e.removeClass('character-jump-up'),
                    this.restoreBreathingClasses(e, a),
                    this.animatingCharacters.delete(t),
                    console.log('⬆️ 向上跳跃动作完成'));
                }, 400));
            }
            executeJumpDownAction(e, t) {
              console.log('⬇️ 执行向下跳跃动作');
              const a = this.getAndRemoveBreathingClasses(e);
              (e.addClass('character-jump-down'),
                setTimeout(() => {
                  (e.removeClass('character-jump-down'),
                    this.restoreBreathingClasses(e, a),
                    this.animatingCharacters.delete(t),
                    console.log('⬇️ 向下跳跃动作完成'));
                }, 400));
            }
            cleanup() {
              (console.log('🧹 清理立绘系统资源'),
                this.imageCache.clear(),
                this.animatingCharacters.clear(),
                $('.character-sprite.dynamic').removeClass('dimmed'),
                (this.currentSpeaker = null),
                (this.stage = []),
                (this.characterIdCounter = 0),
                $('.character-sprite.dynamic').remove(),
                console.log('✅ 立绘系统资源已清理'));
            }
            sleep(e) {
              return new Promise(t => setTimeout(t, e));
            }
            getAndRemoveBreathingClasses(e) {
              const t = [];
              return (
                ['breathing-natural', 'breathing-sway', 'breathing-pulse', 'breathing-rhythmic'].forEach(a => {
                  e.hasClass(a) && (t.push(a), e.removeClass(a));
                }),
                t.length > 0 && console.log('🌬️ Pausing breathing animation:', t),
                t
              );
            }
            restoreBreathingClasses(e, t) {
              t.length > 0 && (e.addClass(t.join(' ')), console.log('🌬️ Resuming breathing animation:', t));
            }
          }
          class h {
            dataManager;
            uiController;
            textAnimationManager;
            stageManager;
            dialogueHistory = [];
            currentDialogueIndex = -1;
            MAX_DIALOGUE_HISTORY = 100;
            currentBackground = null;
            nextBackground = null;
            currentCG = null;
            displayedCG = null;
            currentBGM = null;
            lastMemoirIndexRecorded = -1;
            constructor(e, t) {
              ((this.dataManager = e),
                (this.uiController = t),
                (this.textAnimationManager = new l()),
                (this.stageManager = new d(this.uiController, this.dataManager)));
            }
            initialize() {
              console.log('LLMRP解析器初始化完成');
            }
            async parseAndExecute(e, t = {}) {
              try {
                const a = e.match(/<game_response>([\s\S]*?)<\/game_response>/);
                if (!a) return;
                const n = a[1];
                ((window.skipChoiceDelay = t.skipChoiceDelay || !1),
                  console.log('🎬 开始解析新剧情，清空舞台和对话历史'),
                  await this.stageManager.clearStage(),
                  (this.dialogueHistory = []),
                  (this.currentDialogueIndex = -1),
                  (this.nextBackground = null),
                  (this.currentCG = null),
                  this.hideCG());
                const s = n
                  .split('\n')
                  .map(e => e.trim())
                  .filter(e => e);
                for (const e of s) {
                  const t = this.parseLine(e);
                  t && (await this.executeCommand(t));
                }
                try {
                  const e = [];
                  for (const t of s) {
                    if (t.startsWith('[') && t.endsWith(']')) continue;
                    const a = t.split('|');
                    if (a.length < 3) continue;
                    const n = (a[0] || '').trim();
                    let s = a.slice(2).join('|').trim();
                    if (((s = s.replace(/\s*\[action\|[^|]+\|[^|\]]+\]\s*/g, '').trim()), !s)) continue;
                    const i = this.dataManager.getCharacterAvatarUrl(n);
                    e.push({
                      speaker: n,
                      text: s,
                      avatarUrl: i,
                    });
                  }
                  this.uiController.setCurrentMemoir(e);
                } catch (e) {
                  console.warn('构建回忆录失败（已忽略）：', e);
                }
                (this.dialogueHistory.length > 0 &&
                  ((this.currentDialogueIndex = 0), await this.displayCurrentDialogue()),
                  this.preloadDialogueImages(),
                  delete window.skipChoiceDelay,
                  this.uiController.updateUI());
              } catch (e) {
                console.error('LLMRP解析失败:', e);
              }
            }
            parseLine(e) {
              const t = e.trim();
              if (!t) return null;
              if (t.startsWith('[') && t.endsWith(']')) {
                const e = t.slice(1, -1),
                  a = e.split('|').map(e => e.trim());
                return (
                  console.log('🔧 解析方括号指令:', {
                    content: e,
                    parts: a,
                    type: a[0],
                  }),
                  {
                    type: a[0],
                    parameters: a.slice(1),
                  }
                );
              }
              const a = t.indexOf('|'),
                n = t.indexOf('|', a + 1);
              if (-1 !== a && -1 !== n) {
                const e = t.substring(0, a).trim(),
                  s = t.substring(a + 1, n).trim(),
                  i = t.substring(n + 1).trim(),
                  o = [e, s, i];
                return (
                  console.log('🔍 检查对话指令:', {
                    line: t,
                    parts: o,
                  }),
                  '' === e
                    ? (console.warn('⚠️ 跳过空角色名'), null)
                    : (console.log('🎭 识别为角色对话:', {
                        角色名: e,
                        立绘: s,
                        对话: i,
                      }),
                      {
                        type: 'CHARACTER_DIALOGUE',
                        parameters: o,
                      })
                );
              }
              return null;
            }
            async executeCommand(e) {
              switch (e.type) {
                case 'CHARACTER_DIALOGUE':
                  await this.handleCharacterDialogue(e.parameters);
                  break;
                case 'bg':
                  await this.handleBackgroundCommand(e.parameters[0]);
                  break;
                case 'bgm':
                  await this.handleBGM(e.parameters[0]);
                  break;
                case 'choice':
                  this.handleChoice(e.parameters);
                  break;
                case 'cg':
                  this.handleCGCommand(e.parameters[0]);
                  break;
                case 'hide_cg':
                  this.handleHideCG();
                  break;
                default:
                  console.log(
                    '❌ 未知或不支持的指令:',
                    e.type,
                    '| 仅支持 [bg|...]、[bgm|...]、[choice|...]、[cg|...]、[hide_cg] 与对话行 角色|立绘|文本',
                  );
              }
            }
            async handleBGM(e) {
              if (e && e.trim())
                try {
                  const t = this.convertBGMNameToUrl(e.trim());
                  if ((console.log('🎵 播放BGM:', e, '-> URL:', t), 'undefined' == typeof audioSelect))
                    return void console.warn('⚠️ 酒馆助手音频API不可用，无法播放BGM');
                  (await audioSelect(
                    {
                      type: 'bgm',
                    },
                    t,
                  ),
                    (this.currentBGM = e.trim()),
                    this.updateHoverInfoBar(),
                    console.log('✅ BGM播放指令已发送:', e));
                } catch (e) {
                  console.error('❌ 播放BGM时出错:', e);
                }
              else console.warn('⚠️ BGM名称为空，跳过播放');
            }
            convertBGMNameToUrl(e) {
              return `https://pub-37188cbfafe34cf8a0ea7ca04480b329.r2.dev/${e}.mp3`;
            }
            async handleBackground(e) {
              console.log('🖼️ 切换背景:', e);
              const t = this.convertToNetworkUrl(e, 'background');
              console.log('🔗 背景URL:', t);
              const a = $('#content-area'),
                n = $('#background-overlay');
              if (!this.currentBackground)
                return (
                  console.log('🎬 设置初始背景'),
                  a.css({
                    'background-image': `url(${t})`,
                    'background-size': 'cover',
                    'background-position': 'center',
                    'background-repeat': 'no-repeat',
                  }),
                  (this.currentBackground = t),
                  void console.log('✅ 初始背景已设置')
                );
              if (this.currentBackground !== t) {
                console.log('🎭 开始背景淡入淡出切换');
                try {
                  (n.css('opacity', '0'),
                    await this.sleep(50),
                    n.css('opacity', '1'),
                    await this.sleep(500),
                    a.css({
                      'background-image': `url(${t})`,
                      'background-size': 'cover',
                      'background-position': 'center',
                      'background-repeat': 'no-repeat',
                    }),
                    await this.sleep(50),
                    n.css('opacity', '0'),
                    await this.sleep(500),
                    (this.currentBackground = t),
                    console.log('✅ 背景切换完成'));
                } catch (e) {
                  (console.error('❌ 背景切换失败:', e),
                    a.css({
                      'background-image': `url(${t})`,
                      'background-size': 'cover',
                      'background-position': 'center',
                      'background-repeat': 'no-repeat',
                    }),
                    n.css('opacity', '0'),
                    (this.currentBackground = t));
                }
              } else console.log('🔄 背景相同，跳过切换');
            }
            async handleBackgroundCommand(e) {
              console.log('📝 处理背景指令:', e);
              const t = this.convertToNetworkUrl(e, 'background');
              (console.log('🧹 场景切换，清理所有立绘'),
                await this.stageManager.clearStage(),
                this.currentBackground
                  ? (console.log('🔗 后续背景已记录，等待推进时切换:', t), (this.nextBackground = t))
                  : (console.log('🎬 第一个背景，立即显示:', t), await this.handleBackground(t)));
            }
            sleep(e) {
              return new Promise(t => setTimeout(t, e));
            }
            handleCharacterDialogue(e) {
              if (e.length < 3) return void console.warn('🚨 CHARACTER_DIALOGUE指令参数不足:', e);
              const [t, a, n] = e;
              if (!t || '' === t) return void console.warn('⚠️ 跳过空角色对话');
              let s = n;
              const i = s.match(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/);
              let o,
                r = null;
              if (i) {
                ((r = {
                  targetCharacter: i[1].trim(),
                  actionType: i[2].trim(),
                }),
                  (s = s.replace(/\s*\[action\|([^|]+)\|([^|\]]+)\]\s*/g, '').trim()),
                  console.log('🎭 检测到角色动作指令:', r));
              }
              console.log('🎭 处理角色对话（记录模式）:', {
                characterName: t,
                spriteFileName: a,
                dialogueText: s,
                actionCommand: r,
              });
              let c = !1;
              (a && '' !== a.trim()
                ? ((o = this.convertToNetworkUrl(a, 'character')),
                  (c = !0),
                  this.updateCharacterData(t, o),
                  console.log('🎭 有立绘角色:', t))
                : console.log('🗨️ 无立绘角色:', t),
                this.addToDialogueHistory({
                  speaker: t,
                  text: s,
                  type: 'dialogue',
                  backgroundUrl: this.nextBackground || void 0,
                  characterName: c ? t : void 0,
                  spriteUrl: o,
                  cgUrl: this.currentCG,
                  actionCommand: r,
                }),
                (this.nextBackground = null),
                console.log('📝 角色对话已记录，等推进时显示立绘和执行动作'));
            }
            syncSpeakerCharacterState(e) {
              try {
                const t = this.dataManager.findCharacterIdByName(e);
                t
                  ? (this.dataManager.updateGameState({
                      currentCharacter: t,
                    }),
                    this.uiController.updateCharacterDisplay(),
                    console.log('🗨️ 已同步无立绘角色状态:', {
                      speakerName: e,
                      matchedId: t,
                    }))
                  : console.log('🗨️ 跳过同步状态（非角色数据中的说话人）:', e);
              } catch (e) {
                console.warn('⚠️ 同步说话角色状态失败:', e);
              }
            }
            updateCharacterData(e, t) {
              const a = this.dataManager.findCharacterIdByName(e) || e;
              this.dataManager.getCharacter(a) &&
                (this.dataManager.updateCharacter(a, {
                  avatar: t,
                }),
                this.dataManager.updateGameState({
                  currentCharacter: a,
                }),
                console.log('📊 角色数据已更新（仅数据，不触发UI）:', a));
            }
            async displayCurrentDialogue() {
              if (this.currentDialogueIndex < 0 || this.currentDialogueIndex >= this.dialogueHistory.length) return;
              const e = this.dialogueHistory[this.currentDialogueIndex];
              (console.log('🎬 显示对话:', e),
                e.backgroundUrl &&
                  e.backgroundUrl !== this.currentBackground &&
                  (console.log('🖼️ 推进到背景切换点，开始切换背景:', e.backgroundUrl),
                  console.log('🧹 推进到背景切换，清理所有立绘'),
                  await this.stageManager.clearStage(),
                  await this.handleBackground(e.backgroundUrl)));
              const t = e.cgUrl ?? null;
              (t !== this.displayedCG && (t ? this.showCG(t) : this.hideCG()),
                e.characterName && e.spriteUrl
                  ? (console.log('🎭 推进到角色对话，显示立绘:', e.characterName),
                    await this.stageManager.speakCharacter(e.characterName, e.spriteUrl))
                  : e.speaker &&
                    (console.log('🗨️ 无立绘角色说话，清除暗化效果:', e.speaker),
                    this.stageManager.clearSpeakerHighlight(),
                    this.syncSpeakerCharacterState(e.speaker)),
                $('#speaker-name').text(e.speaker),
                'choice' === e.type && e.choices
                  ? this.displayChoicesInDialogue(e.choices)
                  : (await this.textAnimationManager.displayText(e.text, $('#dialogue-content')),
                    this.hideChoiceInput(),
                    this.currentDialogueIndex > this.lastMemoirIndexRecorded &&
                      (this.lastMemoirIndexRecorded = this.currentDialogueIndex)),
                e.actionCommand &&
                  setTimeout(() => {
                    this.executeCharacterAction(e.actionCommand.targetCharacter, e.actionCommand.actionType);
                  }, 500),
                this.updateNavigationButtons());
            }
            displayChoicesInDialogue(e) {
              console.log('🎯 在对话框中显示选择项:', e);
              let t = '<div class="dialogue-choices">';
              (e.forEach((e, a) => {
                const n = a + 1;
                t += `\n        <div class="dialogue-choice-item" data-choice="${n}">\n          <div class="dialogue-choice-btn">\n            <span class="choice-text">${e}</span>\n            <button class="choice-quick-send-btn" data-choice="${n}" title="快速发送此选择">\n              <i class="fas fa-paper-plane"></i>\n            </button>\n          </div>\n        </div>\n      `;
              }),
                (t += '</div>'),
                $('#dialogue-content').html(t),
                $('.choice-text')
                  .off('click')
                  .on('click', t => {
                    t.stopPropagation();
                    const a = $(t.currentTarget).closest('.dialogue-choice-item'),
                      n = parseInt(a.data('choice')),
                      s = e[n - 1];
                    (console.log('💭 添加选择到行动列表:', {
                      number: n,
                      text: s,
                    }),
                      this.addChoiceToCommands(s));
                  }),
                $('.choice-quick-send-btn')
                  .off('click')
                  .on('click', t => {
                    t.stopPropagation();
                    const a = parseInt($(t.currentTarget).data('choice')),
                      n = e[a - 1];
                    (console.log('🚀 快速发送选择:', {
                      number: a,
                      text: n,
                    }),
                      this.handleChoiceSelection(a - 1, n));
                  }),
                this.showChoiceInput());
            }
            executeCharacterAction(e, t) {
              console.log('🎭 执行角色动作:', {
                targetCharacter: e,
                actionType: t,
              });
              try {
                this.stageManager.executeCharacterAction(e, t);
              } catch (e) {
                console.error('❌ 执行角色动作失败:', e);
              }
            }
            updateNavigationButtons() {
              const e = $('#prev-btn'),
                t = $('#next-btn');
              this.currentDialogueIndex <= 0
                ? e.prop('disabled', !0).addClass('disabled')
                : e.prop('disabled', !1).removeClass('disabled');
              const a = this.dialogueHistory[this.currentDialogueIndex],
                n = this.currentDialogueIndex >= this.dialogueHistory.length - 1,
                s = a && 'choice' === a.type;
              n || s
                ? (t.prop('disabled', !0).addClass('disabled').removeClass('choice-ready'),
                  console.log('🚫 禁用Next按钮:', n ? '已是最后对话' : '当前是选择界面'))
                : t.prop('disabled', !1).removeClass('disabled').removeClass('choice-ready');
            }
            async navigatePrevious() {
              return (
                this.textAnimationManager.stopCurrentAnimation(),
                this.currentDialogueIndex > 0 && (this.currentDialogueIndex--, await this.displayCurrentDialogue(), !0)
              );
            }
            async navigateNext() {
              if (this.textAnimationManager.isPlaying()) return (this.textAnimationManager.skipAnimation(), !0);
              const e = this.dialogueHistory[this.currentDialogueIndex];
              return e && 'choice' === e.type
                ? (console.log('🚫 当前是选择界面，禁止导航到下一条对话'), !1)
                : this.currentDialogueIndex < this.dialogueHistory.length - 1 &&
                    (this.currentDialogueIndex++, await this.displayCurrentDialogue(), !0);
            }
            getTextAnimationManager() {
              return this.textAnimationManager;
            }
            getCurrentBGM() {
              return this.currentBGM;
            }
            updateHoverInfoBar() {
              try {
                this.uiController &&
                  'function' == typeof this.uiController.updateHoverInfoBar &&
                  this.uiController.updateHoverInfoBar();
              } catch (e) {
                console.error('更新悬浮信息条失败:', e);
              }
            }
            getDialogueInfo() {
              const e = this.dialogueHistory[this.currentDialogueIndex],
                t = e && 'choice' === e.type;
              return {
                current: this.currentDialogueIndex + 1,
                total: this.dialogueHistory.length,
                hasNext: !t && this.currentDialogueIndex < this.dialogueHistory.length - 1,
                hasPrev: this.currentDialogueIndex > 0,
              };
            }
            handleChoice(e) {
              if ((console.log('🎯 选择项:', e), $('.choice-container').remove(), window.skipChoiceDelay))
                return (
                  console.log('🔄 重新渲染模式，将选择项添加到历史但不显示'),
                  void this.addToDialogueHistory({
                    speaker: '选择',
                    text: '请选择你的回应：',
                    type: 'choice',
                    choices: e,
                  })
                );
              (this.addToDialogueHistory({
                speaker: '选择',
                text: '请选择你的回应：',
                type: 'choice',
                choices: e,
                cgUrl: this.currentCG,
              }),
                console.log('📋 选择项已添加到对话历史'));
            }
            showChoiceInput() {
              const e = $('#player-choice-input');
              e.length > 0 && (e.fadeIn(300), console.log('📝 显示选择输入框'), this.bindAddChoiceButton());
            }
            hideChoiceInput() {
              const e = $('#player-choice-input');
              e.length > 0 && (e.fadeOut(300), console.log('📝 隐藏选择输入框'));
            }
            bindAddChoiceButton() {
              $('#add-choice-btn')
                .off('click.addChoice')
                .on('click.addChoice', e => {
                  (e.preventDefault(), e.stopPropagation());
                  const t = $('#choice-text-input'),
                    a = t.val();
                  a && a.trim()
                    ? (console.log('💭 添加自定义选择到行动列表:', a.trim()),
                      this.addChoiceToCommands(a.trim()),
                      t.val(''),
                      o().success('选择已添加到行动列表'))
                    : o().warning('请输入选择内容');
                });
            }
            addChoiceToCommands(e) {
              try {
                (this.uiController.getCommandManager().addChoiceCommand(e), console.log('💭 选择已添加到行动列表:', e));
              } catch (e) {
                console.error('添加选择到行动列表失败:', e);
              }
            }
            async handleChoiceSelection(e, t) {
              (console.log('选择了:', t), $('.dialogue-choices').remove(), this.hideChoiceInput());
              try {
                (await createChatMessages([
                  {
                    role: 'user',
                    message: t,
                  },
                ]),
                  triggerSlash('/trigger'));
              } catch (e) {
                console.error('发送选择失败:', e);
              }
            }
            addToDialogueHistory(e) {
              if ((this.dialogueHistory.push(e), this.dialogueHistory.length > this.MAX_DIALOGUE_HISTORY)) {
                const e = this.dialogueHistory.length - this.MAX_DIALOGUE_HISTORY;
                (this.dialogueHistory.splice(0, e),
                  (this.currentDialogueIndex = Math.max(0, this.currentDialogueIndex - e)),
                  console.log(`📝 对话历史已清理，保留最新${this.MAX_DIALOGUE_HISTORY}条记录`));
              }
            }
            convertToNetworkUrl(e, t = 'other') {
              if (e.startsWith('http')) return e;
              let a = e.split('/').pop() || e;
              return (a.includes('.') || (a += 'background' === t ? '.jpg' : '.png'), 'https://60997b0.webp.li/' + a);
            }
            preloadDialogueImages() {
              try {
                const e = new Set();
                if (
                  (this.dialogueHistory.forEach(t => {
                    (t.backgroundUrl && e.add(t.backgroundUrl),
                      t.spriteUrl && e.add(t.spriteUrl),
                      t.cgUrl && e.add(t.cgUrl));
                  }),
                  0 === e.size)
                )
                  return void console.log('📷 本楼层无需预加载图片');
                (console.log(`📷 开始预加载本楼层的 ${e.size} 张图片...`),
                  Promise.all(
                    Array.from(e).map(e =>
                      this.stageManager.preloadImage(e).catch(t => {
                        console.warn(`⚠️ 预加载图片失败（不影响使用）: ${e}`, t);
                      }),
                    ),
                  )
                    .then(() => {
                      console.log(`✅ 本楼层 ${e.size} 张图片预加载完成`);
                    })
                    .catch(e => {
                      console.warn('⚠️ 部分图片预加载失败（不影响使用）', e);
                    }));
              } catch (e) {
                console.warn('⚠️ 预加载图片时出错（不影响使用）:', e);
              }
            }
            cleanup() {
              (this.stageManager.cleanup(), console.log('LLMRP解析器资源已清理'));
            }
            async destroy() {
              (this.cleanup(),
                await this.stageManager.clearStage(),
                $('.choice-container').remove(),
                console.log('LLMRP解析器已销毁'));
            }
            handleCGCommand(e) {
              const t = this.convertToNetworkUrl(e, 'cg');
              ((this.currentCG = t), console.log('🖼️ 记录CG状态:', t));
            }
            handleHideCG() {
              ((this.currentCG = null), console.log('🧹 记录隐藏CG'));
            }
            showCG(e) {
              const t = $('#cg-layer'),
                a = $('#cg-image');
              (a.attr('src') !== e && a.attr('src', e),
                t.addClass('active'),
                (this.displayedCG = e),
                this.addCGHoverPreview(a, e),
                console.log('🖼️ 显示CG:', e));
            }
            addCGHoverPreview(e, t) {
              (e.off('click.cgPreview'),
                console.log('🔧 为CG图片添加点击预览功能:', t, e.length),
                e.on('click.cgPreview', e => {
                  (e.preventDefault(),
                    e.stopPropagation(),
                    console.log('🖱️ 点击CG显示预览:', t),
                    this.showCGPreview(t));
                }),
                e.on('mouseenter', () => {
                  console.log('🖱️ 鼠标进入CG区域');
                }));
            }
            async showCGPreview(e) {
              console.log('🖼️ 准备显示CG预览弹窗:', e);
              try {
                console.log('🚀 调用SillyTavern.callGenericPopup');
                const t = `<img src="${e}" style="max-width: 100%; height: auto;" alt="CG预览" />`,
                  a = await SillyTavern.callGenericPopup(t, SillyTavern.POPUP_TYPE.DISPLAY, '🖼️ CG预览', {
                    large: !0,
                    wide: !0,
                    okButton: !1,
                    cancelButton: !1,
                  });
                return (
                  console.log('✅ CG预览弹窗显示成功:', a),
                  setTimeout(() => {
                    this.adjustPopupForImage();
                  }, 100),
                  a
                );
              } catch (t) {
                return (console.error('❌ 显示CG预览失败:', t), o().info(`CG预览：${e}`), null);
              }
            }
            adjustPopupForImage() {
              try {
                const e = $('.popup');
                if (e.length > 0) {
                  (console.log('🔧 调整弹窗容器样式'),
                    e.css({
                      'max-width': '95vw',
                      'max-height': '95vh',
                      width: 'auto',
                      height: 'auto',
                      'aspect-ratio': 'unset',
                    }));
                  const t = e.find('.popup-content');
                  t.length > 0 &&
                    t.css({
                      width: 'auto',
                      height: 'auto',
                      'max-width': '100%',
                      'max-height': '100%',
                      'aspect-ratio': 'unset',
                      display: 'flex',
                      'align-items': 'center',
                      'justify-content': 'center',
                    });
                  const a = e.find('img');
                  a.length > 0 &&
                    a.css({
                      'max-width': '100%',
                      'max-height': '85vh',
                      width: 'auto',
                      height: 'auto',
                      'object-fit': 'contain',
                    });
                }
              } catch (e) {
                console.warn('⚠️ 调整弹窗样式失败:', e);
              }
            }
            hideCG() {
              ($('#cg-layer').removeClass('active'), (this.displayedCG = null), console.log('🧹 隐藏CG'));
            }
            async appendDialogueMemo(e) {}
          }
          class g {
            pendingCommands = [];
            commandIdCounter = 0;
            onUIUpdateCallback;
            constructor() {}
            setUIUpdateCallback(e) {
              this.onUIUpdateCallback = e;
            }
            addTravelCommand(e, t) {
              const a = {
                id: 'travel_' + this.commandIdCounter++,
                content: `{{user}}准备前往${t}`,
                type: 'travel',
                timestamp: Date.now(),
                metadata: {
                  targetLocation: t,
                },
              };
              this.addCommand(a);
            }
            addChoiceCommand(e) {
              const t = {
                id: 'choice_' + this.commandIdCounter++,
                content: e.trim(),
                type: 'choice',
                timestamp: Date.now(),
                metadata: {
                  originalInput: e,
                },
              };
              this.addCommand(t);
            }
            addHummingbirdCommand(e, t) {
              const a = `_.assign('角色.${e}.chatHistory[0]', { "sender": "{{user}}", "content": "${t.trim().replace(/"/g, '\\"').replace(/\n/g, '\\n')}" });`,
                n = {
                  id: 'message_' + this.commandIdCounter++,
                  content: a,
                  type: 'message',
                  timestamp: Date.now(),
                  metadata: {
                    characterId: e,
                    originalInput: t,
                  },
                };
              this.addCommand(n);
            }
            addCustomCommand(e) {
              const t = {
                id: 'custom_' + this.commandIdCounter++,
                content: e.trim(),
                type: 'custom',
                timestamp: Date.now(),
              };
              this.addCommand(t);
            }
            addCommand(e) {
              (this.pendingCommands.push(e), this.updatePendingCommandsUI());
            }
            removeCommand(e) {
              const t = this.pendingCommands.findIndex(t => t.id === e);
              if (-1 !== t) {
                this.pendingCommands.splice(t, 1)[0];
                this.updatePendingCommandsUI();
              }
            }
            clearAllCommands() {
              ((this.pendingCommands = []), this.updatePendingCommandsUI());
            }
            getPendingCommands() {
              return [...this.pendingCommands];
            }
            getCommandCount() {
              return this.pendingCommands.length;
            }
            getFinalContent() {
              return 0 === this.pendingCommands.length ? '' : this.pendingCommands.map(e => e.content).join('\n');
            }
            sendAllCommands() {
              if (0 === this.pendingCommands.length) return !1;
              const e = this.getFinalContent();
              try {
                const t = $('#send_textarea', window.parent.document);
                if (t.length > 0)
                  return (t.val(e), this.showSendFeedback('行动已发送到酒馆', !0), this.clearAllCommands(), !0);
                {
                  const t = $('#send_textarea');
                  return t.length > 0
                    ? (t.val(e), this.showSendFeedback('行动已发送', !0), this.clearAllCommands(), !0)
                    : navigator.clipboard
                      ? (navigator.clipboard
                          .writeText(e)
                          .then(() => {
                            (this.showSendFeedback('行动已复制到剪贴板', !0), this.clearAllCommands());
                          })
                          .catch(e => {
                            this.showSendFeedback('执行失败，请手动复制', !1);
                          }),
                        !0)
                      : (this.showSendFeedback('执行失败', !1), !1);
                }
              } catch (e) {
                return (console.error('执行行动时出错', e), this.showSendFeedback('执行出错', !1), !1);
              }
            }
            updatePendingCommandsUI() {
              (this.onUIUpdateCallback && this.onUIUpdateCallback(this.pendingCommands), this.updateCommandBadge());
            }
            updateCommandBadge() {
              const e = this.pendingCommands.length,
                t = $('.nav-btn[data-view="commands"]');
              (t.find('.command-badge').remove(), e > 0 && t.append(`<div class="command-badge">${e}</div>`));
            }
            showSendFeedback(e, t) {}
          }
          class u {
            dataManager;
            currentView = 'novel';
            currentSelectedContact = null;
            chatHistoryCache = new Map();
            unreadMessages = new Set();
            commandManager;
            constructor(e) {
              ((this.dataManager = e),
                (this.commandManager = new g()),
                this.commandManager.setUIUpdateCallback(e => {
                  this.renderPendingCommandsUI(e);
                }));
            }
            getCurrentView() {
              return this.currentView;
            }
            getCommandManager() {
              return this.commandManager;
            }
            updateUserInfo() {
              try {
                const e = SillyTavern.name1 || '用户';
                ($('#player-name').text(e),
                  console.log('✅ 用户信息更新完成:', {
                    userName: e,
                  }),
                  console.log('🎭 用户头像将通过 user-avatar CSS 类自动设置'));
              } catch (e) {
                (console.error('❌ 更新用户信息失败:', e), $('#player-name').text('用户'));
              }
            }
            initialize() {
              (this.renderInitialUI(),
                this.setupViewSwitching(),
                this.updateUserInfo(),
                this.updateHoverInfoBar(),
                this.setupHoverInfoBarEvents(),
                console.log('UI控制器初始化完成'));
            }
            renderInitialUI() {
              (this.updateGameInfo(),
                this.updateCharacterDisplay(),
                this.updateDialogue(),
                this.renderMapData(),
                this.renderNewspaperContent());
            }
            updateGameInfo() {
              const e = this.dataManager.getMvuData('世界状态');
              if (e) {
                const t = e => (Array.isArray(e) ? e[0] : e),
                  a = t(e.当前日期);
                a && $('#current-date').text(a);
                const n = t(e.当前时间段);
                n && $('#current-time-period').text(n);
                const s = t(e.当前地点);
                s && $('#current-location').text(s);
              }
              const t = this.dataManager.getMvuData('玩家状态');
              if (t) {
                const e = (e => (Array.isArray(e) ? e[0] : e))(t.货币);
                e && void 0 !== e['里拉(R)'] && $('#player-money').text(`${e['里拉(R)'].toLocaleString()} R`);
              }
            }
            updateCharacterDisplay() {
              const e = this.dataManager.getCharacters();
              if (!e) return;
              const t = this.dataManager.getGameState();
              let a = t?.currentCharacter || null;
              if (!a) {
                const e = $('#speaker-name').text();
                a = this.dataManager.findCharacterIdByName(e);
              }
              if (!a || !e[a]) return;
              const n = e[a],
                s = Array.isArray(n.fullName) ? n.fullName[0] : n.fullName,
                i = Array.isArray(n.affiliation) ? n.affiliation[0] : n.affiliation,
                o = Array.isArray(n.race) ? n.race[0] : n.race,
                r = Array.isArray(n.rank) ? n.rank[0] : n.rank,
                c = Array.isArray(n.relationship_with_user) ? n.relationship_with_user[0] : n.relationship_with_user,
                l = Array.isArray(n.favorability) ? n.favorability[0] : n.favorability,
                d = Array.isArray(n.likes) ? n.likes[0] : n.likes,
                h = Array.isArray(n.dislikes) ? n.dislikes[0] : n.dislikes;
              ($('#character-fullname').text(s || ''), $('#character-affiliation').text(i || ''));
              const g = $('#status-tooltip-body');
              (g.empty(),
                o &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${o}</span>\n        </div>\n      `,
                  ),
                r &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `,
                  ),
                c &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${c}</span>\n        </div>\n      `,
                  ),
                void 0 !== l &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${l}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${l}</span>\n          </div>\n        </div>\n      `,
                  ));
              const u = $('#status-tooltip-footer');
              if ((u.empty(), d && Array.isArray(d) && d.length > 0)) {
                const e = d.map(e => `<span class="status-tag">${e}</span>`).join('');
                u.append(
                  `\n        <div class="status-tags-container">\n          <span class="status-label">喜欢</span>\n          <div class="status-tags">${e}</div>\n        </div>\n      `,
                );
              }
              if (h && Array.isArray(h) && h.length > 0) {
                const e = h.map(e => `<span class="status-tag">${e}</span>`).join('');
                u.append(
                  `\n        <div class="status-tags-container">\n          <span class="status-label">讨厌</span>\n          <div class="status-tags">${e}</div>\n        </div>\n      `,
                );
              }
            }
            renderCharacterStatusTooltipByName(e) {
              const t = this.dataManager.findCharacterIdByName(e) || e;
              this.renderCharacterStatusTooltipFor(t);
            }
            renderCharacterStatusTooltipFor(e) {
              const t = this.dataManager.getCharacters();
              if (!t || !t[e])
                return (
                  $('#character-fullname').text(''),
                  $('#character-affiliation').text(''),
                  $('#status-tooltip-body').empty(),
                  void $('#status-tooltip-footer').empty()
                );
              const a = t[e],
                n = e => (Array.isArray(e) ? e[0] : e),
                s = n(a.fullName) || e,
                i = n(a.affiliation) || '',
                o = n(a.race) || '',
                r = n(a.rank) || '',
                c = n(a.relationship_with_user) || '',
                l = n(a.favorability),
                d = n(a.likes) || [],
                h = n(a.dislikes) || [];
              ($('#character-fullname').text(s), $('#character-affiliation').text(i));
              const g = $('#status-tooltip-body');
              if (
                (g.empty(),
                o &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${o}</span>\n        </div>\n      `,
                  ),
                r &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `,
                  ),
                c &&
                  g.append(
                    `\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${c}</span>\n        </div>\n      `,
                  ),
                void 0 !== l)
              ) {
                const e = Number(l) || 0,
                  t = Math.max(0, Math.min(100, e));
                g.append(
                  `\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${t}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${e}</span>\n          </div>\n        </div>\n      `,
                );
              }
              const u = $('#status-tooltip-footer');
              if ((u.empty(), Array.isArray(d))) {
                const e = d.filter(e => e && '$__META_EXTENSIBLE__$' !== e);
                if (e.length > 0) {
                  const t = e.map(e => `<span class="status-tag">${e}</span>`).join('');
                  u.append(
                    `\n          <div class="status-tags-container">\n            <span class="status-label">喜欢</span>\n            <div class="status-tags">${t}</div>\n          </div>\n        `,
                  );
                }
              }
              if (Array.isArray(h)) {
                const e = h.filter(e => e && '$__META_EXTENSIBLE__$' !== e);
                if (e.length > 0) {
                  const t = e.map(e => `<span class="status-tag">${e}</span>`).join('');
                  u.append(
                    `\n          <div class="status-tags-container">\n            <span class="status-label">讨厌</span>\n            <div class="status-tags">${t}</div>\n          </div>\n        `,
                  );
                }
              }
            }
            ensureCharacterTooltipHost() {
              let e = $('.character-status-tooltip').not('.hummingbird-tooltip').first();
              0 === e.length && (e = $('.character-layer .character-status-tooltip').first());
              const t = $('.ui-layer');
              return (e.length && t.length && e.parent()[0] !== t[0] && e.appendTo(t), e);
            }
            positionCharacterTooltipNearElement(e) {
              const t = this.ensureCharacterTooltipHost();
              if (0 === t.length) return;
              t.addClass('active').css({
                left: 0,
                top: 0,
                transform: 'none',
              });
              const a = t[0].getBoundingClientRect(),
                n = $('.ui-layer')[0];
              if (!n) return;
              const s = n.getBoundingClientRect(),
                i = e.getBoundingClientRect(),
                o = i.left + i.width / 2,
                r = window.innerWidth,
                c = r / 3,
                l = (2 * r) / 3;
              let d = 0;
              if (1 === $('.character-layer [data-character-id]').filter(':visible').length) {
                const e = r - (i.right + 0.8 * i.width),
                  t = i.left - 0.8 * i.width;
                d = e > 100 ? 0.8 * i.width : t > 100 ? 0.8 * -i.width : e > t ? 0.7 * i.width : 0.7 * -i.width;
              } else d = o < c ? 0.7 * i.width : o > l ? 0.7 * -i.width : 0.5 * -i.width;
              const h = i.left - s.left + i.width / 2 + d,
                g = i.top - s.top + 0.15 * i.height;
              let u = h - a.width / 2,
                m = g - a.height - 12;
              const p = s.width - a.width - 8;
              u = Math.max(8, Math.min(p, u));
              const v = $('.top-header-container')[0],
                f = v ? v.getBoundingClientRect().bottom - s.top : 0,
                y = Math.max(8, f + 8),
                b = s.height - a.height - 8;
              ((m = Math.max(y, Math.min(b, m))),
                t.css({
                  left: `${u}px`,
                  top: `${m}px`,
                  transform: 'none',
                }));
            }
            showCharacterTooltip() {
              this.ensureCharacterTooltipHost().addClass('active');
            }
            hideCharacterTooltip() {
              this.ensureCharacterTooltipHost().removeClass('active');
            }
            updateDialogue() {
              const e = $('#speaker-name').text(),
                t = $('#dialogue-content').text();
              ((e && '' !== e.trim()) || $('#speaker-name').text(''),
                (t && '' !== t.trim()) || $('#dialogue-content').text(''));
            }
            renderMapData() {
              console.log('🗺️ 开始渲染地图数据...');
              const e = this.dataManager.getMapData();
              if ((console.log('📊 地图数据:', e), !e)) return void console.warn('⚠️ 地图数据为空');
              const t = this.dataManager.getCurrentMapType();
              ($('.sg-btn').removeClass('active'),
                $(`.sg-btn[data-map="${t}"]`).addClass('active'),
                console.log('🎯 更新地图按钮状态:', t));
              const a = e[t];
              (console.log('🖼️ 当前地图数据:', a), console.log('🔗 地图图片URL:', a.image));
              const n = $('#map-image');
              (console.log('🎯 地图图片元素:', n.length),
                n
                  .off('load error')
                  .on('load', () => {
                    console.log('✅ 地图图片加载成功:', a.image);
                  })
                  .on('error', e => {
                    console.error('❌ 地图图片加载失败:', a.image, e);
                  }),
                n.attr('src', a.image),
                $('.map-point').remove());
              const s = $('.map-canvas');
              (console.log('📍 地图画布元素:', s.length),
                console.log('📍 地图点数量:', a.points.length),
                a.points.forEach((e, t) => {
                  console.log(`📍 创建地图点 ${t + 1}:`, e);
                  const a = $(
                    `\n        <div class="map-point" data-point-id="${e.id}"\n             style="left: ${e.coords.x}%; top: ${e.coords.y}%;">\n        </div>\n      `,
                  );
                  (a.on('mouseenter', t => {
                    this.showMapTooltip(t, e);
                  }),
                    a.on('mouseleave', () => {
                      this.hideMapTooltip();
                    }),
                    a.on('click', () => {
                      (this.commandManager.addTravelCommand(e.id, e.name),
                        console.log(`🗺️ 点击地图点: ${e.name}`),
                        a.addClass('clicked'),
                        setTimeout(() => {
                          a.removeClass('clicked');
                        }, 300));
                    }),
                    s.append(a));
                }),
                console.log('✅ 地图渲染完成'));
            }
            showMapTooltip(e, t) {
              const a = $('#map-tooltip');
              a.html(`\n      <h3>${t.name}</h3>\n      <p>${t.description}</p>\n    `);
              const n = e.target.getBoundingClientRect(),
                s = $('.map-canvas')[0].getBoundingClientRect();
              let i = n.left - s.left + n.width / 2,
                o = n.top - s.top;
              a.addClass('active').css({
                left: 0,
                top: 0,
                transform: 'none',
              });
              const r = a[0].getBoundingClientRect(),
                c = r.width,
                l = r.height;
              ((i -= c / 2), (o = o - l - 12));
              const d = s.width - c - 8,
                h = s.height - l - 8;
              ((i = Math.max(8, Math.min(d, i))),
                (o = Math.max(8, Math.min(h, o))),
                a.css({
                  left: `${i}px`,
                  top: `${o}px`,
                  transform: 'none',
                }));
            }
            hideMapTooltip() {
              $('#map-tooltip').removeClass('active');
            }
            renderNewspaperContent() {
              (console.log('🗞️ 开始渲染报纸内容'),
                $('#newspaper-shadow-image').attr('src', 'https://60997b0.webp.li/阴影层-报纸-树叶1.png'),
                $('#newspaper-bg-image').attr('src', 'https://60997b0.webp.li/报纸背景MockUp-5.png'));
              const e = this.dataManager.getMvuData('世界状态');
              console.log('🌍 世界状态原始数据:', e);
              const t = e => (Array.isArray(e) ? e[0] : e),
                a = e?.报纸;
              console.log('📰 报纸原始数据:', a);
              const n = t(a);
              if ((console.log('📰 提取后的报纸数据对象:', n), !n || 'object' != typeof n))
                return (
                  console.warn('⚠️ 未找到报纸数据对象'),
                  $('#main-headline').text('暂无报纸数据'),
                  void $('#headline-subtitle').text('请检查MVU变量配置')
                );
              (console.log('🔍 报纸数据对象的所有键:', Object.keys(n)), console.log('🔍 报纸数据对象内容:', n));
              const s = t(n.报刊名) || '三界日报',
                i = t(n.头条标题) || '';
              (console.log('📑 报刊名:', s),
                console.log('📰 头条标题:', i),
                console.log('🔍 头条配图原始值:', n.头条配图),
                console.log('🔍 头条内容原始值:', n.头条内容),
                console.log('🔍 次要新闻原始值:', n.次要新闻),
                console.log('🔍 公告栏原始值:', n.公告栏),
                $('#newspaper-name').text(s),
                $('#main-headline').text(i),
                $('#left-column').empty(),
                $('#right-column').empty());
              const o = n.头条配图;
              if ((console.log('🖼️ 头条配图:', o), o && Array.isArray(o) && o.length >= 2)) {
                const [e, t] = o;
                if (e) {
                  const a = this.addImageExtensionIfNeeded(e);
                  $('#right-column').append(
                    `\n          <div class="headline-image-section">\n            <div class="news-image-frame">\n              <img src="${a}" alt="头条配图" class="news-image" />\n              <p class="image-caption">${t || ''}</p>\n            </div>\n          </div>\n        `,
                  );
                }
              }
              const r = n.头条内容;
              (console.log('📄 头条内容:', r),
                r &&
                  $('#left-column').append(
                    `\n        <div class="headline-content">\n          <p class="news-content">${r}</p>\n        </div>\n      `,
                  ));
              const c = n.次要新闻;
              if ((console.log('📋 次要新闻:', c), c && Array.isArray(c) && c.length >= 2)) {
                const e = c[0],
                  t = c[1];
                e &&
                  t &&
                  $('#left-column').append(
                    `\n          <div class="secondary-news">\n            <h3 class="secondary-news-title">${e}</h3>\n            <p class="news-content">${t}</p>\n          </div>\n        `,
                  );
              }
              const l = n.公告栏;
              if ((console.log('📢 公告栏:', l), l && Array.isArray(l) && l.length > 0)) {
                $('#right-column').append(
                  `\n        <div class="announcements-section">\n          <h3 class="news-title">${l[0]}</h3>\n        </div>\n      `,
                );
                for (let e = 1; e < l.length; e++) {
                  const t = l[e];
                  t &&
                    'string' == typeof t &&
                    t.trim() &&
                    $('#right-column').append(
                      `\n            <p class="news-content announcement-item">${t}</p>\n          `,
                    );
                }
              }
              console.log('✅ 报纸内容渲染完成');
            }
            addImageExtensionIfNeeded(e) {
              if (e.startsWith('http://') || e.startsWith('https://')) return e;
              return /\.(png|jpg|jpeg|webp|gif|svg)$/i.test(e)
                ? `https://60997b0.webp.li/${e}`
                : `https://60997b0.webp.li/${e}.png`;
            }
            setupViewSwitching() {}
            switchView(e) {
              (console.log('🔄 切换视图到:', e), (this.currentView = e));
              const t = $('#app-container'),
                a = $('#modal-container'),
                n = a.find('.view-container'),
                s = a.hasClass('active');
              if ('novel' === e)
                return (
                  n.removeClass('active'),
                  a.removeClass('active'),
                  t.removeClass('modal-active'),
                  void console.log('📱 显示主界面，取消背景模糊')
                );
              switch (
                (n.removeClass('active'),
                $(`#view-${e}`).addClass('active'),
                s
                  ? console.log('🎯 保持模态容器开启，仅切换内部视图')
                  : requestAnimationFrame(() => {
                      (a.addClass('active'), t.addClass('modal-active'), console.log('🎨 显示模态界面，激活背景模糊'));
                    }),
                e)
              ) {
                case 'status':
                  this.renderStatusView();
                  break;
                case 'hummingbird':
                  this.renderHummingbirdView();
                  break;
                case 'map':
                  this.renderMapData();
                  break;
                case 'quests':
                  this.renderQuestsView();
                  break;
                case 'newspaper':
                  this.renderNewspaperContent();
                  break;
                case 'commands':
                  this.renderPendingCommandsView();
                  break;
                case 'memoir':
                  this.renderMemoirView();
              }
            }
            showStatToast(e) {
              try {
                let t = $('#' + 'stat-toast-container');
                0 === t.length &&
                  ((t = $('<div id="stat-toast-container" class="stat-toast-container"></div>')), $('body').append(t));
                const a = e.delta > 0 ? '+' : '',
                  n = e.delta > 0 ? 'gain' : 'loss';
                let s = 'fa-star';
                switch (e.type) {
                  case 'favor':
                    s = 'fa-heart';
                    break;
                  case 'money':
                    s = 'fa-coins';
                    break;
                  case 'platinum':
                    s = 'fa-gem';
                    break;
                  case 'item':
                    s = 'fa-box';
                }
                const i = 'item' === e.type ? `+${e.delta}` : `${a}${Number(e.delta.toFixed(2))}`,
                  o = $(
                    `\n        <div class="stat-toast ${n}">\n          <i class="fas ${s}"></i>\n          <span class="label">${e.label}</span>\n          <span class="delta">${i}</span>\n        </div>\n      `,
                  );
                (t.append(o), setTimeout(() => o.addClass('show'), 50));
                const r = t.children('.stat-toast');
                (r.length > 5 && r.first().remove(),
                  setTimeout(() => {
                    (o.removeClass('show'), setTimeout(() => o.remove(), 400));
                  }, 2800));
              } catch (e) {
                console.warn('showStatToast failed:', e);
              }
            }
            _currentMemoir = [];
            setCurrentMemoir(e) {
              this._currentMemoir = Array.isArray(e) ? e : [];
            }
            renderMemoirView() {
              try {
                const e = $('#view-memoir #event-list'),
                  t = $('#view-memoir #event-details');
                (e.empty(), t.empty());
                const a = this._currentMemoir || [];
                if (!a.length) return void e.html('<div class="empty-hint">暂无回忆</div>');
                const n = [];
                n.push('<ul class="memoir-list">');
                for (let e = 0; e < a.length; e++) {
                  const t = a[e],
                    s = t && 'object' == typeof t && !Array.isArray(t),
                    i = String(s ? (t.text ?? '') : (t ?? '')),
                    o = $('<div>').text(i).html().replace(/\n/g, '<br/>'),
                    r = String(s ? (t.speaker ?? '') : '').trim(),
                    c = s ? (t.avatarUrl ?? null) : null,
                    l = r || '旁白',
                    d = `<div class="memoir-speaker">${$('<div>').text(l).html()}</div>`,
                    h = c
                      ? `<img class="memoir-avatar" src="${$('<div>').text(c).html()}" alt="avatar"/>`
                      : '<div class="memoir-avatar default"><i class="fas fa-user-circle"></i></div>';
                  n.push(
                    `<li class="memoir-item">\n             ${h}\n             <div class="memoir-meta">\n               ${d}\n               <div class="memoir-text">${o}</div>\n             </div>\n           </li>`,
                  );
                }
                (n.push('</ul>'), e.html(n.join('')));
              } catch (e) {
                (console.warn('渲染回忆录视图失败:', e),
                  $('#view-memoir #event-list').html('<div class="empty-hint">无法加载回忆录</div>'));
              }
            }
            renderStatusView() {
              (this.updateUserInfo(), this.setupStatusTabs());
              const e = this.dataManager.getMvuData('玩家状态');
              if (!e) return;
              const t = e => (Array.isArray(e) ? e[0] : e),
                a = t(e.基本属性),
                n = a?.rank;
              $('#status-rank').text(n || '—');
              const s = t(e.货币);
              s &&
                ($('#player-lira').text(`${s['里拉(R)']?.toLocaleString() || 0}`),
                $('#player-platinum').text(`${s['白金币'] || 0}`));
              const i = $('#status-skills');
              i.empty();
              const o = t(e.技能);
              if (
                (console.log('🔍 技能原始数据:', e.技能), console.log('🔍 技能MVU提取后:', o), o && Array.isArray(o))
              ) {
                const e = o.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.name);
                (console.log('🔍 过滤后的技能数据:', e),
                  e.length > 0
                    ? e.forEach(e => {
                        const t = e.name || '',
                          a = e.effect || '';
                        t.trim() && i.append(`<li><strong>${t}</strong>${a ? `<br/><small>${a}</small>` : ''}</li>`);
                      })
                    : i.append('<li class="empty-state">暂无技能</li>'));
              } else i.append('<li class="empty-state">暂无技能</li>');
              const r = $('#status-titles');
              r.empty();
              const c = t(e.称号);
              if (
                (console.log('🔍 称号原始数据:', e.称号), console.log('🔍 称号MVU提取后:', c), c && Array.isArray(c))
              ) {
                const e = c.filter(
                  e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && (e.name || e['名称']),
                );
                (console.log('🔍 过滤后的称号数据:', e),
                  e.length > 0
                    ? e.forEach(e => {
                        const t = (e.name ?? e['名称'] ?? '').toString(),
                          a = (e.description ?? e['详情'] ?? '').toString();
                        t.trim() && r.append(`<li><strong>${t}</strong>${a ? `<br/><small>${a}</small>` : ''}</li>`);
                      })
                    : r.append('<li class="empty-state">暂无称号</li>'));
              } else r.append('<li class="empty-state">暂无称号</li>');
              const l = $('#status-blessings');
              l.empty();
              const d = t(e.祝福);
              if (
                (console.log('🔍 祝福原始数据:', e.祝福), console.log('🔍 祝福MVU提取后:', d), d && Array.isArray(d))
              ) {
                const e = d.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.name);
                (console.log('🔍 过滤后的祝福数据:', e),
                  e.length > 0
                    ? e.forEach(e => {
                        const t = e.name || '',
                          a = e.effect || '';
                        t.trim() && l.append(`<li><strong>${t}</strong>${a ? `<br/><small>${a}</small>` : ''}</li>`);
                      })
                    : l.append('<li class="empty-state">暂无祝福</li>'));
              } else l.append('<li class="empty-state">暂无祝福</li>');
              const h = t(e.物品栏);
              if (h) {
                const e = Object.keys(h).length;
                ($('#inventory-count').text(`${e}`), this.updateEquipmentPreview(h));
              }
              this.renderInventoryTab(h);
            }
            setupStatusTabs() {
              ($('.panel-tabs .tab-btn').off('click.status-tabs'),
                $('.panel-tabs .tab-btn').on('click.status-tabs', e => {
                  const t = $(e.currentTarget),
                    a = t.data('tab');
                  ($('.panel-tabs .tab-btn').removeClass('active'),
                    t.addClass('active'),
                    $('.tab-content').removeClass('active'),
                    $(`#tab-${a}`).addClass('active'),
                    console.log(`切换到标签页: ${a}`));
                }));
            }
            updateEquipmentPreview(e) {
              const t = $('#equipment-preview');
              if ((t.empty(), !e))
                return void t.append(
                  '\n        <div class="equipment-empty">\n          <i class="fas fa-shield-alt"></i>\n          <p>暂无装备</p>\n        </div>\n      ',
                );
              const a = Object.entries(e).filter(([e, t]) => t.isEquipped);
              0 === a.length
                ? t.append(
                    '\n        <div class="equipment-empty">\n          <i class="fas fa-shield-alt"></i>\n          <p>暂无装备</p>\n        </div>\n      ',
                  )
                : a.forEach(([e, a]) => {
                    const n = this.getItemTypeIcon(a.type),
                      s = $(
                        `\n          <div class="equipment-item-detailed" data-item-id="${e}">\n            <div class="equipment-item-header">\n              <div class="equipment-item-icon">\n                <i class="${n}"></i>\n              </div>\n              <div class="equipment-item-main-info">\n                <div class="equipment-item-name">${e}</div>\n                <div class="equipment-item-type">${a.type}</div>\n              </div>\n              <div class="equipment-item-badge">装备中</div>\n            </div>\n            <div class="equipment-item-description">\n              ${a.description || '暂无描述'}\n            </div>\n          </div>\n        `,
                      );
                    (s.on('click', () => {
                      this.showItemDetails(a, e);
                    }),
                      t.append(s));
                  });
            }
            renderInventoryTab(e) {
              const t = $('#inventory-grid'),
                a = $('#inventory-total');
              if ((t.empty(), !e))
                return (
                  a.text('0'),
                  void t.append(
                    '\n        <div class="inventory-empty-message">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ',
                  )
                );
              const n = Object.entries(e).filter(([e]) => '$meta' !== e);
              if ((a.text(n.length.toString()), 0 === n.length))
                return void t.append(
                  '\n        <div class="inventory-empty-message">\n          <i class="fas fa-box-open"></i>\n          <p>背包空空如也</p>\n        </div>\n      ',
                );
              (this.sortInventoryItems(n).forEach(([e, a]) => {
                const n = this.getItemTypeIcon(a.type),
                  s = $(
                    `\n        <div class="inventory-item-slot" data-item-id="${e}">\n          <div class="item-icon">\n            <i class="${n}"></i>\n          </div>\n          <div class="item-name">${e}</div>\n          <div class="item-quantity">x${a.quantity || 1}</div>\n          ${a.isEquipped ? '<div class="equipped-badge">装备中</div>' : ''}\n        </div>\n      `,
                  );
                (s.on('click', () => {
                  (t.find('.inventory-item-slot').removeClass('selected'),
                    s.addClass('selected'),
                    this.showItemDetails(a, e));
                }),
                  t.append(s));
              }),
                this.setupInventorySorting(e));
            }
            sortInventoryItems(e) {
              const t = $('#inventory-sort-select').val(),
                a = 'asc' === ($('#inventory-sort-order').attr('data-order') || 'asc');
              return e.sort(([e, n], [s, i]) => {
                let o, r;
                switch (t) {
                  case 'name':
                    ((o = e.toLowerCase()), (r = s.toLowerCase()));
                    break;
                  case 'type':
                    ((o = (n.type || '').toLowerCase()), (r = (i.type || '').toLowerCase()));
                    break;
                  case 'quantity':
                    ((o = n.quantity || 0), (r = i.quantity || 0));
                    break;
                  default:
                    return 0;
                }
                return o < r ? (a ? -1 : 1) : o > r ? (a ? 1 : -1) : 0;
              });
            }
            setupInventorySorting(e) {
              ($('#inventory-sort-select').off('change.inventory-sort'),
                $('#inventory-sort-order').off('click.inventory-sort'),
                $('#inventory-sort-select').on('change.inventory-sort', () => {
                  this.renderInventoryTab(e);
                }),
                $('#inventory-sort-order').on('click.inventory-sort', t => {
                  const a = $(t.currentTarget),
                    n = 'asc' === (a.attr('data-order') || 'asc') ? 'desc' : 'asc';
                  a.attr('data-order', n);
                  const s = a.find('i');
                  ('desc' === n
                    ? s.removeClass('fa-sort-amount-down').addClass('fa-sort-amount-up')
                    : s.removeClass('fa-sort-amount-up').addClass('fa-sort-amount-down'),
                    this.renderInventoryTab(e));
                }));
            }
            showItemDetails(e, t) {
              const a = $('#item-details-panel'),
                n = this.getItemTypeIcon(e.type),
                s = t;
              (a.html(
                `\n      <div class="item-details">\n        <div class="item-details-header">\n          <div class="item-icon-large">\n            <i class="${n}"></i>\n          </div>\n          <div class="item-basic-info">\n            <h3 class="item-name">${s}</h3>\n            <p class="item-type">${e.type}</p>\n          </div>\n        </div>\n        <div class="item-details-body">\n          <div class="item-description">\n            <h4>描述</h4>\n            <p>${e.description || '暂无描述'}</p>\n          </div>\n          <div class="item-properties">\n            <h4>属性</h4>\n            <ul>\n              <li>数量: ${e.quantity || 1}</li>\n              <li>状态: ${e.isEquipped ? '已装备' : '背包中'}</li>\n            </ul>\n          </div>\n\n          \x3c!-- 交互按钮区域 - 样式占位，防止未来UI抖动 --\x3e\n          <div class="item-detail-actions">\n            ${this.generateItemActionButtons(e, t)}\n          </div>\n        </div>\n      </div>\n    `,
              ),
                a
                  .find('.gift-btn')
                  .off('click.gift')
                  .on('click.gift', () => {
                    this.showGiftDialog(t, e);
                  }));
              const i = e => {
                (this.showSendFeedback(e, !0), this.getCommandManager().addCustomCommand(e));
              };
              (a
                .find('.equip-btn')
                .off('click.equip')
                .on('click.equip', () => {
                  i(`{{user}}装备了"${t}"`);
                }),
                a
                  .find('.unequip-btn')
                  .off('click.unequip')
                  .on('click.unequip', () => {
                    i(`{{user}}卸下了"${t}"`);
                  }),
                a
                  .find('.use-btn')
                  .off('click.use')
                  .on('click.use', () => {
                    i(`{{user}}使用了"${t}"`);
                  }),
                a
                  .find('.discard-btn')
                  .off('click.discard')
                  .on('click.discard', () => {
                    const e = `\n          <div id="discard-dialog" class="modal-overlay">\n            <div class="gift-dialog-content">\n              <div class="gift-dialog-header">\n                <h3>丢弃物品</h3>\n                <button class="gift-dialog-close"><i class="fas fa-times"></i></button>\n              </div>\n              <div class="gift-dialog-body">\n                <p>确认要丢弃 <strong>${t}</strong> 吗？此操作仅作为行动计划，不会直接修改背包数据。</p>\n              </div>\n              <div class="gift-dialog-footer">\n                <button class="discard-confirm-btn primary-btn">确认丢弃</button>\n                <button class="gift-cancel-btn secondary-btn">取消</button>\n              </div>\n            </div>\n          </div>`;
                    $('body').append(e);
                    const a = $('#discard-dialog');
                    (a.find('.discard-confirm-btn').on('click', () => {
                      (i(`{{user}}丢弃了"${t}"`), a.remove());
                    }),
                      a.find('.gift-cancel-btn, .gift-dialog-close').on('click', () => a.remove()),
                      a.on('click', e => {
                        e.target === a[0] && a.remove();
                      }));
                  }));
            }
            showGiftDialog(e, t) {
              const a = this.dataManager.getMvuData('角色');
              if (!a) return void this.showSendFeedback('未找到可赠送的角色', !1);
              const n = e => (Array.isArray(e) ? e[0] : e),
                s = Object.entries(a).filter(([, e]) => {
                  const t = n(e.nickname);
                  return t && t.trim();
                });
              if (0 === s.length) return void this.showSendFeedback('没有可赠送的角色', !1);
              const i = `\n      <div id="gift-dialog" class="modal-overlay">\n        <div class="gift-dialog-content">\n          <div class="gift-dialog-header">\n            <h3>赠送物品</h3>\n            <button class="gift-dialog-close"><i class="fas fa-times"></i></button>\n          </div>\n          <div class="gift-dialog-body">\n            <div class="gift-item-info">\n              <div class="gift-item-icon">\n                <i class="${this.getItemTypeIcon(t.type)}"></i>\n              </div>\n              <div class="gift-item-details">\n                <h4>${e}</h4>\n                <p>数量: ${t.quantity || 1}</p>\n              </div>\n            </div>\n            <div class="gift-recipient-selection">\n              <h4>选择接收者</h4>\n              <div class="gift-character-list">\n                ${s
                .map(([e, t]) => {
                  const a = n(t.nickname) || e,
                    s = this.dataManager.getCharacterAvatarUrl(e);
                  return `\n                    <div class="gift-character-option" data-character-id="${e}">\n                      <div class="gift-character-avatar">\n                        ${s ? `<img src="${s}" alt="${a}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=&quot;fas fa-user-circle&quot;></i>'" />` : '<i class="fas fa-user-circle"></i>'}\n                      </div>\n                      <div class="gift-character-info">\n                        <div class="gift-character-name">${a}</div>\n                        <div class="gift-character-relationship">${n(t.relationship_with_user) || '未知'}</div>\n                      </div>\n                    </div>\n                  `;
                })
                .join(
                  '',
                )}\n              </div>\n            </div>\n          </div>\n          <div class="gift-dialog-footer">\n            <button class="gift-confirm-btn primary-btn" disabled>确认赠送</button>\n            <button class="gift-cancel-btn secondary-btn">取消</button>\n          </div>\n        </div>\n      </div>\n    `;
              $('body').append(i);
              const o = $('#gift-dialog');
              let r = null;
              (o.find('.gift-character-option').on('click', function () {
                (o.find('.gift-character-option').removeClass('selected'),
                  $(this).addClass('selected'),
                  (r = $(this).data('character-id')),
                  o.find('.gift-confirm-btn').prop('disabled', !1));
              }),
                o.find('.gift-confirm-btn').on('click', () => {
                  r && (this.confirmGift(e, t, r), o.remove());
                }),
                o.find('.gift-cancel-btn, .gift-dialog-close').on('click', () => {
                  o.remove();
                }),
                o.on('click', e => {
                  e.target === o[0] && o.remove();
                }));
            }
            confirmGift(e, t, a) {
              const n = this.dataManager.getMvuData('角色')[a],
                s = ((i = n?.nickname), (Array.isArray(i) ? i[0] : i) || a);
              var i;
              const o = `{{user}}将"${e}"赠送给了${s}`;
              (this.commandManager.addCustomCommand(o),
                this.showSendFeedback(`已计划将"${e}"赠送给${s}`, !0),
                console.log(`🎁 添加赠送行动: ${e} -> ${s}`));
            }
            generateItemActionButtons(e, t) {
              const a = e.type?.toLowerCase() || '',
                n = e.isEquipped || !1;
              let s = '';
              !['消耗品', '药水', '食物'].some(e => a.includes(e.toLowerCase())) &&
                (s += n
                  ? `\n          <button class="item-action-btn unequip-btn" data-action="unequip" data-item-id="${t}" title="卸下物品">\n            <i class="fas fa-times-circle"></i>\n            <span>卸下</span>\n          </button>\n        `
                  : `\n          <button class="item-action-btn equip-btn" data-action="equip" data-item-id="${t}" title="装备物品">\n            <i class="fas fa-check-circle"></i>\n            <span>装备</span>\n          </button>\n        `);
              return (
                ['消耗品', '药水', '食物', '卷轴', '材料'].some(e => a.includes(e.toLowerCase())) &&
                  (s += `\n        <button class="item-action-btn use-btn" data-action="use" data-item-id="${t}" title="使用物品">\n          <i class="fas fa-magic"></i>\n          <span>使用</span>\n        </button>\n      `),
                (s += `\n      <button class="item-action-btn gift-btn" data-action="gift" data-item-id="${t}" title="赠送物品给其他角色">\n        <i class="fas fa-gift"></i>\n        <span>赠送</span>\n      </button>\n    `),
                (s += `\n      <button class="item-action-btn discard-btn" data-action="discard" data-item-id="${t}" title="丢弃物品">\n        <i class="fas fa-trash-alt"></i>\n        <span>丢弃</span>\n      </button>\n    `),
                s
              );
            }
            getItemTypeIcon(e) {
              const t = {
                饰品: 'fas fa-gem',
                服装: 'fas fa-tshirt',
                杂物: 'fas fa-box',
                武器: 'fas fa-gavel',
                防具: 'fas fa-shield-alt',
                道具: 'fas fa-magic',
                装备: 'fas fa-cog',
                消耗品: 'fas fa-pills',
                材料: 'fas fa-hammer',
                食物: 'fas fa-apple-alt',
                书籍: 'fas fa-book',
                钥匙: 'fas fa-key',
                货币: 'fas fa-coins',
                宝石: 'fas fa-diamond',
                药水: 'fas fa-flask',
                符文: 'fas fa-scroll',
                工具: 'fas fa-wrench',
                任务物品: 'fas fa-star',
                项链: 'fas fa-gem',
                戒指: 'fas fa-ring',
                袋子: 'fas fa-bag-shopping',
                背包: 'fas fa-bag-shopping',
                卫衣: 'fas fa-tshirt',
                衣服: 'fas fa-tshirt',
                衣物: 'fas fa-tshirt',
              };
              if (t[e]) return t[e];
              const a = e.toLowerCase();
              for (const [e, n] of Object.entries(t))
                if (a.includes(e.toLowerCase()) || e.toLowerCase().includes(a)) return n;
              return e.includes('武器') || e.includes('剑') || e.includes('刀') || e.includes('弓') || e.includes('枪')
                ? 'fas fa-gavel'
                : e.includes('防具') || e.includes('护甲') || e.includes('盔甲') || e.includes('甲')
                  ? 'fas fa-shield-alt'
                  : e.includes('饰品') || e.includes('戒指') || e.includes('项链') || e.includes('耳环')
                    ? 'fas fa-gem'
                    : e.includes('服装') || e.includes('衣') || e.includes('袍') || e.includes('裙')
                      ? 'fas fa-tshirt'
                      : e.includes('食物') || e.includes('食品') || e.includes('水果') || e.includes('肉')
                        ? 'fas fa-apple-alt'
                        : e.includes('药') || e.includes('药水') || e.includes('药剂')
                          ? 'fas fa-flask'
                          : e.includes('书') || e.includes('卷轴') || e.includes('文献')
                            ? 'fas fa-book'
                            : e.includes('工具') || e.includes('器具')
                              ? 'fas fa-wrench'
                              : e.includes('材料') || e.includes('原料')
                                ? 'fas fa-hammer'
                                : e.includes('宝石') || e.includes('珠宝')
                                  ? 'fas fa-diamond'
                                  : e.includes('钱') || e.includes('币') || e.includes('货币')
                                    ? 'fas fa-coins'
                                    : (console.warn(`未找到物品类型 "${e}" 的图标，使用默认图标`), 'fas fa-cube');
            }
            renderHummingbirdView() {
              console.log('🐦 开始渲染蜂鸟通讯界面...');
              const e = this.dataManager.getMvuData('角色');
              if (!e) return (console.warn('⚠️ 角色数据为空'), void this.renderEmptyHummingbirdView());
              this.initializeChatHistoryCache(e);
              const t = $('#contact-list');
              t.empty();
              const a = e => (Array.isArray(e) ? e[0] : e);
              (this.getSortedCharactersByActivity(e, a).forEach(({ characterId: e, character: n }) => {
                const s = a(n.nickname) || e,
                  i = a(n.relationship_with_user) || '朋友',
                  o = this.dataManager.getCharacterAvatarUrl(e) || '',
                  r = this.unreadMessages.has(e),
                  c = $(
                    `\n        <div class="contact-item" data-contact="${e}">\n          <div class="contact-avatar-container">\n            <img src="${o}" alt="${s}" class="contact-avatar" />\n            ${r ? '<div class="unread-indicator">+1</div>' : ''}\n          </div>\n            <div>\n            <div class="contact-name">${s}</div>\n            <div class="contact-status">${i}</div>\n            </div>\n          </div>\n        `,
                  );
                (c.find('.contact-avatar').on('error', function () {
                  (console.log(`📷 角色 ${s} 的头像加载失败，使用默认头像`),
                    $(this).attr(
                      'src',
                      'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNGNUY1RjUiLz4KPGNpcmNsZSBjeD0iMjAiIGN5PSIxNSIgcj0iNiIgZmlsbD0iIzk5OTk5OSIvPgo8cGF0aCBkPSJNOCAzMmMwLTYuNjI3IDUuMzczLTEyIDEyLTEyczEyIDUuMzczIDEyIDEyIiBmaWxsPSIjOTk5OTk5Ii8+Cjwvc3ZnPgo=',
                    ),
                    $(this).css({
                      'background-color': 'var(--ui-bg-secondary)',
                      border: '1px solid var(--ui-border-color)',
                    }));
                }),
                  c.on('click', () => {
                    (this.unreadMessages.delete(e), c.find('.unread-indicator').remove(), this.selectContact(e, n));
                  }),
                  c.on('mouseenter', t => {
                    this.showHummingbirdCharacterTooltip(t, e, n);
                  }),
                  c.on('mouseleave', () => {
                    this.hideHummingbirdCharacterTooltip();
                  }),
                  t.append(c));
              }),
                console.log('✅ 蜂鸟联系人列表渲染完成'));
            }
            showHummingbirdCharacterTooltip(e, t, a) {
              const n = $('#hummingbird-character-tooltip'),
                s = e => (Array.isArray(e) ? e[0] : e),
                i = s(a.fullName) || t,
                o = s(a.affiliation) || '所属不明',
                r = s(a.race) || '未知',
                c = s(a.rank) || '未知',
                l = s(a.relationship_with_user) || '陌生人',
                d = s(a.favorability) || 0,
                h = s(a.likes) || [],
                g = s(a.dislikes) || [];
              ($('#hb-character-fullname').text(i), $('#hb-character-affiliation').text(o));
              const u = $('#hb-status-tooltip-body');
              if (
                (u.empty(),
                r &&
                  u.append(
                    `\n        <div class="status-item">\n          <span class="status-label">种族</span>\n          <span class="status-value">${r}</span>\n        </div>\n      `,
                  ),
                c &&
                  u.append(
                    `\n        <div class="status-item">\n          <span class="status-label">位阶</span>\n          <span class="status-value">${c}</span>\n        </div>\n      `,
                  ),
                l &&
                  u.append(
                    `\n        <div class="status-item">\n          <span class="status-label">关系</span>\n          <span class="status-value relationship">${l}</span>\n        </div>\n      `,
                  ),
                void 0 !== d)
              ) {
                const e = Number(d) || 0,
                  t = Math.max(0, Math.min(100, e));
                u.append(
                  `\n        <div class="status-item">\n          <span class="status-label">好感度</span>\n          <div style="display: flex; align-items: baseline; gap: 8px;">\n            <div class="status-progress-bar">\n              <div class="progress-bar-fill" style="width: ${t}%;"></div>\n            </div>\n            <span class="status-value" style="min-width: 15px; text-align: right;">${e}</span>\n          </div>\n        </div>\n      `,
                );
              }
              const m = $('#hb-status-tooltip-footer');
              if ((m.empty(), h && Array.isArray(h) && h.length > 0)) {
                const e = h.filter(e => e && '$__META_EXTENSIBLE__$' !== e);
                if (e.length > 0) {
                  const t = e.map(e => `<span class="status-tag">${e}</span>`).join('');
                  m.append(
                    `\n          <div class="status-tags-container">\n            <span class="status-label">喜欢</span>\n            <div class="status-tags">${t}</div>\n          </div>\n        `,
                  );
                }
              }
              if (g && Array.isArray(g) && g.length > 0) {
                const e = g.filter(e => e && '$__META_EXTENSIBLE__$' !== e);
                if (e.length > 0) {
                  const t = e.map(e => `<span class="status-tag">${e}</span>`).join('');
                  m.append(
                    `\n          <div class="status-tags-container">\n            <span class="status-label">讨厌</span>\n            <div class="status-tags">${t}</div>\n          </div>\n        `,
                  );
                }
              }
              const p = $(e.currentTarget)[0].getBoundingClientRect(),
                v = $('#view-hummingbird')[0].getBoundingClientRect();
              n.addClass('active').css({
                left: 0,
                top: 0,
                transform: 'none',
              });
              const f = n[0].getBoundingClientRect(),
                y = f.width,
                b = f.height;
              let C = p.right - v.left + 10,
                w = p.top - v.top;
              const M = C + y + 10,
                I = v.width;
              M > I && ((C = p.left - v.left - y - 10), C < 10 && (C = I - y - 10));
              const k = w + b,
                S = v.height;
              (k > S - 20 && (w = Math.max(20, S - b - 20)),
                w < 20 && (w = 20),
                n.css({
                  left: `${C}px`,
                  top: `${w}px`,
                  transform: 'none',
                }),
                console.log(`💬 显示蜂鸟角色状态栏: ${i}`));
            }
            hideHummingbirdCharacterTooltip() {
              $('#hummingbird-character-tooltip').removeClass('active');
            }
            selectContact(e, t) {
              ($('.contact-item').removeClass('active'),
                $(`.contact-item[data-contact="${e}"]`).addClass('active'),
                (this.currentSelectedContact = {
                  contactId: e,
                  characterData: t,
                }),
                this.clearUnreadMessages(e, t),
                this.displayChatHistory(e, t),
                this.setupSendButton());
            }
            clearUnreadMessages(e, t) {
              (this.unreadMessages.delete(e), $(`.contact-item[data-contact="${e}"] .unread-badge`).remove());
              const a = ((n = t.chatHistory), (Array.isArray(n) ? n[0] : n) || []);
              var n;
              (this.chatHistoryCache.set(e, a.length),
                console.log(`🔄 已清零 ${e} 的未读计数，当前消息数：${a.length}`));
            }
            displayChatHistory(e, t) {
              console.log(`💬 显示与 ${e} 的聊天记录`);
              const a = $('#chat-messages');
              a.empty();
              const n = e => (Array.isArray(e) ? e[0] : e),
                s = (n(t.chatHistory) || []).filter(
                  e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.sender,
                );
              if (0 === s.length)
                return void a.html(
                  `\n        <div class="no-messages">\n          <div class="no-messages-icon">💌</div>\n          <h4>还没有聊天记录</h4>\n          <p>开始与${n(t.nickname) || e}的对话吧！</p>\n        </div>\n      `,
                );
              s.forEach(s => {
                const i = n(t.nickname) || e,
                  o = n(t.fullName) || '',
                  r = s.sender !== e && s.sender !== i && s.sender !== o,
                  c = $(
                    `\n        <div class="message ${r ? 'sent' : 'received'}">\n          ${s.content || s.text || ''}\n        </div>\n      `,
                  );
                a.append(c);
              });
              const i = a[0];
              (i && (i.scrollTop = i.scrollHeight), console.log(`✅ 聊天记录显示完成，共 ${s.length} 条消息`));
            }
            initializeChatHistoryCache(e) {
              Object.keys(e).forEach(t => {
                if ('$meta' === t || 'template' === t) return;
                const a = e[t];
                var n;
                const s = ((n = a.chatHistory), (Array.isArray(n) ? n[0] : n) || []).filter(
                  e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.sender,
                ).length;
                this.chatHistoryCache.set(t, s);
              });
            }
            getSortedCharactersByActivity(e, t) {
              return Object.keys(e)
                .filter(t => '$meta' !== t && 'template' !== t && e[t])
                .map(t => ({
                  characterId: t,
                  character: e[t],
                }))
                .sort((e, a) => {
                  const n = t(e.character.chatHistory) || [],
                    s = t(a.character.chatHistory) || [],
                    i = n.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.sender).length;
                  return (
                    s.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.sender).length - i
                  );
                });
            }
            checkForNewMessages() {
              if ('hummingbird' !== this.currentView) return;
              const e = this.dataManager.getMvuData('角色');
              if (!e) return;
              const t = e => (Array.isArray(e) ? e[0] : e);
              Object.keys(e).forEach(a => {
                if ('$meta' === a || 'template' === a) return;
                const n = e[a],
                  s = t(n.chatHistory) || [],
                  i = s.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.sender).length;
                if (i > (this.chatHistoryCache.get(a) || 0)) {
                  console.log(`🆕 检测到角色 ${a} 有新消息`);
                  const e = s[s.length - 1];
                  if (e && '{{user}}' !== e.sender) {
                    const s = t(n.nickname) || a,
                      i = t(n.fullName) || '';
                    (e.sender !== a && e.sender !== s && e.sender !== i) ||
                      (this.unreadMessages.add(a), this.updateUnreadIndicator(a));
                  }
                  this.chatHistoryCache.set(a, i);
                }
              });
            }
            updateUnreadIndicator(e) {
              const t = $(`.contact-item[data-contact="${e}"]`);
              if (0 === t.find('.unread-indicator').length) {
                (t.find('.contact-avatar-container').append('<div class="unread-indicator">+1</div>'),
                  setTimeout(() => {
                    t.find('.unread-indicator').addClass('pulse');
                  }, 100));
              }
            }
            renderEmptyHummingbirdView() {
              const e = $('#contact-list'),
                t = $('#chat-messages');
              (e.html(
                '\n      <div class="no-contacts">\n        <div class="no-contacts-icon">🐦</div>\n        <h4>暂无联系人</h4>\n        <p>还没有角色数据可用</p>\n      </div>\n    ',
              ),
                t.html(
                  '\n      <div class="no-messages">\n        <div class="no-messages-icon">💭</div>\n        <h4>选择联系人</h4>\n        <p>选择左侧的联系人开始对话</p>\n      </div>\n    ',
                ));
            }
            setupSendButton() {
              ($('.send-btn').off('click.hummingbird'),
                $('#message-input').off('keypress.hummingbird'),
                $('.send-btn').on('click.hummingbird', () => {
                  this.sendMessage();
                }),
                $('#message-input').on('keypress.hummingbird', e => {
                  13 === e.which && this.sendMessage();
                }));
            }
            sendMessage() {
              const e = $('#message-input'),
                t = e.val();
              if (!t.trim()) return void console.warn('消息内容不能为空');
              if (!this.currentSelectedContact) return void console.warn('请先选择一个联系人');
              const { contactId: a } = this.currentSelectedContact;
              (this.commandManager.addHummingbirdCommand(a, t),
                e.val(''),
                this.showSendFeedback('已添加到行动计划'),
                console.log(`📱 蜂鸟消息已添加到行动列表: ${a} - ${t.substring(0, 20)}...`));
            }
            showSendFeedback(e, t = !0) {
              const a = $('.send-btn'),
                n = a.html();
              (a.html(t ? '✓' : '✗'),
                a.css({
                  'background-color': t ? '#28a745' : '#dc3545',
                  color: 'white',
                  transform: 'scale(1.1)',
                }),
                console.log(`💬 ${e}`),
                setTimeout(() => {
                  (a.html(n),
                    a.css({
                      'background-color': '',
                      color: '',
                      transform: '',
                    }));
                }, 2e3));
            }
            renderQuestsView() {
              (console.log('🎯 开始渲染任务界面...'),
                this.setupQuestTabs(),
                this.showMainQuests(),
                console.log('✅ 任务界面渲染完成'));
            }
            setupQuestTabs() {
              ($('.quest-tabs .tab-btn').off('click.quest-tabs'),
                $('.quest-tabs .tab-btn').on('click.quest-tabs', e => {
                  const t = $(e.currentTarget),
                    a = t.data('tab');
                  switch (($('.quest-tabs .tab-btn').removeClass('active'), t.addClass('active'), a)) {
                    case 'main':
                      this.showMainQuests();
                      break;
                    case 'side':
                      this.showSideQuests();
                      break;
                    case 'achievements':
                      this.showAchievements();
                  }
                  console.log(`切换到标签页: ${a}`);
                }));
            }
            showMainQuests() {
              const e = this.dataManager.getMvuData('世界状态');
              if (!e) return (console.warn('⚠️ 世界状态数据为空'), void this.renderEmptyQuestsView());
              const t = ((a = e.主线任务), Array.isArray(a) ? a[0] : a);
              var a;
              if (!t || !Array.isArray(t))
                return (console.warn('⚠️ 主线任务数据格式不正确'), void this.renderEmptyQuestsView());
              const n = t.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.名称);
              if (0 === n.length) return (console.warn('⚠️ 没有可显示的任务'), void this.renderEmptyQuestsView());
              const s = [...n].reverse();
              (this.renderQuestsList(s), this.renderActionSuggestions());
            }
            showSideQuests() {
              const e = $('#quest-list'),
                t = $('#quest-details');
              (e.html(
                '\n      <div class="empty-state">\n        <i class="fas fa-map-signs"></i>\n        <h3>支线任务</h3>\n        <p>暂无支线任务</p>\n      </div>\n    ',
              ),
                t.html(
                  '\n      <div class="no-suggestions">\n        <h4>支线探索</h4>\n        <p>支线任务功能开发中...</p>\n      </div>\n    ',
                ));
            }
            showAchievements() {
              const e = this.dataManager.getMvuData('世界状态'),
                t = ((a = e?.已解锁成就), Array.isArray(a) ? a[0] : a);
              var a;
              const n = $('#quest-list'),
                s = $('#quest-details');
              if (t && Array.isArray(t) && 0 !== t.length) {
                const e = t.filter(e => e && '$__META_EXTENSIBLE__$' !== e).reverse();
                (n.empty(),
                  e.forEach((e, t) => {
                    const a = $(
                      `\n          <div class="quest-item achievement-item" data-achievement-index="${t}">\n            <div class="quest-header">\n              <div class="quest-title">${e}</div>\n              <div class="quest-status quest-status-completed">\n                已获得\n              </div>\n            </div>\n          </div>\n        `,
                    );
                    (a.on('click', () => {
                      this.showAchievementDetails(e, t);
                    }),
                      n.append(a));
                  }),
                  e.length > 0 && this.showAchievementDetails(e[0], 0));
              } else
                n.html(
                  '\n        <div class="empty-state">\n          <i class="fas fa-trophy"></i>\n          <h3>暂无成就</h3>\n          <p>还没有解锁任何成就</p>\n        </div>\n      ',
                );
              s.html(
                '\n      <div class="no-suggestions">\n        <h4>解锁成就</h4>\n        <p>选择左侧成就查看详情</p>\n      </div>\n    ',
              );
            }
            showAchievementDetails(e, t) {
              ($('.quest-item').removeClass('selected'),
                $(`.quest-item[data-achievement-index="${t}"]`).addClass('selected'));
              $('#quest-details').html(
                `\n      <div class="action-suggestions-header">\n        <h3>${e}</h3>\n        <div class="suggestions-subtitle">成就已解锁</div>\n      </div>\n      <div class="action-suggestions-list">\n        <div class="action-suggestion-item">\n          <div class="suggestion-text">\n            恭喜您解锁了这个重要的里程碑！每个成就都代表着您在异世界冒险中的特殊经历。\n          </div>\n        </div>\n      </div>\n    `,
              );
            }
            renderQuestsList(e) {
              const t = $('#quest-list');
              (t.empty(),
                e.forEach((e, a) => {
                  const n = 0 === a,
                    s = n ? '进行中' : '已完成',
                    i = n ? 'quest-status-current' : 'quest-status-completed',
                    o = $(
                      `\n        <div class="quest-item ${n ? 'quest-current' : 'quest-completed'}" data-quest-index="${a}">\n          <div class="quest-header">\n            <div class="quest-title">${e.名称 || '未命名任务'}</div>\n            <div class="quest-status ${i}">\n              ${s}\n            </div>\n          </div>\n          <div class="quest-description">${e.详情 || '暂无详情'}</div>\n        </div>\n      `,
                    );
                  (o.on('click', () => {
                    ($('.quest-item').removeClass('selected'),
                      $(`.quest-item[data-quest-index="${a}"]`).addClass('selected'));
                  }),
                    t.append(o));
                }),
                e.length > 0 &&
                  ($('.quest-item').removeClass('selected'),
                  $('.quest-item[data-quest-index="0"]').addClass('selected')));
            }
            renderActionSuggestions() {
              const e = this.dataManager.getMvuData('世界状态'),
                t = $('#quest-details');
              if (!e)
                return void t.html(
                  '\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ',
                );
              const a = e?.行动建议;
              if (!a)
                return void t.html(
                  '\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ',
                );
              const n = ((s = a), Array.isArray(s) ? s[0] : s);
              var s;
              if (!n || !Array.isArray(n) || 0 === n.length)
                return void t.html(
                  '\n        <div class="no-suggestions">\n\n          <h4>暂无行动建议</h4>\n          <p>当前没有可用的行动建议</p>\n        </div>\n      ',
                );
              const i = n
                .map(
                  (e, t) =>
                    `\n        <div class="action-suggestion-item" data-suggestion-index="${t}">\n          <div class="suggestion-text">${e}</div>\n        </div>\n      `,
                )
                .join('');
              (t.html(
                `\n      <div class="action-suggestions-header">\n        <h3>行动建议</h3>\n        <div class="suggestions-subtitle">根据当前情况为您推荐的行动方案</div>\n      </div>\n      <div class="action-suggestions-list">\n        ${i}\n      </div>\n    `,
              ),
                $('.action-suggestion-item').on('click', function () {
                  const e = $(this).find('.suggestion-text').text(),
                    t = $(this).data('suggestion-index');
                  (console.log(`点击了行动建议 ${t + 1}:`, e),
                    $(this).addClass('clicked'),
                    setTimeout(() => {
                      $(this).removeClass('clicked');
                    }, 200));
                }));
            }
            renderEmptyQuestsView() {
              const e = $('#quest-list'),
                t = $('#quest-details');
              (e.html(
                '\n      <div class="empty-state">\n        <i class="fas fa-tasks"></i>\n        <h3>暂无任务</h3>\n        <p>目前没有可显示的任务记录</p>\n      </div>\n    ',
              ),
                t.html(
                  '\n      <div class="no-quest-selected">\n        <i class="fas fa-info-circle"></i>\n        <p>选择左侧任务查看详情</p>\n      </div>\n    ',
                ));
            }
            updateUI() {
              switch ((this.updateGameInfo(), this.updateCharacterDisplay(), this.updateDialogue(), this.currentView)) {
                case 'status':
                  this.renderStatusView();
                  break;
                case 'hummingbird':
                  this.renderHummingbirdView();
                  break;
                case 'map':
                  this.renderMapData();
                  break;
                case 'quests':
                  this.renderQuestsView();
                  break;
                case 'newspaper':
                  this.renderNewspaperContent();
              }
            }
            renderPendingCommandsView() {
              console.log('📋 开始渲染行动计划界面...');
              const e = this.commandManager.getPendingCommands();
              this.renderPendingCommandsUI(e);
            }
            renderPendingCommandsUI(e) {
              const t = $('#pending-commands-list'),
                a = $('#commands-count'),
                n = $('#send-all-commands'),
                s = $('#clear-all-commands');
              if ((a.text(e.length), t.empty(), 0 === e.length))
                return (
                  t.html(
                    '\n        <div class="no-commands">\n          <div class="no-commands-icon">📝</div>\n          <h4>暂无行动计划</h4>\n          <p>开始制定你的行动吧！</p>\n        </div>\n      ',
                  ),
                  n.prop('disabled', !0),
                  void s.prop('disabled', !0)
                );
              (e.forEach(e => {
                const a = this.getCommandTypeIcon(e.type),
                  n = this.getCommandTypeLabel(e.type),
                  s = new Date(e.timestamp).toLocaleTimeString(),
                  i = $(
                    `\n        <div class="command-item" data-command-id="${e.id}">\n          <div class="command-header">\n            <div class="command-type">\n              <i class="${a}"></i>\n              <span class="type-label">${n}</span>\n            </div>\n            <div class="command-time">${s}</div>\n            <button class="remove-command-btn" data-command-id="${e.id}">\n              <i class="fas fa-times"></i>\n            </button>\n          </div>\n          <div class="command-content">${this.escapeHtml(e.content)}</div>\n          ${e.metadata?.targetLocation ? `\n            <div class="command-meta">\n              <i class="fas fa-map-marker-alt"></i>\n              目标地点: ${e.metadata.targetLocation}\n            </div>\n          ` : ''}\n          ${e.metadata?.characterId ? `\n            <div class="command-meta">\n              <i class="fas fa-user"></i>\n              目标角色: ${e.metadata.characterId}\n            </div>\n          ` : ''}\n        </div>\n      `,
                  );
                t.append(i);
              }),
                n.prop('disabled', !1),
                s.prop('disabled', !1),
                t.off('click.removeCommand').on('click.removeCommand', '.remove-command-btn', e => {
                  const t = $(e.currentTarget).data('command-id');
                  this.commandManager.removeCommand(t);
                }),
                n.off('click.sendCommands').on('click.sendCommands', () => {
                  this.commandManager.sendAllCommands();
                }),
                s.off('click.clearCommands').on('click.clearCommands', () => {
                  this.commandManager.clearAllCommands();
                }),
                console.log(`✅ 行动计划界面渲染完成，共 ${e.length} 个行动`));
            }
            getCommandTypeIcon(e) {
              switch (e) {
                case 'travel':
                  return 'fas fa-map-marker-alt';
                case 'choice':
                  return 'fas fa-comment-dots';
                case 'message':
                  return 'fas fa-envelope';
                case 'custom':
                  return 'fas fa-code';
                default:
                  return 'fas fa-question';
              }
            }
            getCommandTypeLabel(e) {
              switch (e) {
                case 'travel':
                  return '前往';
                case 'choice':
                  return '选择';
                case 'message':
                  return '消息';
                case 'custom':
                  return '自定义';
                default:
                  return '未知';
              }
            }
            escapeHtml(e) {
              const t = document.createElement('div');
              return ((t.textContent = e), t.innerHTML);
            }
            destroy() {
              ($('.map-point').off(),
                $('.contact-item').off(),
                $('#hover-info-bar').off(),
                $('#hover-info-bar .hover-info-expanded').off(),
                console.log('UI控制器已销毁'));
            }
            updateHoverInfoBar() {
              try {
                (this.updateBGMInfo(), this.updateCurrentQuestInfo(), this.updateActionSuggestionsInfo());
              } catch (e) {
                console.error('更新悬浮信息条失败:', e);
              }
            }
            updateBGMInfo() {
              try {
                const { getAppInstances: e } = a(387),
                  t = e(),
                  n = t?.llmrpParser?.getCurrentBGM?.(),
                  s = $('#bgm-status'),
                  i = $('#current-bgm-name');
                n
                  ? (n.length > 8
                      ? s
                          .addClass('marquee')
                          .html(
                            `\n            <div class="marquee-content">\n              <span>${n}</span><span>${n}</span>\n            </div>\n          `,
                          )
                      : s.removeClass('marquee').text(n),
                    n.length > 20
                      ? i
                          .addClass('marquee')
                          .html(
                            `\n            <div class="marquee-content">\n              <span>${n}</span><span>${n}</span>\n            </div>\n          `,
                          )
                      : i.removeClass('marquee').text(n))
                  : (s.removeClass('marquee').text('无'), i.removeClass('marquee').text('暂无音乐'));
              } catch (e) {
                (console.warn('更新BGM信息失败:', e),
                  $('#bgm-status').removeClass('marquee').text('无'),
                  $('#current-bgm-name').removeClass('marquee').text('暂无音乐'));
              }
            }
            updateCurrentQuestInfo() {
              try {
                const e = this.dataManager.getMvuData('世界状态');
                if (!e) return void $('#current-quest-mini').html('<div class="no-quest-mini">暂无任务</div>');
                const t = (e => (Array.isArray(e) ? e[0] : e))(e.主线任务);
                if (!t || !Array.isArray(t))
                  return void $('#current-quest-mini').html('<div class="no-quest-mini">暂无任务</div>');
                const a = t.filter(e => e && 'object' == typeof e && '$__META_EXTENSIBLE__$' !== e && e.名称);
                if (0 === a.length)
                  return void $('#current-quest-mini').html('<div class="no-quest-mini">暂无任务</div>');
                const n = a[a.length - 1],
                  s = $('#current-quest-mini');
                (s.empty(),
                  s.append(
                    `\n        <div class="quest-title-mini">${n.名称 || '未命名任务'}</div>\n        <div class="quest-details-mini">${n.详情 || '暂无详情'}</div>\n      `,
                  ));
              } catch (e) {
                (console.warn('更新当前任务信息失败:', e),
                  $('#current-quest-mini').html('<div class="no-quest-mini">暂无任务</div>'));
              }
            }
            updateActionSuggestionsInfo() {
              try {
                const e = this.dataManager.getMvuData('世界状态'),
                  t = e => (Array.isArray(e) ? e[0] : e);
                let a = [];
                if (e?.行动建议) {
                  const n = t(e.行动建议);
                  Array.isArray(n) && (a = n);
                }
                $('#suggestions-count').text(a.length.toString());
                const n = $('#action-suggestions-mini');
                (n.empty(),
                  0 === a.length
                    ? n.append('<div class="no-suggestions-mini">暂无建议</div>')
                    : (a.slice(0, 5).forEach((e, t) => {
                        const a = $(
                          `<div class="suggestion-item-mini" data-suggestion="${e}">\n            ${e}\n          </div>`,
                        );
                        (a.on('click', () => {
                          (this.commandManager.addChoiceCommand(e), console.log('行动建议已添加到计划:', e));
                        }),
                          n.append(a));
                      }),
                      a.length > 5 &&
                        n.append(`<div class="no-suggestions-mini">... 还有 ${a.length - 5} 条建议</div>`)));
              } catch (e) {
                (console.warn('更新行动建议信息失败:', e),
                  $('#suggestions-count').text('0'),
                  $('#action-suggestions-mini').html('<div class="no-suggestions-mini">暂无建议</div>'));
              }
            }
            setupHoverInfoBarEvents() {
              let e = null,
                t = null,
                a = null,
                n = !1;
              const s = $('#hover-info-bar');
              (s.on('mouseenter', () => {
                ((n = !0),
                  s.addClass('show-trigger'),
                  t && (clearTimeout(t), (t = null)),
                  a && (clearTimeout(a), (a = null)),
                  (e = setTimeout(() => {
                    n && s.addClass('show-expanded');
                  }, 400)));
              }),
                s.on('mouseleave', () => {
                  ((n = !1),
                    e && (clearTimeout(e), (e = null)),
                    (t = setTimeout(() => {
                      n || s.removeClass('show-expanded');
                    }, 300)),
                    (a = setTimeout(() => {
                      n || s.removeClass('show-trigger');
                    }, 300)));
                }),
                s.find('.hover-info-expanded').on('mouseenter', () => {
                  ((n = !0),
                    t && (clearTimeout(t), (t = null)),
                    a && (clearTimeout(a), (a = null)),
                    s.addClass('show-trigger show-expanded'));
                }),
                s.find('.hover-info-expanded').on('mouseleave', () => {
                  ((n = !1),
                    (t = setTimeout(() => {
                      n || s.removeClass('show-expanded show-trigger');
                    }, 100)));
                }));
            }
          }
          function m(e) {
            return new Promise(t => setTimeout(t, e));
          }
          let p = null,
            v = null,
            f = null,
            y = null,
            b = null;
          async function C() {
            try {
              (console.log('异世界和平界面开始加载...'),
                (function () {
                  try {
                    let e = localStorage.getItem('iswp_theme');
                    if (!e) {
                      const t = document.cookie.match(/(?:^|; )iswp_theme=([^;]+)/);
                      e = t ? decodeURIComponent(t[1]) : '';
                    }
                    (e || (e = 'dark'),
                      $('body').attr('data-theme', e),
                      $('.theme-btn').removeClass('active'),
                      $(`.theme-btn[data-theme="${e}"]`).addClass('active'));
                  } catch (e) {
                    ($('body').attr('data-theme', 'dark'),
                      $('.theme-btn').removeClass('active'),
                      $('.theme-btn[data-theme="dark"]').addClass('active'));
                  }
                })(),
                (p = new c()),
                await p.initialize(),
                (v = new u(p)),
                v.initialize(),
                (window.enableBreathing = M),
                (window.disableBreathing = I),
                (f = new r(p, v)),
                f.initialize());
              try {
                const e = localStorage.getItem('iswp_hover_bar_position') || 'top-right',
                  t = $('#hover-info-bar');
                (t.removeClass('position-top-left position-top-right position-hidden'), t.addClass(`position-${e}`));
              } catch (e) {
                console.warn('Could not apply saved hover bar position', e);
              }
              ((y = new h(p, v)),
                y.initialize(),
                f.setLLMRPParser(y),
                (b = new n(p, v)),
                b.initialize(),
                (function () {
                  let e = null,
                    t = null;
                  const a = setInterval(() => {
                    if (p && v && y)
                      try {
                        if ('undefined' == typeof getCurrentMessageId || 'undefined' == typeof getChatMessages) return;
                        const a = getCurrentMessageId(),
                          n = getChatMessages(a)[0];
                        if (n && n.message) {
                          const s = n.message || '';
                          if (a === e && s === t) return;
                          (v &&
                            s.includes('<UpdateVariable>') &&
                            (async function (e, t) {
                              try {
                                const a = e.match(/<UpdateVariable>([\s\S]*?)<\/UpdateVariable>/);
                                if (!a) return;
                                const n = a[1];
                                console.log('🔍 Parsing <UpdateVariable> block for notifications...');
                                const s = [],
                                  i = /_\.add\s*\(\s*'([^']*)'\s*,\s*([-\d\.]+)\s*\)/g;
                                let o;
                                for (; null !== (o = i.exec(n)); ) {
                                  const e = o[1],
                                    t = parseFloat(o[2]);
                                  if (!isNaN(t) && 0 !== t)
                                    if (e.includes('玩家状态.货币.里拉(R)'))
                                      s.push({
                                        type: 'money',
                                        label: '里拉',
                                        delta: t,
                                      });
                                    else if (e.includes('玩家状态.货币.白金币'))
                                      s.push({
                                        type: 'platinum',
                                        label: '白金币',
                                        delta: t,
                                      });
                                    else if (e.includes('.favorability[0]')) {
                                      const a = e.match(/角色\.([^.]*)\.favorability/);
                                      if (a && a[1]) {
                                        const e = a[1];
                                        s.push({
                                          type: 'favor',
                                          label: `${e} 好感度`,
                                          delta: t,
                                        });
                                      }
                                    }
                                }
                                const r = /_\.assign\s*\(\s*'玩家状态\.物品栏'\s*,\s*'([^']*)'[^)]*\)/g;
                                for (; null !== (o = r.exec(n)); ) {
                                  const e = o[1];
                                  s.push({
                                    type: 'item',
                                    label: e,
                                    delta: 1,
                                  });
                                }
                                for (const e of s)
                                  (t.showStatToast(e), console.log(`✨ Notify: ${e.label} ${e.delta}`), await m(400));
                              } catch (e) {
                                console.error('❌ Error parsing <UpdateVariable> for notifications:', e);
                              }
                            })(s, v),
                            s.includes('<game_response>') &&
                              (console.log('🎮 检测到新的LLMRP消息，开始解析...'),
                              console.log('📝 消息ID:', a, '上次ID:', e),
                              console.log('📝 消息内容:', s),
                              (e = a),
                              (t = s),
                              (async () => {
                                try {
                                  (await y.parseAndExecute(s), console.log('✅ LLMRP消息解析完成:', a));
                                } catch (a) {
                                  (console.error('❌ LLMRP解析出错:', a), (e = null), (t = null));
                                }
                              })()));
                          const i = p.parseGameCommand(n.message);
                          i && (p.executeGameCommand(i), v.updateUI());
                        }
                      } catch (e) {}
                    else clearInterval(a);
                  }, 1e3);
                  window.gameMessageInterval = a;
                })(),
                console.log('异世界和平界面加载完成'),
                s.showStatus());
            } catch (t) {
              (console.error('异世界和平界面加载失败:', t),
                (e = '界面加载失败，请刷新页面重试'),
                'undefined' != typeof toastr
                  ? toastr.error(e, '错误', {
                      timeOut: 5e3,
                      positionClass: 'toast-top-right',
                    })
                  : console.error(e));
            }
            var e;
          }
          function w() {
            try {
              (console.log('异世界和平界面开始卸载...'),
                b && (b.destroy(), (b = null)),
                y && (y.cleanup(), y.destroy().catch(console.error), (y = null)),
                f && (f.destroy(), (f = null)),
                v && (v.destroy(), (v = null)),
                p && (p.destroy(), (p = null)),
                (function () {
                  window.gameMessageInterval &&
                    (clearInterval(window.gameMessageInterval), delete window.gameMessageInterval);
                  (D(), $(window).off('pagehide.gameApp'), $(document).off('click.gameApp'));
                })(),
                console.log('异世界和平界面卸载完成'));
            } catch (e) {
              console.error('异世界和平界面卸载时出错:', e);
            }
          }
          function M() {
            (!(function () {
              try {
                (console.log('🫁 开始启用角色立绘呼吸效果...'),
                  A(),
                  (function () {
                    if ('undefined' == typeof MutationObserver)
                      return void console.warn('⚠️ 浏览器不支持MutationObserver，无法自动为新增角色添加呼吸效果');
                    const e = new MutationObserver(e => {
                      let t = !1;
                      (e.forEach(e => {
                        e.addedNodes.forEach(e => {
                          if (e.nodeType === Node.ELEMENT_NODE) {
                            const a = e;
                            a.classList &&
                              a.classList.contains('character-sprite') &&
                              a.classList.contains('dynamic') &&
                              (t = !0);
                            $(a).find('.character-sprite.dynamic').length > 0 && (t = !0);
                          }
                        });
                      }),
                        t &&
                          setTimeout(() => {
                            (function () {
                              try {
                                const e = localStorage.getItem('iswp_breathing');
                                if (null !== e) return 'true' === e;
                                const t = document.cookie.match(/(?:^|; )iswp_breathing=([^;]+)/);
                                if (t) return 'true' === t[1];
                              } catch (e) {
                                console.warn('无法读取呼吸效果设置，使用默认值', e);
                              }
                              return !0;
                            })() && A();
                          }, 100));
                    });
                    (e.observe(document.body, {
                      childList: !0,
                      subtree: !0,
                    }),
                      (window.characterBreathingObserver = e),
                      console.log('👀 已设置角色立绘观察器，将自动为新增角色添加呼吸效果'));
                  })(),
                  console.log('✅ 角色立绘呼吸效果已启用'));
              } catch (e) {
                console.error('❌ 启用角色立绘呼吸效果失败:', e);
              }
            })(),
              console.log('✅ 已启用角色立绘呼吸效果'));
          }
          function I() {
            ($('.character-sprite.dynamic').removeClass(
              'breathing-natural breathing-sway breathing-pulse breathing-rhythmic',
            ),
              D(),
              console.log('🚫 已禁用所有角色立绘呼吸效果'));
          }
          function k() {
            return {
              gameDataManager: p,
              uiController: v,
              eventHandler: f,
              llmrpParser: y,
              dataBindingManager: b,
            };
          }
          function S() {
            v && v.updateUI();
          }
          function x() {
            p && console.log('游戏状态已保存');
          }
          function A() {
            const e = $('.character-sprite.dynamic');
            (console.log(`🎭 找到 ${e.length} 个角色立绘`),
              e.each(function () {
                const e = $(this);
                e.hasClass('breathing-natural') ||
                  (e.addClass('breathing-natural'),
                  console.log('🫁 已为角色立绘添加自然真实呼吸效果:', e.attr('class')));
              }));
          }
          function D() {
            window.characterBreathingObserver &&
              (window.characterBreathingObserver.disconnect(),
              delete window.characterBreathingObserver,
              console.log('🧹 已清理角色立绘呼吸效果观察器'));
          }
        },
      },
      t = {};
    function a(n) {
      var s = t[n];
      if (void 0 !== s) return s.exports;
      var i = (t[n] = {
        exports: {},
      });
      return (e[n](i, i.exports, a), i.exports);
    }
    ((a.n = e => {
      var t = e && e.__esModule ? () => e.default : () => e;
      return (
        a.d(t, {
          a: t,
        }),
        t
      );
    }),
      (a.d = (e, t) => {
        for (var n in t)
          a.o(t, n) &&
            !a.o(e, n) &&
            Object.defineProperty(e, n, {
              enumerable: !0,
              get: t[n],
            });
      }),
      (a.o = (e, t) => Object.prototype.hasOwnProperty.call(e, t)),
      (a.r = e => {
        ('undefined' != typeof Symbol &&
          Symbol.toStringTag &&
          Object.defineProperty(e, Symbol.toStringTag, {
            value: 'Module',
          }),
          Object.defineProperty(e, '__esModule', {
            value: !0,
          }));
      }));
    var n = a(387);
    ($(() => {
      (0, n.onLoad)();
    }),
      $(window).on('pagehide', () => {
        (0, n.onUnload)();
      }));
  </script>
  <style>
    :root {
      --bg-gradient: #6262629e;
      --text-color: #f5f5f7;
      --primary-color: #0a84ff;
      --primary-color-light: rgba(10, 132, 255, 0.2);
      --primary-color-lighter: rgba(10, 132, 255, 0.3);
      --ui-bg: rgba(29, 29, 31, 0.7);
      --ui-bg-heavy: rgba(29, 29, 31, 0.85);
      --ui-border-color: rgba(255, 255, 255, 0.1);
      --shadow-color-light: rgba(0, 0, 0, 0.2);
      --shadow-color-medium: rgba(0, 0, 0, 0.3);
      --blur-intensity: 20px;
      --gold-color: #ffd700;
    }

    [data-theme='light'] {
      --bg-gradient: #6262629e;
      --text-color: #1d1d1f;
      --primary-color: #007aff;
      --primary-color-light: rgba(0, 122, 255, 0.1);
      --primary-color-lighter: rgba(0, 122, 255, 0.2);
      --ui-bg: rgba(255, 255, 255, 0.8);
      --ui-bg-heavy: rgba(255, 255, 255, 0.95);
      --ui-border-color: rgba(0, 0, 0, 0.1);
      --shadow-color-light: rgba(0, 0, 0, 0.1);
      --shadow-color-medium: rgba(0, 0, 0, 0.15);
      --blur-intensity: 20px;
      --gold-color: #d4af37;
    }

    [data-theme='light'] * {
      color: var(--text-color) !important;
    }

    [data-theme='dark'] {
      --bg-gradient: #6262629e;
      --text-color: #f5f5f7;
      --primary-color: #0a84ff;
      --primary-color-light: rgba(10, 132, 255, 0.2);
      --primary-color-lighter: rgba(10, 132, 255, 0.3);
      --ui-bg: rgba(29, 29, 31, 0.7);
      --ui-bg-heavy: rgba(29, 29, 31, 0.85);
      --ui-border-color: rgba(255, 255, 255, 0.1);
      --shadow-color-light: rgba(0, 0, 0, 0.2);
      --shadow-color-medium: rgba(0, 0, 0, 0.3);
      --blur-intensity: 20px;
      --gold-color: #ffd700;
    }

    [data-theme='glass'] {
      --bg-gradient: #6262629e;
      --text-color: #1d1d1f;
      --primary-color: #007aff;
      --primary-color-light: rgba(0, 122, 255, 0.1);
      --primary-color-lighter: rgba(0, 122, 255, 0.2);
      --ui-bg: rgba(255, 255, 255, 0.3);
      --ui-bg-heavy: rgba(255, 255, 255, 0.4);
      --ui-border-color: rgba(0, 0, 0, 0.1);
      --shadow-color-light: rgba(0, 0, 0, 0.1);
      --shadow-color-medium: rgba(0, 0, 0, 0.15);
      --blur-intensity: 30px;
      --gold-color: #d4af37;
    }

    [data-theme='glass'] * {
      color: var(--text-color) !important;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      overflow: hidden;
      width: 100%;
      aspect-ratio: 16/9;
      transition:
        background 0.5s ease,
        color 0.5s ease;
    }

    body[data-theme='dark'] {
      --bg-gradient: #6262629e;
      --text-color: #f5f5f7;
      --primary-color: #0a84ff;
      --primary-color-light: rgba(10, 132, 255, 0.2);
      --primary-color-lighter: rgba(10, 132, 255, 0.3);
      --ui-bg: rgba(29, 29, 31, 0.7);
      --ui-bg-heavy: rgba(29, 29, 31, 0.85);
      --ui-border-color: rgba(255, 255, 255, 0.1);
      --shadow-color-light: rgba(0, 0, 0, 0.2);
      --shadow-color-medium: rgba(0, 0, 0, 0.3);
      --gold-color: #ffd700;
    }

    body[data-theme='glass'] {
      --ui-bg: rgba(255, 255, 255, 0.3);
      --ui-bg-heavy: rgba(255, 255, 255, 0.4);
      --blur-intensity: 30px;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      position: relative;
    }

    #app-container.modal-active > #content-area {
      filter: blur(4px);
      transform: scale(0.98);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .top-header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      width: 100%;
      gap: 20px;
      pointer-events: auto;
    }

    #main-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      padding: 4px;
      margin: 0;
      background: var(--ui-bg);
      border: 1px solid rgba(0, 0, 0, 0);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px var(--shadow-color-light);
    }

    .nav-btn:hover {
      background: var(--primary-color-light);
      border-color: var(--primary-color-lighter);
    }

    .nav-btn.active {
      background: var(--primary-color);
    }

    .nav-icon {
      width: 32px;
      height: 32px;
      background: rgba(0, 0, 0, 0);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: none;
      transition: all 0.4s ease;
    }

    .nav-icon i {
      font-size: 16px;
      color: var(--text-color);
      transition: color 0.5s ease;
    }

    .nav-btn.active .nav-icon i {
      color: #fff;
    }

    .nav-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
      white-space: nowrap;
      max-width: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      margin-left: 0;
    }

    .nav-btn:hover .nav-text,
    .nav-btn.active .nav-text {
      max-width: 60px;
      opacity: 1;
      margin-left: 8px;
      margin-right: 8px;
    }

    .nav-btn.active .nav-text {
      color: #fff;
    }

    .nav-btn.disabled,
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .nav-btn.disabled:hover,
    .nav-btn:disabled:hover {
      background: var(--ui-bg);
      border-color: var(--ui-border-color);
    }

    .nav-btn.disabled .nav-text,
    .nav-btn:disabled .nav-text {
      max-width: 0;
      opacity: 0;
      margin-left: 0;
      margin-right: 0;
    }

    .nav-btn.active {
      background: var(--primary-color);
    }

    .nav-btn.active .nav-icon i {
      color: #fff;
    }

    .nav-btn.active .nav-text {
      color: #fff;
    }

    .nav-btn:hover .nav-text,
    .nav-btn.active .nav-text {
      max-width: 60px;
      opacity: 1;
      margin-left: 8px;
      margin-right: 8px;
    }

    @media (max-width: 768px) {
      .nav-text {
        display: none;
      }

      .nav-icon {
        margin-right: 0;
      }

      .nav-btn {
        min-width: 36px;
        height: 36px;
        padding: 2px;
      }
    }

    #content-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .modal-view-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.4s,
        visibility 0.4s;
      background-color: rgba(0, 0, 0, 0.3);
    }

    .modal-view-container.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      width: 90%;
      max-width: 1200px;
      height: 85%;
      max-height: 800px;
      background: var(--ui-bg-heavy);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      border-radius: 24px;
      box-shadow: 0 16px 64px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      transform: scale(0.95);
      transition:
        transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
        background-color 0.5s ease,
        border-color 0.5s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .modal-view-container.active .modal-content {
      transform: scale(1);
    }

    .modal-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      color: var(--text-color);
      cursor: pointer;
      font-size: 16px;
      z-index: 110;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
    }

    .modal-close-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: rotate(90deg);
    }

    .view-container {
      width: 100%;
      height: 100%;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.4s,
        visibility 0.4s;
      position: absolute;
      top: 0;
      left: 0;
    }

    .view-container.active {
      opacity: 1;
      visibility: visible;
    }

    #view-novel.view-container {
      padding: 0;
      position: static;
      display: flex;
      flex-direction: column;
    }

    .modal-content .view-container {
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--ui-border-color);
      flex-shrink: 0;
    }

    .modal-header h2 {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 0;
    }

    #view-quests .modal-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 8px;
    }

    .modal-body {
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #view-newspaper .modal-body {
      overflow: hidden;
      position: relative;
    }

    .floating-update-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: hsla(0, 0%, 100%, 0.9);
      color: #333;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .floating-update-btn:hover {
      background: #fff;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }

    .floating-update-btn:hover i {
      transform: rotate(90deg);
    }

    .floating-update-btn:active {
      transform: scale(0.95);
    }

    .floating-update-btn i {
      transition: transform 0.3s ease;
    }

    .character-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 50px;
    }

    .cg-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 4;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.3s ease,
        visibility 0.3s ease;
      pointer-events: none;
    }

    .cg-layer .cg-image {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.85);
      max-width: min(92%, 1200px);
      max-height: 82%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 20px;
      background: var(--ui-bg-heavy);
      border: 1px solid var(--ui-border-color);
      box-shadow: 0 2px 8px var(--shadow-color-light);
      filter: blur(8px);
      transition:
        transform 600ms cubic-bezier(0.25, 0.46, 0.45, 0.94),
        filter 400ms ease-out,
        box-shadow 200ms ease;
      pointer-events: auto;
      cursor: pointer;
      will-change: transform, filter;
    }

    .cg-layer .cg-image:hover {
      box-shadow: 0 4px 16px var(--shadow-color-light);
      filter: brightness(105%);
      transform: translate(-50%, -50%) scale(0.87);
    }

    .cg-layer .cg-image:active {
      transform: translate(-50%, -50%) scale(0.83);
    }

    .cg-layer.active {
      opacity: 1;
      visibility: visible;
    }

    .cg-layer.active .cg-image {
      transform: translate(-50%, -50%) scale(1);
      filter: blur(0);
    }

    .character-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      width: 100%;
      height: 120%;
      min-height: 400px;
      margin-top: 0%;
    }

    #character-sprite.character-sprite,
    .character-sprite.old-sprite,
    #character-left,
    #character-right {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .character-sprite {
      position: absolute;
      bottom: -50%;
      height: 100%;
      width: auto;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.3));
      pointer-events: auto;
    }

    .character-sprite.dynamic {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: bottom center;
    }

    .character-sprite.dynamic.pos-left {
      left: 25%;
      z-index: 3;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.pos-center {
      left: 50%;
      z-index: 4;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.pos-right {
      left: 75%;
      z-index: 3;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.pos-three-left {
      left: 15%;
      z-index: 3;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.pos-three-center {
      left: 50%;
      z-index: 4;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.pos-three-right {
      left: 85%;
      z-index: 3;
      transform: translateX(-50%) translateY(-30%);
    }

    .character-sprite.dynamic.entering {
      opacity: 0;
    }

    .character-sprite.dynamic.entering.pos-left {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.entering.pos-center {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.entering.pos-right {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.entering.pos-three-left {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.entering.pos-three-center {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.entering.pos-three-right {
      transform: translateX(-50%) translateY(50px);
      animation: enterFromBottomCenter 0.6s ease-out forwards;
    }

    .character-sprite.dynamic.exiting {
      animation: fadeOut 0.4s ease-in forwards;
    }

    .character-sprite.dynamic.sprite-changing {
      opacity: 0.3;
      transform: scale(0.98);
      transition: all 0.2s ease-out;
    }

    .character-sprite.dynamic.dimmed {
      filter: brightness(0.5) grayscale(0.3);
      transition: filter 0.3s ease;
    }

    .character-sprite:not(.dynamic) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    .character-sprite:not(.dynamic):not([src='']):not([src='#']) {
      display: none !important;
    }

    @keyframes enterFromBottomCenter {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(50px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(-30%);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    .background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      z-index: 2;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    .ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--ui-bg);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      padding: 12px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 16px var(--shadow-color-light);
      transition: background-color 0.5s ease;
      flex-grow: 1;
    }

    .game-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .money-display {
      display: flex;
      align-items: center;
      gap: 20px;
      font-weight: 500;
      color: var(--text-color);
    }

    .money-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .game-date,
    .player-status,
    .game-location,
    .game-time-period {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      color: var(--text-color);
    }

    .money-display {
      display: flex;
      align-items: center;
      gap: 20px;
      font-weight: 500;
      color: var(--text-color);
    }

    .money-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hover-info-bar {
      position: absolute;
      top: 75px;
      right: 20px;
      z-index: 15;
      pointer-events: auto;
      width: -moz-fit-content;
      width: fit-content;
      transition:
        left 0.3s ease,
        right 0.3s ease,
        opacity 0.3s ease;
    }

    .hover-info-bar.position-top-left {
      right: auto;
      left: 20px;
    }

    .hover-info-bar.position-top-left .hover-info-expanded {
      right: auto;
      left: 0;
    }

    .hover-info-bar.position-top-right {
      left: auto;
      right: 20px;
    }

    .hover-info-bar.position-top-right .hover-info-expanded {
      left: auto;
      right: 0;
    }

    .hover-info-bar.position-hidden {
      opacity: 0;
      pointer-events: none;
      visibility: hidden;
    }

    .hover-info-bar .bgm-indicator {
      opacity: 0;
      max-width: 0;
      margin-right: 0;
      transform: translateX(-20px) scale(0.8);
      transition:
        opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
        max-width 0.5s cubic-bezier(0.4, 0, 0.2, 1),
        margin-right 0.5s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      white-space: nowrap;
    }

    .hover-info-bar.show-trigger .bgm-indicator {
      opacity: 1;
      max-width: 120px;
      margin-right: 8px;
      transform: translateX(0) scale(1);
      transition-delay: 0s, 0.05s, 0.05s, 0s;
    }

    .hover-info-trigger {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 6px 12px;
      background: var(--ui-bg);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px var(--shadow-color-light);
      cursor: pointer;
      border: 1px solid rgba(0, 0, 0, 0);
      transition:
        background 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: scale(1);
    }

    .bgm-indicator,
    .suggestions-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-color);
    }

    .bgm-indicator i,
    .suggestions-indicator i {
      font-size: 11px;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }

    .suggestions-indicator {
      opacity: 1;
      transition: transform 0.3s ease;
    }

    .suggestions-indicator i {
      font-size: 14px !important;
    }

    .bgm-status {
      max-width: 80px;
      overflow: hidden;
      position: relative;
      white-space: nowrap;
    }

    .bgm-status.marquee .marquee-content {
      display: inline-block;
      animation: marquee 10s linear infinite;
    }

    .bgm-status.marquee .marquee-content span {
      display: inline-block;
      padding-right: 40px;
    }

    .suggestions-count {
      background: hsla(0, 0%, 100%, 0.9);
      color: #333;
      border-radius: 10px;
      padding: 3px 7px;
      font-size: 11px;
      min-width: 18px;
      text-align: center;
      font-weight: 700;
      line-height: 1.2;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .hover-info-expanded {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 12px;
      background: var(--ui-bg);
      border-radius: 12px;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      box-shadow: 0 8px 24px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      min-width: 300px;
      max-width: 380px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-15px) scale(0.96);
      transition:
        opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
        visibility 0.4s,
        transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
        box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 20;
    }

    .hover-info-bar.show-expanded .hover-info-expanded {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0) scale(1);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.5),
        0 0 0 1px hsla(0, 0%, 100%, 0.1),
        0 0 30px hsla(0, 0%, 100%, 0.05);
    }

    .hover-info-section {
      padding: 16px;
    }

    .hover-info-section:not(:last-child) {
      border-bottom: 1px solid var(--ui-border-color);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      color: hsla(0, 0%, 100%, 0.9);
      font-weight: 600;
      font-size: 14px;
    }

    .section-header i {
      font-size: 13px;
    }

    .section-content {
      font-size: 13px;
      line-height: 1.4;
    }

    .current-bgm {
      color: var(--text-color);
      font-weight: 500;
      padding: 8px 12px;
      background: hsla(0, 0%, 100%, 0.08);
      border-radius: 8px;
      text-align: center;
      border: 1px solid hsla(0, 0%, 100%, 0.2);
      overflow: hidden;
      position: relative;
    }

    .current-bgm.marquee {
      text-align: left;
    }

    .current-bgm.marquee .marquee-content {
      display: inline-block;
      animation: marquee 12s linear infinite;
    }

    .current-bgm.marquee .marquee-content span {
      display: inline-block;
      padding-right: 50px;
    }

    .current-bgm:hover.marquee .marquee-content {
      animation-play-state: paused;
    }

    @keyframes marquee {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-50%);
      }
    }

    .action-suggestions-mini {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .suggestion-item-mini {
      padding: 6px 10px;
      background: hsla(0, 0%, 100%, 0.05);
      border-radius: 6px;
      color: var(--text-color);
      font-size: 12px;
      line-height: 1.3;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(0, 0, 0, 0);
    }

    .suggestion-item-mini:hover {
      background: hsla(0, 0%, 100%, 0.15);
      border-color: hsla(0, 0%, 100%, 0.3);
      transform: translateX(2px);
    }

    .no-suggestions-mini {
      color: var(--text-color-secondary);
      font-style: italic;
      text-align: center;
      padding: 12px;
      opacity: 0.7;
    }

    .current-quest-mini {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quest-title-mini {
      color: var(--text-color);
      font-weight: 600;
      font-size: 13px;
      padding: 8px 12px;
      background: hsla(0, 0%, 100%, 0.08);
      border-radius: 8px;
      border: 1px solid hsla(0, 0%, 100%, 0.2);
    }

    .quest-details-mini {
      color: var(--text-color-secondary);
      font-size: 12px;
      line-height: 1.4;
      padding: 6px 10px;
      background: hsla(0, 0%, 100%, 0.03);
      border-radius: 6px;
    }

    .no-quest-mini {
      color: var(--text-color-secondary);
      font-style: italic;
      text-align: center;
      padding: 12px;
      opacity: 0.7;
    }

    .dialogue-box {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 1000px;
      z-index: 5;
      background: var(--ui-bg-heavy);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      border-radius: 20px;
      padding: 24px;
      transition:
        background-color 0.5s ease,
        border-color 0.5s ease;
      box-shadow: 0 8px 32px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      pointer-events: auto;
    }

    .character-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary-color-light);
    }

    .dialogue-text {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-color);
      margin-bottom: 16px;
    }

    .dialogue-controls {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      margin-left: auto;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0, 0, 0, 0);
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn:hover {
      color: var(--primary-color);
      transform: scale(1.2);
    }

    .control-btn:active {
      transform: scale(1);
    }

    .control-btn.disabled,
    .control-btn:disabled {
      color: var(--text-color-secondary);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .control-btn.disabled:hover,
    .control-btn:disabled:hover {
      color: var(--text-color-secondary);
      transform: none;
    }

    .control-btn i {
      font-size: 18px;
    }

    .character-hover-trigger {
      display: none;
    }

    .character-status-tooltip {
      position: absolute;
      left: 25%;
      top: 45%;
      transform: translate(-50%, -50%);
      width: -moz-fit-content;
      width: fit-content;
      min-width: 200px;
      max-width: min(320px, 100vw - 40px);
      padding: 18px;
      background: var(--ui-bg);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      opacity: 0;
      visibility: hidden;
      z-index: 15;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      text-align: left;
    }

    @media (max-width: 768px) {
      .character-status-tooltip {
        left: 50%;
        min-width: 180px;
        max-width: calc(100vw - 40px);
        padding: 14px;
        font-size: 14px;
      }
    }

    .character-hover-trigger:hover ~ .character-status-tooltip,
    .character-sprite:hover ~ .character-status-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%);
    }

    .character-status-tooltip.active {
      opacity: 1;
      visibility: visible;
    }

    .hummingbird-tooltip {
      position: absolute;
      z-index: 200;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .hummingbird-tooltip.active {
      opacity: 1;
      visibility: visible;
    }

    .status-tooltip-header {
      text-align: left;
      padding-bottom: 12px;
    }

    .character-fullname {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-color);
      margin: 0;
    }

    @media (max-width: 768px) {
      .character-fullname {
        font-size: 18px;
      }
    }

    .character-affiliation {
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
      font-weight: 500;
      margin: 4px 0 0 0;
    }

    @media (max-width: 768px) {
      .character-affiliation {
        font-size: 12px;
      }
    }

    .status-tooltip-divider {
      height: 1px;
      background: var(--ui-border-color);
      margin: 0;
    }

    .status-tooltip-body {
      padding: 12px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      align-items: center;
      min-width: 0;
      gap: 8px;
    }

    .status-label {
      color: var(--text-color);
      opacity: 0.8;
      font-weight: 500;
      min-width: 50px;
      flex-shrink: 0;
    }

    .status-value {
      color: var(--text-color);
      font-weight: 600;
      text-align: right;
      min-width: 0;
    }

    .status-value.relationship {
      color: var(--text-color);
      font-weight: 600;
    }

    .status-progress-bar {
      width: 80px;
      height: 8px;
      background-color: rgba(120, 120, 128, 0.2);
      border-radius: 4px;
      overflow: hidden;
      align-self: baseline;
      flex-shrink: 0;
    }

    .progress-bar-fill {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 4px;
      transition: width 0.5s ease-in-out;
    }

    .status-tooltip-footer {
      padding-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .status-tooltip-footer .status-value {
      font-variant-emoji: text;
    }

    .status-tooltip-footer .status-value[data-emoji='true'] {
      position: relative;
    }

    .status-tooltip-footer .status-value[data-emoji='true']::before {
      content: '•';
      color: var(--text-color);
      opacity: 0.6;
      margin-right: 6px;
      font-weight: 400;
    }

    .status-tags-container {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .status-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-start;
    }

    .status-tag {
      background: var(--primary-color);
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    @media (max-width: 768px) {
      .status-tag {
        font-size: 11px;
        padding: 3px 6px;
      }
    }

    .map-controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }

    .segmented-control {
      display: flex;
      background: var(--ui-bg);
      border-radius: 20px;
      padding: 4px;
      box-shadow: 0 4px 16px var(--shadow-color-light);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
    }

    .sg-btn {
      padding: 8px 16px;
      border: 1px solid var(--ui-border-color);
      background: var(--ui-bg);
      color: var(--text-color);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 14px;
    }

    .sg-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .sg-btn:hover:not(.active) {
      background: var(--ui-bg-heavy);
      border-color: var(--primary-color-light);
    }

    .map-canvas {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .map-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 16px;
    }

    .map-point {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-color-light));
      transform: translate(-50%, -50%);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
      border: 2px solid hsla(0, 0%, 100%, 0.9);
    }

    .map-point::before {
      content: '';
      width: 8px;
      height: 8px;
      background: hsla(0, 0%, 100%, 0.95);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 8px hsla(0, 0%, 100%, 0.6);
      transition: all 0.3s ease;
    }

    .map-point::after {
      content: '';
      position: absolute;
      width: 160%;
      height: 160%;
      border-radius: 50%;
      background: radial-gradient(circle, var(--primary-color) 0%, transparent 70%);
      animation: mapPointPulse 2s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0.6;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.3);
      z-index: -1;
    }

    .map-point:hover {
      transform: translate(-50%, -50%) scale(1.3);
      box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.5);
    }

    .map-point:hover::before {
      background: var(--primary-color);
      box-shadow: 0 0 12px hsla(0, 0%, 100%, 0.8);
      transform: translate(-50%, -50%) scale(1.2);
    }

    .map-point:hover::after {
      animation-duration: 1s;
      opacity: 0.8;
    }

    .map-point:active {
      transform: translate(-50%, -50%) scale(1.1);
    }

    @keyframes mapPointPulse {
      0% {
        transform: translate(-50%, -50%) scale(0.3);
        opacity: 0;
      }

      50% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.6;
      }

      100% {
        transform: translate(-50%, -50%) scale(1.6);
        opacity: 0;
      }
    }

    #map-tooltip {
      position: absolute;
      background: var(--ui-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 8px 24px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      opacity: 0;
      visibility: hidden;
      transform: translate(-50%, -120%);
      transition: all 0.3s ease;
      z-index: 20;
      max-width: 250px;
    }

    #map-tooltip.active {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -140%);
    }

    #map-tooltip h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: var(--primary-color);
      font-weight: 600;
      border-bottom: 1px solid var(--primary-color-light);
      padding-bottom: 4px;
    }

    #map-tooltip p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .newspaper-container {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      perspective: 1000px;
    }

    .newspaper-background {
      position: relative;
      width: 90%;
      max-width: 800px;
      height: auto;
      transform-style: preserve-3d;
      filter: sepia(15%) contrast(1.05) brightness(0.98) saturate(0.85);
      transition: filter 0.3s ease;
    }

    .newspaper-background:hover {
      filter: sepia(8%) contrast(1.02) brightness(1) saturate(0.9);
    }

    .newspaper-background::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events: none;
      opacity: 0.15;
      background-image:
        radial-gradient(
          circle at 20% 50%,
          transparent 20%,
          rgba(120, 119, 109, 0.3) 21%,
          rgba(120, 119, 109, 0.3) 34%,
          transparent 35%
        ),
        linear-gradient(0deg, rgba(0, 0, 0, 0.1) 50%, transparent 50%);
      background-size:
        3px 3px,
        2px 2px;
      mix-blend-mode: multiply;
    }

    .newspaper-bg-image {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 6px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
    }

    .newspaper-shadow-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .newspaper-content {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 8% 10% 12% 8%;
      transform: translateX(-2px) translateY(-13px) rotateX(-52deg) rotateY(2deg) rotateZ(-15deg) scale(0.85);
      z-index: 1;
      color: #2a2a2a;
      font-family: 'Times New Roman', serif;
      text-shadow: 0.3px 0.3px 0.5px rgba(0, 0, 0, 0.08);
    }

    .newspaper-headline {
      margin-bottom: 5%;
      text-align: center;
    }

    .main-headline {
      font-size: 2em;
      font-weight: bold;
      margin: 0 0 1% 0;
      color: #1a1a1a;
      text-shadow: none;
      line-height: 1.1;
    }

    .headline-subtitle {
      font-size: 1em;
      margin: 0;
      color: #555;
      font-style: italic;
    }

    .newspaper-main-news {
      display: flex;
      gap: 4%;
      margin-bottom: 6%;
    }

    .news-column {
      flex: 1;
    }

    .news-column.left-column {
      flex: 1.2;
    }

    .news-column.right-column {
      flex: 0.8;
    }

    .news-title {
      font-size: 1em;
      font-weight: bold;
      margin: 0 0 2% 0;
      color: #1a1a1a;
      border-bottom: 1px solid #555;
      padding-bottom: 1%;
    }

    .news-content {
      font-size: 0.85em;
      line-height: 1.35;
      margin-bottom: 3%;
      text-align: justify;
      color: #2a2a2a;
    }

    .news-image-frame {
      margin-bottom: 3%;
      text-align: center;
      position: relative;
    }

    .news-image-frame::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      opacity: 0.08;
      background-image:
        radial-gradient(circle at 30% 60%, transparent 70%, rgba(120, 119, 109, 0.35) 71%, transparent 72%),
        linear-gradient(90deg, rgba(0, 0, 0, 0.08) 50%, transparent 50%);
      background-size:
        2px 2px,
        3px 3px;
      mix-blend-mode: multiply;
    }

    .news-image {
      width: 100%;
      max-width: 200px;
      height: auto;
      max-height: 180px;
      border: 1px solid #666;
      border-radius: 3px;
      object-fit: contain;
      object-position: center;
      filter: saturate(0.55) sepia(0.12) contrast(1.08) brightness(0.98);
    }

    .news-image::after {
      content: attr(data-caption);
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      background: hsla(0, 0%, 100%, 0.9);
      color: #444;
      font-size: 0.7em;
      font-style: italic;
      padding: 2px 6px;
      border-radius: 2px;
      max-width: calc(100% - 12px);
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .headline-content {
      margin-bottom: 3%;
      padding: 1.5%;
      border-top: 1px solid #555;
    }

    .headline-content .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 0;
      color: #000;
      text-align: justify;
    }

    .secondary-news {
      margin-bottom: 3%;
      padding: 1.5%;
      border-left: 2px solid #666;
    }

    .secondary-news .secondary-news-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #1a1a1a;
      margin: 0px 0 1% 0;
      line-height: 2.2;
    }

    .secondary-news .news-content {
      font-size: 1.2em;
      line-height: 1.35;
      margin: 0;
      color: #2a2a2a;
      text-align: justify;
    }

    .secondary-news:last-child {
      margin-bottom: 0;
    }

    .headline-image-section {
      margin-bottom: 3%;
      text-align: center;
      position: relative;
    }

    .headline-image-section .news-image {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      object-position: center;
      border: 1px solid #666;
      border-radius: 3px;
      filter: saturate(0.55) sepia(0.12) contrast(1.08) brightness(0.98);
    }

    .headline-image-section .news-image::after {
      content: attr(data-caption);
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: hsla(0, 0%, 100%, 0.95);
      color: #444;
      font-size: 0.65em;
      font-style: italic;
      padding: 3px 8px;
      border-radius: 2px;
      max-width: calc(100% - 20px);
      text-align: center;
      line-height: 1.2;
    }

    .announcements-section {
      margin-top: 2%;
    }

    .announcements-section .news-title {
      font-size: 1em;
      font-weight: bold;
      color: #1a1a1a;
      margin: 0;
      padding: 0;
      border: none;
      display: inline;
    }

    .announcement-item {
      display: inline;
      margin: 0 0 0 8px;
      font-size: 0.85em;
      line-height: 1.35;
      color: #2a2a2a;
      text-align: justify;
    }

    .newspaper-header {
      text-align: center;
      margin-bottom: 3%;
      padding-bottom: 1.5%;
      border-bottom: 2px solid #555;
    }

    .newspaper-header .newspaper-name {
      font-size: 1.6em;
      font-weight: bold;
      color: #1a1a1a;
      margin: 0 0 1% 0;
      font-family: serif;
    }

    .newspaper-header .newspaper-date {
      font-size: 0.75em;
      color: #555;
      font-style: italic;
    }

    .weather-section {
      font-size: 0.8em;
      line-height: 1.3;
      padding: 1.5%;
      border: 1px solid #666;
      border-radius: 3px;
      margin-bottom: 2%;
    }

    .weather-section p {
      margin: 0.5% 0;
      color: #2a2a2a;
    }

    .newspaper-ads {
      display: flex;
      gap: 2%;
      border-top: 1px solid #555;
      padding-top: 2%;
    }

    .newspaper-ads .ad-item {
      flex: 1;
      text-align: center;
      padding: 1%;
      border: 1px solid #666;
      border-radius: 2px;
    }

    .newspaper-ads .ad-item h4 {
      font-size: 0.8em;
      margin: 0 0 1% 0;
      font-weight: bold;
      color: #1a1a1a;
    }

    .newspaper-ads .ad-item p {
      font-size: 0.7em;
      margin: 0;
      color: #2a2a2a;
    }

    @media (max-width: 768px) {
      .newspaper-background {
        transform: none;
      }

      .newspaper-main-news {
        flex-direction: column;
        gap: 4%;
      }

      .newspaper-ads {
        flex-direction: column;
        gap: 3%;
      }

      .newspaper-content {
        padding: 6% 8% 10% 6%;
      }
    }

    .modal-view-container.newspaper-mode .newspaper-container {
      transform: scale(1.15);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-color);
      opacity: 0.6;
      text-align: center;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--primary-color);
    }

    .empty-state p {
      font-size: 16px;
      margin: 0;
    }

    .settings-popover {
      position: absolute;
      top: 60px;
      right: 20px;
      background: var(--ui-bg-heavy);
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px var(--shadow-color-medium);
      border: 1px solid var(--ui-border-color);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px) scale(0.95);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 1000;
      min-width: 200px;
      max-width: calc(100vw - 40px);
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }

    .settings-popover::-webkit-scrollbar {
      display: none;
    }

    .settings-popover {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .settings-popover.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    @media (max-width: 768px) {
      .settings-popover {
        position: fixed;
        top: 50%;
        left: 50%;
        right: auto;
        transform: translate(-50%, -50%) scale(0.95);
        width: calc(100vw - 40px);
        max-width: 400px;
        max-height: calc(100vh - 80px);
      }

      .settings-popover.active {
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @media (max-width: 480px) {
      .settings-popover {
        width: calc(100vw - 20px);
        padding: 16px;
        border-radius: 12px;
        max-height: calc(100vh - 60px);
      }
    }

    .settings-section {
      margin-bottom: 16px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
    }

    .theme-buttons-container {
      display: flex;
      gap: 8px;
    }

    .theme-btn {
      width: 40px;
      height: 40px;
      border: 2px solid var(--ui-border-color);
      border-radius: 50%;
      background: var(--ui-bg);
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .theme-btn:hover {
      border-color: var(--primary-color);
      transform: scale(1.1);
    }

    .theme-btn.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: #fff;
    }

    .visual-effects-section .section-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .visual-effects-section .section-header i {
      color: var(--primary-color);
      font-size: 14px;
    }

    .visual-effects-section .section-header .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
    }

    .visual-effects-section .settings-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .visual-effects-section .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--ui-bg);
      border: 1px solid var(--ui-border-color);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .visual-effects-section .setting-item:hover:not(.disabled) {
      background: var(--ui-bg-light);
      border-color: var(--primary-color-light);
    }

    .visual-effects-section .setting-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 480px) {
      .visual-effects-section .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 10px;
      }

      .visual-effects-section .setting-item .setting-control {
        width: 100%;
        display: flex;
        justify-content: flex-end;
      }
    }

    .visual-effects-section .setting-item .setting-info {
      flex: 1;
    }

    .visual-effects-section .setting-item .setting-info .setting-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 2px;
    }

    .visual-effects-section .setting-item .setting-info .setting-description {
      font-size: 11px;
      color: var(--text-color);
      opacity: 0.7;
      line-height: 1.3;
    }

    .visual-effects-section .setting-item .setting-control .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--ui-bg-heavy);
      border: 1px solid var(--ui-border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .visual-effects-section .setting-item .setting-control .toggle-switch::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: var(--text-color);
      border-radius: 50%;
      transition: all 0.3s ease;
      opacity: 0.6;
    }

    .visual-effects-section .setting-item .setting-control .toggle-switch.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .visual-effects-section .setting-item .setting-control .toggle-switch.active::before {
      left: 22px;
      background: #fff;
      opacity: 1;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle {
      position: relative;
      display: flex;
      align-items: center;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle input[type='checkbox'] {
      display: none;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track {
      position: relative;
      width: 52px;
      height: 28px;
      background: var(--ui-bg-heavy);
      border: 2px solid var(--ui-border-color);
      border-radius: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--text-color);
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle .toggle-track .toggle-thumb .toggle-icon {
      font-size: 10px;
      color: var(--ui-bg-heavy);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .visual-effects-section
      .setting-item
      .setting-control
      .modern-toggle
      input[type='checkbox']:checked
      + .toggle-track {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .visual-effects-section
      .setting-item
      .setting-control
      .modern-toggle
      input[type='checkbox']:checked
      + .toggle-track
      .toggle-thumb {
      left: 26px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .visual-effects-section
      .setting-item
      .setting-control
      .modern-toggle
      input[type='checkbox']:checked
      + .toggle-track
      .toggle-thumb
      .toggle-icon {
      opacity: 1;
      color: var(--primary-color);
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle.disabled .toggle-track {
      cursor: not-allowed;
    }

    .visual-effects-section .setting-item .setting-control .modern-toggle:not(.disabled):hover .toggle-track {
      box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.1);
    }

    .visual-effects-section .setting-item .setting-control input[type='checkbox'] {
      display: none;
    }

    .panel-tabs {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: rgba(0, 0, 0, 0);
      color: var(--text-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 14px;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: #fff;
    }

    .tab-btn:hover:not(.active) {
      background: var(--ui-bg-heavy);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .character-overview-new {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-info-row {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .character-card-compact {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--ui-bg);
      border-radius: 12px;
      border: 1px solid var(--ui-border-color);
      box-shadow: 0 2px 8px var(--shadow-color-light);
      flex: 0 0 auto;
      min-width: 200px;
    }

    .character-info-compact {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .character-stats-compact {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stat-label-compact {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      font-weight: 500;
    }

    .stat-value-compact {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 600;
    }

    .wealth-section-compact {
      flex: 1;
      padding: 16px;
      background: var(--ui-bg);
      border-radius: 12px;
      border: 1px solid var(--ui-border-color);
      box-shadow: 0 2px 8px var(--shadow-color-light);
    }

    .wealth-section-compact h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .wealth-items-compact {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .wealth-item-compact {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
    }

    .wealth-item-compact i {
      font-size: 16px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }

    .wealth-item-compact div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex: 1;
    }

    .wealth-label-compact {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .wealth-value-compact {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .main-content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    .abilities-section-compact {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ability-group-compact {
      padding: 12px;
      background: var(--ui-bg);
      border-radius: 10px;
      border: 1px solid var(--ui-border-color);
    }

    .ability-group-compact h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .ability-list-compact {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ability-list-compact li {
      padding: 6px 8px;
      background: var(--ui-bg-heavy);
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.3;
      color: var(--text-color);
    }

    .ability-list-compact li strong {
      display: block;
      margin-bottom: 2px;
      font-size: 13px;
    }

    .ability-list-compact li small {
      font-size: 1em;
      opacity: 0.8;
      line-height: 1.2;
    }

    .equipment-section-compact {
      padding: 12px;
      background: var(--ui-bg);
      border-radius: 10px;
      border: 1px solid var(--ui-border-color);
    }

    .equipment-section-compact h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .equipment-items-compact {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inventory-section-compact {
      padding: 12px;
      background: var(--ui-bg);
      border-radius: 10px;
      border: 1px solid var(--ui-border-color);
    }

    .inventory-section-compact h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .inventory-items-compact {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 150px;
      overflow-y: auto;
    }

    .inventory-items-compact::-webkit-scrollbar {
      display: none;
    }

    .inventory-items-compact {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .inventory-items-compact .inventory-item {
      padding: 8px;
      font-size: 12px;
    }

    .inventory-items-compact .inventory-item .inventory-item-icon {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }

    .inventory-items-compact .inventory-item .inventory-item-name {
      font-size: 12px;
      margin-bottom: 1px;
    }

    .inventory-items-compact .inventory-item .inventory-item-description {
      font-size: 11px;
    }

    .inventory-items-compact .inventory-item .inventory-item-quantity {
      font-size: 11px;
    }

    @media (max-width: 1000px) {
      .main-content-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .top-info-row {
        flex-direction: column;
      }

      .character-card-compact {
        min-width: auto;
      }
    }

    @media (max-width: 768px) {
      .main-content-grid {
        grid-template-columns: 1fr;
      }
    }

    .character-card {
      display: flex;
      gap: 20px;
      padding: 24px;
      background: var(--ui-bg);
      border-radius: 20px;
      border: 1px solid var(--ui-border-color);
      box-shadow: 0 4px 16px var(--shadow-color-light);
    }

    .character-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: var(--ui-bg-heavy);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--ui-border-color);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .character-avatar .avatar-placeholder {
      font-size: 32px;
      color: var(--text-color);
      opacity: 0.6;
    }

    .character-avatar.user-avatar .avatar-placeholder {
      display: none;
    }

    .character-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .character-name {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-color);
      margin: 0 0 12px 0;
    }

    .character-stats {
      display: flex;
      gap: 24px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      font-weight: 500;
    }

    .stat-value {
      font-size: 16px;
      color: var(--text-color);
      font-weight: 600;
    }

    .wealth-section {
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .wealth-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .equipment-section {
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .equipment-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .equipment-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .equipment-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
      border: 1px solid var(--ui-border-color);
      transition: all 0.2s ease;
    }

    .equipment-item:hover {
      background: var(--ui-bg-light);
      border-color: var(--primary-color-light);
    }

    .equipment-item.equipped {
      border-color: var(--primary-color);
      background: var(--primary-color-light);
    }

    .equipment-item-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-color);
      border-radius: 8px;
      color: #fff;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .equipment-item-icon i {
      font-size: 16px;
    }

    .equipment-item-info {
      flex: 1;
      min-width: 0;
    }

    .equipment-item-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 2px;
    }

    .equipment-item-type {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      line-height: 1.3;
    }

    .equipment-item-badge {
      font-size: 10px;
      color: var(--primary-color);
      font-weight: 600;
      background: var(--primary-color-light);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .equipment-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-color);
      opacity: 0.6;
    }

    .equipment-empty i {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .equipment-empty p {
      margin: 0;
      font-size: 14px;
    }

    .basic-stats-section {
      padding: 12px 0;
    }

    .ability-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ability-list-compact {
      gap: 8px;
    }

    .ability-list-compact .empty-state {
      color: hsla(0, 0%, 100%, 0.5);
      font-style: italic;
      text-align: center;
      padding: 16px 12px;
      background: var(--ui-bg-light);
      border-radius: 8px;
      font-size: 14px;
    }

    [data-theme='light'] .ability-list-compact .empty-state {
      color: rgba(0, 0, 0, 0.5);
    }

    .user_avatar,
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-color: var(--ui-bg-heavy);
      border: 2px solid var(--ui-border);
      flex-shrink: 0;
      display: block;
    }

    [data-theme='dark'] .user_avatar,
    [data-theme='dark'] .user-avatar {
      border-color: hsla(0, 0%, 100%, 0.1);
    }

    .top-info-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .character-card-expanded {
      flex: 2;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--ui-bg-light);
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .character-card-expanded:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--shadow-color-light);
    }

    .character-card-expanded .character-info-expanded {
      flex: 1;
    }

    .character-card-expanded .character-info-expanded .character-name {
      margin: 0 0 12px 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
    }

    .character-card-expanded .character-info-expanded .character-stats-expanded {
      display: flex;
      gap: 20px;
    }

    .character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact .stat-label-compact {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .character-card-expanded .character-info-expanded .character-stats-expanded .stat-compact .stat-value-compact {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .wealth-section-narrow {
      flex: 1;
      padding: 16px;
      background: var(--ui-bg-light);
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .wealth-section-narrow:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--shadow-color-light);
    }

    .wealth-section-narrow h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      text-align: center;
    }

    .wealth-section-narrow .wealth-items-narrow {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .wealth-section-narrow .wealth-item-narrow {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--ui-bg);
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
    }

    .wealth-section-narrow .wealth-item-narrow i {
      font-size: 16px;
      color: var(--accent-color);
      min-width: 20px;
      text-align: center;
    }

    .wealth-section-narrow .wealth-item-narrow div {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wealth-section-narrow .wealth-item-narrow div .wealth-label-narrow {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .wealth-section-narrow .wealth-item-narrow div .wealth-value-narrow {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-color);
    }

    .equipment-preview-detailed {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    .equipment-preview-detailed .equipment-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 30px;
      color: var(--text-muted);
    }

    .equipment-preview-detailed .equipment-empty i {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .equipment-preview-detailed .equipment-empty p {
      margin: 0;
      font-size: 14px;
    }

    .equipment-preview-detailed .equipment-item-detailed {
      background: var(--ui-bg);
      border: 2px solid var(--ui-border);
      border-radius: 6px;
      padding: 14px;
      margin: 0;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .equipment-preview-detailed .equipment-item-detailed:hover {
      border-color: var(--accent-color);
      background: var(--ui-bg-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-color-light);
    }

    .equipment-preview-detailed .equipment-item-detailed .equipment-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-icon {
      font-size: 20px;
      color: var(--accent-color);
      min-width: 24px;
      text-align: center;
    }

    .equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-main-info {
      flex: 1;
    }

    .equipment-preview-detailed
      .equipment-item-detailed
      .equipment-item-header
      .equipment-item-main-info
      .equipment-item-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 2px;
    }

    .equipment-preview-detailed
      .equipment-item-detailed
      .equipment-item-header
      .equipment-item-main-info
      .equipment-item-type {
      font-size: 11px;
      color: var(--text-muted);
    }

    .equipment-preview-detailed .equipment-item-detailed .equipment-item-header .equipment-item-badge {
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      font-size: 10px;
      font-weight: 500;
      padding: 4px 8px;
      border: 1px solid var(--ui-border-color);
      border-radius: 10px;
      white-space: nowrap;
    }

    .equipment-preview-detailed .equipment-item-detailed .equipment-item-description {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-color);
      background: var(--ui-bg-light);
      padding: 8px;
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
      opacity: 0.9;
    }

    .rpg-tabs {
      display: flex;
      gap: 4px;
      background: var(--ui-bg-heavy);
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--ui-border);
    }

    .rpg-tabs .tab-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: rgba(0, 0, 0, 0);
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .rpg-tabs .tab-btn i {
      font-size: 20px;
      transition: transform 0.3s ease;
    }

    .rpg-tabs .tab-btn span {
      font-size: 12px;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .rpg-tabs .tab-btn:hover {
      background: var(--ui-bg-light);
      color: var(--text-color);
      transform: translateY(-2px);
    }

    .rpg-tabs .tab-btn:hover i {
      transform: scale(1.1);
    }

    .rpg-tabs .tab-btn.active {
      background: var(--accent-color);
      color: #fff;
      box-shadow: 0 4px 12px var(--accent-shadow);
    }

    .rpg-tabs .tab-btn.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .rpg-content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      padding: 20px 0;
    }

    .rpg-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .rpg-card {
      background: var(--ui-bg-light);
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      transition: all 0.3s ease;
    }

    .rpg-card:hover {
      border-color: var(--accent-color);
      box-shadow: 0 8px 24px var(--shadow-color-light);
      transform: translateY(-2px);
    }

    .rpg-card .card-header {
      background: var(--ui-bg-heavy);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--ui-border);
      position: relative;
    }

    .rpg-card .card-header::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent-color);
    }

    .rpg-card .card-header i {
      font-size: 16px;
      color: var(--accent-color);
    }

    .rpg-card .card-header h4 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .rpg-card .ability-list-compact {
      padding: 16px;
      margin: 0;
    }

    .rpg-card .ability-list-compact li {
      background: var(--ui-bg);
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid var(--accent-color);
      transition: all 0.2s ease;
    }

    .rpg-card .ability-list-compact li:hover {
      background: var(--ui-bg-hover);
      transform: translateX(4px);
    }

    .rpg-card .ability-list-compact li:last-child {
      margin-bottom: 0;
    }

    .rpg-card .ability-list-compact .empty-state {
      background: var(--ui-bg);
      border-left: 3px solid var(--text-muted);
      opacity: 0.7;
    }

    .equipment-preview {
      padding: 16px;
    }

    .equipment-preview .equipment-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: var(--ui-bg);
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid var(--accent-color);
    }

    .equipment-preview .equipment-item .equipment-item-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-color);
    }

    .equipment-preview .equipment-item .equipment-item-icon i {
      font-size: 16px;
    }

    .equipment-preview .equipment-item .equipment-item-info {
      flex: 1;
    }

    .equipment-preview .equipment-item .equipment-item-info .equipment-item-name {
      font-weight: 500;
      color: var(--text-color);
      font-size: 13px;
      margin-bottom: 2px;
    }

    .equipment-preview .equipment-item .equipment-item-info .equipment-item-type {
      font-size: 11px;
      color: var(--text-muted);
    }

    .equipment-preview .equipment-item .equipment-item-badge {
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      border: 1px solid var(--ui-border-color);
      font-weight: 500;
    }

    .modal-body::-webkit-scrollbar,
    .rpg-inventory-container::-webkit-scrollbar,
    .rpg-equipment-container::-webkit-scrollbar {
      display: none;
    }

    .modal-body,
    .rpg-inventory-container,
    .rpg-equipment-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .rpg-inventory-container {
      padding: 20px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .rpg-inventory-container .inventory-header {
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .rpg-inventory-container .inventory-header .inventory-stats {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: var(--ui-bg-light);
      border-radius: 8px;
      border: 1px solid var(--ui-border);
    }

    .rpg-inventory-container .inventory-header .inventory-stats span {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 500;
    }

    .rpg-inventory-container .inventory-header .inventory-stats span span {
      color: var(--accent-color);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .rpg-inventory-container .inventory-header .inventory-sorting:hover {
      background: var(--ui-bg-light);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
      opacity: 0.8;
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-select {
      padding: 6px 10px;
      border: 1px solid var(--ui-border-color);
      border-radius: 6px;
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-select:hover {
      border-color: var(--primary-color-light);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px var(--primary-color-light);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--ui-border-color);
      border-radius: 6px;
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn:hover {
      background: var(--primary-color-light);
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: scale(1.05);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn:active {
      transform: scale(0.95);
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn i {
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    .rpg-inventory-container .inventory-header .inventory-sorting .sort-order-btn[data-order='desc'] i {
      transform: rotate(180deg);
    }

    .rpg-inventory-container .inventory-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      flex: 1;
      overflow: hidden;
    }

    .rpg-inventory-container .inventory-grid-container {
      overflow-y: auto;
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      background: var(--ui-bg-light);
      padding: 16px;
    }

    .rpg-inventory-container .inventory-grid-container::-webkit-scrollbar {
      display: none;
    }

    .rpg-inventory-container .inventory-grid-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .rpg-inventory-container .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 16px;
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot {
      width: 100%;
      height: 110px;
      background: var(--ui-bg);
      border: none;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 12px 8px;
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot:hover {
      background: var(--ui-bg-light);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px var(--shadow-color-medium);
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot.selected {
      background: var(--primary-color-light);
      box-shadow: 0 4px 16px var(--shadow-color-light);
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot .item-icon {
      font-size: 24px;
      color: var(--accent-color);
      margin-bottom: 6px;
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot .item-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-color);
      text-align: center;
      line-height: 1.2;
      margin-bottom: 4px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot .item-quantity {
      position: absolute;
      bottom: 2px;
      right: 4px;
      background: var(--accent-color);
      color: #fff;
      font-size: 10px;
      font-weight: 500;
      padding: 1px 4px;
      border-radius: 8px;
      min-width: 16px;
      text-align: center;
    }

    .rpg-inventory-container .inventory-grid .inventory-item-slot .equipped-badge {
      position: absolute;
      top: 2px;
      left: 2px;
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      font-size: 8px;
      font-weight: 500;
      padding: 1px 4px;
      border-radius: 6px;
    }

    .rpg-inventory-container .inventory-grid .inventory-empty-message {
      grid-column: 1/-1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .rpg-inventory-container .inventory-grid .inventory-empty-message i {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .rpg-inventory-container .inventory-grid .inventory-empty-message p {
      margin: 0;
      font-size: 14px;
      text-align: center;
    }

    .rpg-inventory-container .item-details-panel {
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      background: var(--ui-bg-light);
      padding: 16px;
      overflow-y: auto;
    }

    .rpg-inventory-container .item-details-panel::-webkit-scrollbar {
      display: none;
    }

    .rpg-inventory-container .item-details-panel {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .rpg-inventory-container .item-details-panel .no-item-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
    }

    .rpg-inventory-container .item-details-panel .no-item-selected i {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .rpg-inventory-container .item-details-panel .no-item-selected p {
      margin: 0;
      font-size: 14px;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--ui-border);
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header .item-icon-large {
      width: 48px;
      height: 48px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--ui-border);
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header .item-icon-large i {
      font-size: 24px;
      color: var(--accent-color);
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info {
      flex: 1;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info .item-name {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-header .item-basic-info .item-type {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties {
      margin-bottom: 16px;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description h4,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description h4::before,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties h4::before {
      content: '';
      width: 2px;
      height: 12px;
      background: var(--accent-color);
      border-radius: 1px;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description p,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties p {
      margin: 0;
      font-size: 13px;
      color: var(--text-color);
      line-height: 1.4;
      background: var(--ui-bg);
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 3px solid var(--accent-color);
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul li,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul li {
      padding: 6px 12px;
      background: var(--ui-bg);
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 13px;
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
    }

    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-description ul li:last-child,
    .rpg-inventory-container .item-details-panel .item-details .item-details-body .item-properties ul li:last-child {
      margin-bottom: 0;
    }

    .rpg-equipment-container {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .rpg-equipment-container .equipment-slots-section h4,
    .rpg-equipment-container .all-equipment-section h4 {
      margin: 0 0 16px 0;
      color: var(--text-color);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rpg-equipment-container .equipment-slots-section h4::before,
    .rpg-equipment-container .all-equipment-section h4::before {
      content: '';
      width: 3px;
      height: 16px;
      background: var(--accent-color);
      border-radius: 2px;
    }

    .rpg-equipment-container .equipment-slots-grid {
      display: grid;
      gap: 16px;
    }

    .rpg-equipment-container .equipment-slot {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--ui-bg-light);
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .rpg-equipment-container .equipment-slot:hover {
      border-color: var(--accent-color);
      transform: translateX(4px);
    }

    .rpg-equipment-container .equipment-slot .slot-icon {
      width: 48px;
      height: 48px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--ui-border);
    }

    .rpg-equipment-container .equipment-slot .slot-icon i {
      font-size: 20px;
      color: var(--accent-color);
    }

    .rpg-equipment-container .equipment-slot .slot-label {
      font-weight: 500;
      color: var(--text-color);
      min-width: 60px;
    }

    .rpg-equipment-container .equipment-slot .equipped-item {
      flex: 1;
      min-height: 20px;
    }

    .rpg-equipment-container .equipment-list-container {
      border: 2px solid var(--ui-border);
      border-radius: 12px;
      background: var(--ui-bg-light);
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
    }

    .rpg-equipment-container .equipment-list-container::-webkit-scrollbar {
      display: none;
    }

    .rpg-equipment-container .equipment-list-container {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .rpg-equipment-container .equipment-list-container .no-equipment {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 14px;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--ui-bg);
      border: 2px solid var(--ui-border);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item:hover {
      border-color: var(--accent-color);
      background: var(--ui-bg-hover);
      transform: translateX(4px);
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item.equipped {
      border-color: var(--primary-color);
      background: var(--primary-color-light);
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-icon {
      width: 40px;
      height: 40px;
      background: var(--ui-bg-heavy);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--ui-border);
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-icon i {
      font-size: 18px;
      color: var(--accent-color);
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info {
      flex: 1;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info .equipment-item-name {
      font-weight: 500;
      color: var(--text-color);
      font-size: 14px;
      margin-bottom: 2px;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-info .equipment-item-type {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .rpg-equipment-container
      .equipment-list-container
      .equipment-list-item
      .equipment-item-info
      .equipment-item-description {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equipped-badge {
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equip-btn {
      background: var(--accent-color);
      color: #fff;
      border: none;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .rpg-equipment-container .equipment-list-container .equipment-list-item .equipment-item-status .equip-btn:hover {
      background: var(--accent-color-light);
      transform: translateY(-1px);
    }

    .rpg-equipment-container .equipped-item-display {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rpg-equipment-container .equipped-item-display .equipped-item-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-color);
    }

    .rpg-equipment-container .equipped-item-display .equipped-item-icon i {
      font-size: 14px;
    }

    .rpg-equipment-container .equipped-item-display .equipped-item-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-color);
    }

    .rpg-equipment-container .empty-slot {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }

    .ability-list li,
    .ability-list .ability-item {
      padding: 10px 12px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-color);
    }

    .wealth-grid {
      display: flex;
      gap: 16px;
    }

    .wealth-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--ui-bg-heavy);
      border-radius: 12px;
      flex: 1;
    }

    .wealth-item i {
      font-size: 20px;
      color: var(--primary-color);
    }

    .wealth-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .wealth-label {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .wealth-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .inventory-section {
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .inventory-section h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .inventory-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .inventory-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--ui-bg-heavy);
      border-radius: 8px;
      border: 1px solid var(--ui-border-color);
      transition: all 0.2s ease;
    }

    .inventory-item:hover {
      background: var(--ui-bg-light);
      border-color: var(--primary-color-light);
    }

    .inventory-item-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-color);
      border-radius: 8px;
      color: #fff;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .inventory-item-icon i {
      font-size: 16px;
    }

    .inventory-item-info {
      flex: 1;
      min-width: 0;
    }

    .inventory-item-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 2px;
    }

    .inventory-item-description {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      line-height: 1.3;
    }

    .inventory-item-quantity {
      font-size: 12px;
      color: var(--primary-color);
      font-weight: 600;
      margin-left: 8px;
      flex-shrink: 0;
    }

    .inventory-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-color);
      opacity: 0.6;
    }

    .inventory-empty i {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .inventory-empty p {
      margin: 0;
      font-size: 14px;
    }

    .inventory-container {
      display: flex;
      gap: 20px;
      height: 400px;
    }

    .inventory-grid {
      flex: 2;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
      overflow-y: auto;
    }

    .inventory-grid::-webkit-scrollbar {
      display: none;
    }

    .inventory-grid {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .item-slot {
      width: 60px;
      height: 60px;
      background: var(--ui-bg-heavy);
      border: 2px solid var(--ui-border-color);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .item-slot:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .item-slot.has-item {
      background: var(--primary-color-light);
    }

    .item-details-panel {
      flex: 1;
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .no-item-selected {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-color);
      opacity: 0.6;
    }

    .no-item-selected i {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .no-item-selected p {
      font-size: 14px;
      margin: 0;
    }

    .item-details {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .item-details-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--ui-border-color);
    }

    .item-details-header .item-icon-large {
      width: 48px;
      height: 48px;
      background: var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      flex-shrink: 0;
    }

    .item-details-header .item-basic-info {
      flex: 1;
      min-width: 0;
    }

    .item-details-header .item-basic-info h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-color);
    }

    .item-details-header .item-basic-info .item-type {
      margin: 0;
      font-size: 14px;
      color: var(--primary-color);
      font-weight: 500;
    }

    .item-details-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .item-details-body .item-description h4,
    .item-details-body .item-properties h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-color);
    }

    .item-details-body .item-description p,
    .item-details-body .item-properties p {
      margin: 0;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
      line-height: 1.5;
    }

    .item-details-body .item-description ul,
    .item-details-body .item-properties ul {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .item-details-body .item-description ul li,
    .item-details-body .item-properties ul li {
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
      padding: 4px 0;
    }

    .item-detail-actions {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--ui-border-color);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .item-action-btn {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--ui-border-color);
      border-radius: 8px;
      background: var(--ui-bg);
      color: var(--text-color);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      outline: none;
    }

    .item-action-btn:hover:not(:disabled) {
      border-color: var(--ui-border-color);
      background: var(--ui-bg-light);
      color: var(--text-color);
    }

    .item-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--ui-bg-light);
    }

    .item-action-btn.gift-btn {
      border-color: var(--success-color);
      color: var(--success-color);
      background: rgba(var(--success-color-rgb), 0.1);
    }

    .item-action-btn.gift-btn:hover {
      background: var(--success-color);
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(var(--success-color-rgb), 0.3);
    }

    .item-action-btn.equip-btn {
      border-color: var(--ui-border-color);
      color: var(--text-color);
    }

    .item-action-btn.equip-btn i {
      color: var(--text-color);
    }

    .item-action-btn.equip-btn:hover:not(:disabled) {
      border-color: var(--ui-border-color);
      background: var(--ui-bg-light);
      color: var(--text-color);
    }

    .item-action-btn.discard-btn {
      border-color: var(--danger-color-light);
      color: var(--danger-color);
    }

    .item-action-btn.discard-btn:hover:not(:disabled) {
      border-color: var(--danger-color);
      background: var(--danger-color-light);
    }

    .item-action-btn i {
      font-size: 16px;
      flex-shrink: 0;
    }

    .item-action-btn span {
      flex: 1;
      text-align: left;
    }

    #gift-dialog,
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .gift-dialog-content {
      background: var(--ui-bg-heavy);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
      box-shadow: 0 8px 32px var(--shadow-color-medium);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      animation: slideIn 0.3s ease-out;
    }

    .gift-dialog-content::-webkit-scrollbar {
      display: none;
    }

    .gift-dialog-content {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .gift-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--ui-border-color);
    }

    .gift-dialog-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-color);
    }

    .gift-dialog-header .gift-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--ui-bg);
      border-radius: 8px;
      color: var(--text-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .gift-dialog-header .gift-dialog-close:hover {
      background: var(--danger-color-light);
      color: var(--danger-color);
    }

    .gift-dialog-header .gift-dialog-close i {
      font-size: 14px;
    }

    .gift-dialog-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .gift-dialog-body::-webkit-scrollbar {
      display: none;
    }

    .gift-dialog-body {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .gift-item-info {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--ui-bg);
      border-radius: 12px;
      border: 1px solid var(--ui-border-color);
      margin-bottom: 24px;
    }

    .gift-item-info .gift-item-icon {
      width: 48px;
      height: 48px;
      background: var(--primary-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      flex-shrink: 0;
    }

    .gift-item-info .gift-item-details {
      flex: 1;
    }

    .gift-item-info .gift-item-details h4 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .gift-item-info .gift-item-details p {
      margin: 0;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.7;
    }

    .gift-recipient-selection h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .gift-character-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .gift-character-list::-webkit-scrollbar {
      display: none;
    }

    .gift-character-list {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .gift-character-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--ui-bg);
      border: 2px solid var(--ui-border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .gift-character-option:hover {
      background: var(--ui-bg-light);
      border-color: var(--primary-color-light);
    }

    .gift-character-option.selected {
      background: var(--primary-color-light);
      border-color: var(--primary-color);
    }

    .gift-character-option.selected .gift-character-name {
      color: var(--primary-color);
      font-weight: 600;
    }

    .gift-character-option .gift-character-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      background: var(--ui-bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted-color);
    }

    .gift-character-option .gift-character-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    .gift-character-option .gift-character-avatar i {
      font-size: 20px;
      opacity: 0.8;
    }

    .gift-character-option .gift-character-info {
      flex: 1;
      min-width: 0;
    }

    .gift-character-option .gift-character-info .gift-character-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 2px;
    }

    .gift-character-option .gift-character-info .gift-character-relationship {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.6;
    }

    .gift-dialog-footer {
      display: flex;
      gap: 12px;
      padding: 20px 24px;
      border-top: 1px solid var(--ui-border-color);
      background: var(--ui-bg);
    }

    .gift-dialog-footer .secondary-btn,
    .gift-dialog-footer .primary-btn {
      flex: 1;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
    }

    .gift-dialog-footer .secondary-btn {
      border: 1px solid var(--ui-border-color);
      background: var(--ui-bg);
      color: var(--text-color);
    }

    .gift-dialog-footer .secondary-btn:hover {
      background: var(--ui-bg-light);
      border-color: var(--text-color);
    }

    .gift-dialog-footer .primary-btn {
      border: 1px solid var(--primary-color);
      background: var(--primary-color);
      color: #fff;
    }

    .gift-dialog-footer .primary-btn:hover:not(:disabled) {
      background: var(--primary-color-dark);
      transform: translateY(-1px);
    }

    .gift-dialog-footer .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--ui-bg-light);
      border-color: var(--ui-border-color);
      color: var(--text-color);
      transform: none;
    }

    .equipment-container {
      display: flex;
      gap: 20px;
    }

    .equipment-slots {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .equipment-slot {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--ui-bg-heavy);
      border-radius: 12px;
      border: 2px dashed var(--ui-border-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .equipment-slot:hover {
      border-color: var(--primary-color);
      background: var(--primary-color-light);
    }

    .equipment-slot i {
      font-size: 20px;
      color: var(--text-color);
      opacity: 0.6;
    }

    .equipment-slot span {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 500;
    }

    .equipment-list {
      flex: 1;
      padding: 20px;
      background: var(--ui-bg);
      border-radius: 16px;
      border: 1px solid var(--ui-border-color);
    }

    .status-content {
      display: flex;
      gap: 24px;
      height: 100%;
    }

    .status-left-panel,
    .status-right-panel {
      flex: 1;
    }

    .status-section {
      margin-bottom: 24px;
    }

    .status-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--ui-border-color);
    }

    .status-section p {
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
    }

    .status-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .status-section ul li {
      padding: 8px 0;
      border-bottom: 1px solid var(--ui-border-color);
      font-size: 14px;
    }

    .status-section ul li:last-child {
      border-bottom: none;
    }

    #view-hummingbird .modal-body {
      padding: 0;
      flex-direction: row;
    }

    #contact-list {
      width: 35%;
      border-right: 1px solid var(--ui-border-color);
      overflow-y: auto;
      padding: 24px;
    }

    #contact-list::-webkit-scrollbar {
      display: none;
    }

    #contact-list {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #chat-window {
      width: 65%;
      display: flex;
      flex-direction: column;
    }

    .contact-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .contact-item:hover,
    .contact-item.active {
      background: var(--primary-color-light);
    }

    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      object-position: top;
      transition: all 0.3s ease;
    }

    .contact-avatar[src*='data:image/svg+xml'] {
      background-color: var(--ui-bg-secondary);
      border: 1px solid var(--ui-border-color);
      opacity: 0.8;
    }

    .contact-name {
      font-weight: 600;
    }

    .contact-status {
      font-size: 12px;
      opacity: 0.7;
    }

    #chat-messages {
      flex-grow: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chat-messages::-webkit-scrollbar {
      display: none;
    }

    #chat-messages {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #chat-input {
      display: flex;
      padding: 24px;
      border-top: 1px solid var(--ui-border-color);
    }

    #message-input {
      flex-grow: 1;
      border: none;
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-color);
      padding: 10px;
      border-radius: 15px;
    }

    #message-input:focus {
      outline: none;
    }

    .send-btn {
      background: rgba(0, 0, 0, 0);
      color: var(--primary-color);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .send-btn:hover {
      background: var(--primary-color-light);
      transform: scale(1.05);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .message {
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 80%;
    }

    .message.sent {
      background: var(--primary-color);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .message.received {
      background: var(--ui-bg);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .no-messages,
    .no-contacts {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--text-color);
      opacity: 0.6;
      padding: 40px 20px;
    }

    .no-messages .no-messages-icon,
    .no-messages .no-contacts-icon,
    .no-contacts .no-messages-icon,
    .no-contacts .no-contacts-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .no-messages h4,
    .no-contacts h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .no-messages p,
    .no-contacts p {
      font-size: 14px;
      line-height: 1.4;
      opacity: 0.7;
      margin: 0;
    }

    #item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }

    #item-grid::-webkit-scrollbar {
      display: none;
    }

    #item-grid {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .inventory-item {
      background: var(--ui-bg);
      border: 1px solid var(--ui-border-color);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .inventory-item:hover {
      background: var(--primary-color-light);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .item-icon {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .item-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .item-quantity {
      font-size: 12px;
      opacity: 0.7;
    }

    #item-details {
      width: 300px;
      padding: 24px;
      border-left: 1px solid var(--ui-border-color);
      background: var(--ui-bg);
    }

    #event-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    #event-list::-webkit-scrollbar {
      display: none;
    }

    #event-list {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .memoir-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .memoir-item {
      display: grid;
      grid-template-columns: 44px 1fr;
      align-items: start;
      gap: 12px;
      background: var(--ui-bg);
      border: 1px solid var(--ui-border-color);
      border-radius: 14px;
      padding: 12px 14px;
      transition:
        transform 0.15s ease,
        box-shadow 0.15s ease;
    }

    .memoir-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-color-light);
    }

    .memoir-avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--ui-bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted-color);
      overflow: hidden;
    }

    .memoir-avatar:not(.default) {
      object-fit: contain;
      object-position: center;
      background: none;
    }

    .memoir-avatar.default i {
      font-size: 22px;
      opacity: 0.9;
    }

    .memoir-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .memoir-speaker {
      font-weight: 600;
      color: var(--text-color);
    }

    .memoir-text {
      color: var(--text-color);
      line-height: 1.6;
      white-space: normal;
    }

    .quest-tabs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .tab-btn {
      padding: 8px 16px;
      border: 1px solid var(--ui-border-color);
      background: var(--ui-bg);
      color: var(--text-color);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .tab-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .tab-btn:hover:not(.active) {
      background: var(--primary-color-light);
    }

    .quest-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      gap: 24px;
    }

    #quest-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 24px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #quest-list::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .quest-item {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .quest-item:hover {
      background: var(--primary-color-light);
    }

    .quest-item.selected {
      background: var(--primary-color-light);
    }

    .quest-item .quest-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .quest-item.quest-current .quest-title {
      font-size: 22px;
      font-weight: 700;
      color: #ff9500;
    }

    .quest-title {
      font-size: 16px;
      font-weight: 600;
      flex: 1;
      margin-right: 12px;
    }

    .quest-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 10px;
      display: inline-block;
      white-space: nowrap;
    }

    .quest-status.quest-status-current {
      background: #ff9500;
      color: #fff;
    }

    .quest-status.quest-status-completed {
      background: #34c759;
      color: #fff;
    }

    .quest-description {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.8;
    }

    #quest-details {
      width: 320px;
      padding: 24px;
      border-left: 1px solid var(--ui-border-color);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #quest-details::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    #quest-details .action-suggestions-header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--ui-border-color);
    }

    #quest-details .action-suggestions-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    #quest-details .action-suggestions-header .suggestions-subtitle {
      font-size: 14px;
      color: var(--text-color-secondary);
      opacity: 0.8;
    }

    #quest-details .action-suggestions-list {
      display: flex;
      flex-direction: column;
    }

    #quest-details .action-suggestion-item {
      padding: 12px 0;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--ui-border-color);
    }

    #quest-details .action-suggestion-item:last-child {
      border-bottom: none;
    }

    #quest-details .action-suggestion-item:hover {
      background: var(--primary-color-light);
      padding-left: 8px;
      padding-right: 8px;
      border-radius: 4px;
    }

    #quest-details .action-suggestion-item.clicked {
      transform: scale(0.99);
      transition: transform 0.1s ease;
    }

    #quest-details .action-suggestion-item .suggestion-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-color);
      font-weight: 500;
    }

    #quest-details .no-suggestions {
      text-align: center;
      padding: 48px 16px;
      color: var(--text-color-secondary);
    }

    #quest-details .no-suggestions h4 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    #quest-details .no-suggestions p {
      font-size: 14px;
      opacity: 0.7;
      line-height: 1.4;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .choice-container {
      position: absolute;
      bottom: 120px;
      left: 20px;
      right: 20px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      min-height: auto;
      overflow: visible;
      animation: choiceSlideIn 0.3s ease-out;
    }

    @keyframes choiceSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .choice-btn {
      padding: 12px 20px;
      border: 1px solid var(--ui-border-color);
      background: var(--ui-bg-heavy);
      color: var(--text-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-size: 14px;
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      box-shadow: 0 4px 16px var(--shadow-color-light);
    }

    .choice-btn:hover:not(.disabled) {
      background: var(--primary-color-light);
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-color-medium);
    }

    .choice-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--ui-bg-light);
      border-color: var(--ui-border-color);
    }

    .choice-prompt {
      color: var(--primary-color);
      font-style: italic;
      opacity: 0.8;
      animation: choicePromptPulse 2s ease-in-out infinite;
    }

    @keyframes choicePromptPulse {
      0%,
      100% {
        opacity: 0.8;
      }

      50% {
        opacity: 1;
      }
    }

    .control-btn.choice-ready {
      background: var(--primary-color) !important;
      color: #fff !important;
      animation: choiceButtonPulse 1.5s ease-in-out infinite;
      box-shadow: 0 0 15px var(--shadow-color-light);
    }

    @keyframes choiceButtonPulse {
      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 15px var(--shadow-color-light);
      }

      50% {
        transform: scale(1.05);
        box-shadow: 0 0 20px var(--shadow-color-medium);
      }
    }

    .dialogue-choices {
      margin-top: 15px;
    }

    .dialogue-choices .choice-prompt {
      color: var(--primary-color);
      font-weight: 500;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .dialogue-choice-item {
      margin-bottom: 8px;
    }

    .dialogue-choice-btn {
      width: 100%;
      padding: 12px 40px 12px 16px;
      border: 1px solid var(--ui-border-color);
      background: var(--ui-bg-light);
      color: var(--text-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      font-size: 14px;
      backdrop-filter: blur(var(--blur-intensity));
      -webkit-backdrop-filter: blur(var(--blur-intensity));
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dialogue-choice-btn:hover {
      background: var(--primary-color-light);
      border-color: var(--primary-color);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-color-light);
    }

    .dialogue-choice-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px var(--shadow-color-light);
    }

    .dialogue-choice-btn .choice-text {
      flex: 1;
      cursor: pointer;
    }

    .choice-quick-send-btn {
      width: 28px;
      height: 28px;
      border: 1px solid var(--ui-border-color);
      background: #fff;
      color: #333;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-left: 8px;
    }

    .choice-quick-send-btn:hover {
      background: #f8f9fa;
      color: var(--primary-color);
      border-color: var(--primary-color);
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .choice-quick-send-btn:active {
      transform: scale(0.95);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .choice-quick-send-btn i {
      font-size: 11px;
    }

    .contact-avatar-container {
      position: relative;
      display: inline-block;
    }

    .contact-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      object-position: top;
      transition: all 0.3s ease;
    }

    .contact-avatar[src*='data:image/svg+xml'] {
      background-color: var(--ui-bg-secondary);
      border: 1px solid var(--ui-border-color);
      opacity: 0.8;
    }

    .unread-indicator {
      position: absolute;
      top: -5px;
      right: 5px;
      background: #ff3b30;
      color: #fff;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(255, 59, 48, 0.3);
      z-index: 10;
    }

    .unread-indicator.pulse {
      animation: pulse-notification 0.6s ease-out;
    }

    @keyframes pulse-notification {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .contact-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .contact-item:hover,
    .contact-item.active {
      background: var(--primary-color-light);
    }

    .contact-item .contact-avatar-container {
      margin-right: 0;
    }

    #view-commands .modal-header h2 {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #view-commands .modal-header h2 #commands-count {
      color: var(--primary-color);
      font-weight: 700;
    }

    #view-commands .commands-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 20px;
    }

    #view-commands .commands-controls {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-bottom: 1px solid var(--ui-border-color);
      background: var(--ui-bg-secondary);
      border-radius: 8px;
    }

    #view-commands .commands-controls .primary-btn,
    #view-commands .commands-controls .secondary-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #view-commands .commands-controls .primary-btn i,
    #view-commands .commands-controls .secondary-btn i {
      font-size: 14px;
    }

    #view-commands .commands-controls .primary-btn:disabled,
    #view-commands .commands-controls .secondary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    #view-commands .commands-controls .primary-btn {
      background: var(--primary-color);
      color: #fff;
    }

    #view-commands .commands-controls .primary-btn:hover:not(:disabled) {
      background: var(--primary-color-light);
      transform: translateY(-1px);
    }

    #view-commands .commands-controls .secondary-btn {
      background: var(--ui-bg);
      color: var(--text-color);
      border: 1px solid var(--ui-border-color);
    }

    #view-commands .commands-controls .secondary-btn:hover:not(:disabled) {
      background: var(--ui-bg-secondary);
      transform: translateY(-1px);
    }

    #view-commands .commands-list-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0 4px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #view-commands .commands-list-container::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    #view-commands .commands-help-icon {
      text-align: center;
      padding: 8px;
    }

    #view-commands .commands-help-icon i {
      font-size: 20px;
      color: var(--text-color-secondary);
      cursor: help;
      transition: color 0.3s ease;
    }

    #view-commands .commands-help-icon i:hover {
      color: var(--primary-color);
    }

    .command-item {
      padding: 16px;
      margin-bottom: 12px;
      background: var(--ui-bg);
      border: 1px solid var(--ui-border-color);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .command-item:hover {
      border-color: var(--primary-color-light);
      box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.1);
    }

    .command-item .command-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .command-item .command-header .command-type {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .command-item .command-header .command-type i {
      color: var(--primary-color);
      font-size: 14px;
    }

    .command-item .command-header .command-type .type-label {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .command-item .command-header .command-time {
      font-size: 12px;
      color: var(--text-color-secondary);
      opacity: 0.7;
    }

    .command-item .command-header .remove-command-btn {
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0);
      border: none;
      color: var(--text-color-secondary);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .command-item .command-header .remove-command-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .command-item .command-header .remove-command-btn i {
      font-size: 12px;
    }

    .command-item .command-content {
      background: var(--ui-bg-secondary);
      padding: 12px;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-color);
      border-left: 3px solid var(--primary-color-light);
      word-break: break-all;
    }

    .command-item .command-meta {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-color-secondary);
      padding: 6px 8px;
      background: var(--ui-bg-secondary);
      border-radius: 4px;
    }

    .command-item .command-meta i {
      color: var(--primary-color);
      font-size: 11px;
    }

    .no-commands {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
      color: var(--text-color-secondary);
    }

    .no-commands .no-commands-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .no-commands h4 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .no-commands p {
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.8;
    }

    .command-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 16px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
      z-index: 10;
      animation: badge-appear 0.3s ease-out;
    }

    @keyframes badge-appear {
      0% {
        transform: scale(0);
        opacity: 0;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .dialogue-bottom-controls {
      display: flex;
      align-items: center;
      margin-top: 16px;
      gap: 16px;
    }

    .player-choice-input {
      flex: 1;
    }

    .player-choice-input .choice-input-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--ui-bg);
      border: 1px solid var(--ui-border-color);
      border-radius: 6px;
      padding: 8px 12px;
    }

    .player-choice-input .choice-input-controls .choice-input-icon {
      color: #fff;
      font-size: 14px;
      flex-shrink: 0;
    }

    .player-choice-input .choice-input-controls #choice-text-input {
      flex-grow: 1;
      padding: 6px 8px;
      border: none;
      background: rgba(0, 0, 0, 0);
      color: var(--text-color);
      font-size: 14px;
      outline: none;
    }

    .player-choice-input .choice-input-controls #choice-text-input::placeholder {
      color: var(--text-color-secondary);
      opacity: 0.7;
    }

    .player-choice-input .choice-input-controls .choice-add-btn {
      width: 32px;
      height: 32px;
      background: rgba(0, 0, 0, 0);
      color: var(--text-color);
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .player-choice-input .choice-input-controls .choice-add-btn:hover {
      color: var(--primary-color);
      transform: scale(1.2);
    }

    .player-choice-input .choice-input-controls .choice-add-btn:active {
      transform: scale(1);
    }

    .player-choice-input .choice-input-controls .choice-add-btn.clicked {
      color: #34d399;
      transform: scale(1.1);
    }

    .player-choice-input .choice-input-controls .choice-add-btn i {
      font-size: 16px;
    }

    .map-point.clicked {
      background: linear-gradient(135deg, #34d399, #10b981) !important;
      transform: translate(-50%, -50%) scale(1.2) !important;
      box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4) !important;
      animation: point-clicked 0.3s ease-out;
    }

    @keyframes point-clicked {
      0% {
        transform: translate(-50%, -50%) scale(1);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.3);
      }

      100% {
        transform: translate(-50%, -50%) scale(1.2);
      }
    }

    .character-sprite.dynamic.character-shake.pos-left {
      animation: characterShakeLeft 0.6s ease-in-out !important;
    }

    .character-sprite.dynamic.character-shake.pos-center {
      animation: characterShakeCenter 0.6s ease-in-out !important;
    }

    .character-sprite.dynamic.character-shake.pos-right {
      animation: characterShakeRight 0.6s ease-in-out;
    }

    .character-sprite.dynamic.character-shake.pos-three-left {
      animation: characterShakeThreeLeft 0.6s ease-in-out;
    }

    .character-sprite.dynamic.character-shake.pos-three-center {
      animation: characterShakeThreeCenter 0.6s ease-in-out;
    }

    .character-sprite.dynamic.character-shake.pos-three-right {
      animation: characterShakeThreeRight 0.6s ease-in-out;
    }

    @keyframes characterShakeLeft {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    @keyframes characterShakeCenter {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    @keyframes characterShakeRight {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    @keyframes characterShakeThreeLeft {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    @keyframes characterShakeThreeCenter {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    @keyframes characterShakeThreeRight {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translateX(-50%) translateY(-30%) translateX(-5px);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translateX(-50%) translateY(-30%) translateX(5px);
      }
    }

    .character-sprite.dynamic.character-jump-up.pos-left,
    .character-sprite.dynamic.character-jump-up.pos-center,
    .character-sprite.dynamic.character-jump-up.pos-right,
    .character-sprite.dynamic.character-jump-up.pos-three-left,
    .character-sprite.dynamic.character-jump-up.pos-three-center,
    .character-sprite.dynamic.character-jump-up.pos-three-right {
      animation: characterJumpUp 0.4s ease-out;
    }

    @keyframes characterJumpUp {
      0% {
        transform: translateX(-50%) translateY(-30%);
      }

      50% {
        transform: translateX(-50%) translateY(-30%) translateY(-25px);
      }

      100% {
        transform: translateX(-50%) translateY(-30%);
      }
    }

    .character-sprite.dynamic.character-jump-down.pos-left,
    .character-sprite.dynamic.character-jump-down.pos-center,
    .character-sprite.dynamic.character-jump-down.pos-right,
    .character-sprite.dynamic.character-jump-down.pos-three-left,
    .character-sprite.dynamic.character-jump-down.pos-three-center,
    .character-sprite.dynamic.character-jump-down.pos-three-right {
      animation: characterJumpDown 0.4s ease-out;
    }

    @keyframes characterJumpDown {
      0% {
        transform: translateX(-50%) translateY(-30%);
      }

      50% {
        transform: translateX(-50%) translateY(-30%) translateY(15px);
      }

      100% {
        transform: translateX(-50%) translateY(-30%);
      }
    }

    .character-sprite.dynamic.character-tilt.pos-left,
    .character-sprite.dynamic.character-tilt.pos-center,
    .character-sprite.dynamic.character-tilt.pos-right,
    .character-sprite.dynamic.character-tilt.pos-three-left,
    .character-sprite.dynamic.character-tilt.pos-three-center,
    .character-sprite.dynamic.character-tilt.pos-three-right {
      animation: characterTilt 0.8s ease-in-out;
    }

    @keyframes characterTilt {
      0% {
        transform: translateX(-50%) translateY(-30%) rotate(0deg);
      }

      25% {
        transform: translateX(-50%) translateY(-30%) rotate(-4deg);
      }

      75% {
        transform: translateX(-50%) translateY(-30%) rotate(4deg);
      }

      100% {
        transform: translateX(-50%) translateY(-30%) rotate(0deg);
      }
    }

    .character-sprite.dynamic.character-shake,
    .character-sprite.dynamic.character-jump-up,
    .character-sprite.dynamic.character-jump-down,
    .character-sprite.dynamic.character-tilt {
      pointer-events: none;
      z-index: inherit;
    }

    .character-sprite.dynamic.breathing-natural.pos-left,
    .character-sprite.dynamic.breathing-natural.pos-center,
    .character-sprite.dynamic.breathing-natural.pos-right,
    .character-sprite.dynamic.breathing-natural.pos-three-left,
    .character-sprite.dynamic.breathing-natural.pos-three-center,
    .character-sprite.dynamic.breathing-natural.pos-three-right {
      animation: naturalBreathing 4.2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .character-sprite.dynamic.breathing-sway.pos-left,
    .character-sprite.dynamic.breathing-sway.pos-center,
    .character-sprite.dynamic.breathing-sway.pos-right,
    .character-sprite.dynamic.breathing-sway.pos-three-left,
    .character-sprite.dynamic.breathing-sway.pos-three-center,
    .character-sprite.dynamic.breathing-sway.pos-three-right {
      animation: gentleSway 6.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
    }

    .character-sprite.dynamic.breathing-pulse.pos-left,
    .character-sprite.dynamic.breathing-pulse.pos-center,
    .character-sprite.dynamic.breathing-pulse.pos-right,
    .character-sprite.dynamic.breathing-pulse.pos-three-left,
    .character-sprite.dynamic.breathing-pulse.pos-three-center,
    .character-sprite.dynamic.breathing-pulse.pos-three-right {
      animation: vitalPulse 3.8s ease-in-out infinite;
    }

    .character-sprite.dynamic.breathing-natural.pos-left,
    .character-sprite.dynamic.breathing-natural.pos-center,
    .character-sprite.dynamic.breathing-natural.pos-right,
    .character-sprite.dynamic.breathing-natural.pos-three-left,
    .character-sprite.dynamic.breathing-natural.pos-three-center,
    .character-sprite.dynamic.breathing-natural.pos-three-right {
      animation: naturalBreathingRealistic 4s ease-out infinite;
    }

    .character-sprite.dynamic.breathing-rhythmic.pos-left,
    .character-sprite.dynamic.breathing-rhythmic.pos-center,
    .character-sprite.dynamic.breathing-rhythmic.pos-right,
    .character-sprite.dynamic.breathing-rhythmic.pos-three-left,
    .character-sprite.dynamic.breathing-rhythmic.pos-three-center,
    .character-sprite.dynamic.breathing-rhythmic.pos-three-right {
      animation: rhythmicBreathing 2.4s linear infinite;
    }

    @keyframes naturalBreathing {
      0% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }

      25% {
        transform: translateX(-50%) translateY(calc(-30% - 1px)) scale(1.002);
      }

      35% {
        transform: translateX(-50%) translateY(calc(-30% - 1.2px)) scale(1.003);
      }

      75% {
        transform: translateX(-50%) translateY(calc(-30% + 0.8px)) scale(0.999);
      }

      100% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }
    }

    @keyframes gentleSway {
      0% {
        transform: translateX(-50%) translateY(-30%);
      }

      25% {
        transform: translateX(calc(-50% + 0.8px)) translateY(calc(-30% - 0.3px));
      }

      50% {
        transform: translateX(calc(-50% + 0.2px)) translateY(calc(-30% + 0.5px));
      }

      75% {
        transform: translateX(calc(-50% - 0.6px)) translateY(calc(-30% - 0.2px));
      }

      100% {
        transform: translateX(-50%) translateY(-30%);
      }
    }

    @keyframes vitalPulse {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }

      20% {
        transform: translateX(-50%) translateY(-30%) scale(1.001);
      }

      50% {
        transform: translateX(-50%) translateY(-30%) scale(1.004);
      }

      80% {
        transform: translateX(-50%) translateY(-30%) scale(1.001);
      }
    }

    @keyframes naturalBreathingRealistic {
      0% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }

      15% {
        transform: translateX(-50%) translateY(calc(-30% - 0.3px)) scale(1.0008);
      }

      33% {
        transform: translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015);
      }

      40% {
        transform: translateX(-50%) translateY(calc(-30% - 0.6px)) scale(1.0015);
      }

      70% {
        transform: translateX(-50%) translateY(calc(-30% - 0.2px)) scale(1.0005);
      }

      100% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }
    }

    @keyframes rhythmicBreathing {
      0%,
      100% {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }

      50% {
        transform: translateX(-50%) translateY(calc(-30% + 1px)) scale(1.002);
      }
    }

    .character-sprite.dynamic[class*='breathing-'] {
      pointer-events: auto;
      z-index: inherit;
      will-change: transform;
      backface-visibility: hidden;
      transform-style: preserve-3d;
    }

    @media (prefers-reduced-motion: reduce) {
      .character-sprite.dynamic[class*='breathing-'] {
        animation-duration: 8s !important;
        animation-timing-function: linear !important;
      }

      @keyframes naturalBreathingRealistic {
        0%,
        100% {
          transform: translateX(-50%) translateY(-30%) scale(1);
        }

        33% {
          transform: translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003);
        }

        40% {
          transform: translateX(-50%) translateY(calc(-30% - 0.15px)) scale(1.0003);
        }
      }
    }

    .modern-select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid var(--border-color, #333);
      border-radius: 8px;
      background: var(--input-bg, #2a2a2a);
      color: var(--text-color, #f5f5f7);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f7' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 16px;
      padding-right: 36px;
    }

    .modern-select:hover {
      border-color: var(--accent-color, #007aff);
      background-color: var(--input-hover-bg, #333);
    }

    .modern-select:focus {
      outline: none;
      border-color: var(--accent-color, #007aff);
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
    }

    .modern-select option {
      background: var(--input-bg, #2a2a2a);
      color: var(--text-color, #f5f5f7);
      padding: 8px;
    }

    .slider-container {
      width: 100%;
    }

    .slider-container .modern-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--slider-track-bg, #333);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .slider-container .modern-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-color, #007aff);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      -webkit-transition: all 0.3s ease;
      transition: all 0.3s ease;
    }

    .slider-container .modern-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    .slider-container .modern-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-color, #007aff);
      cursor: pointer;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      -moz-transition: all 0.3s ease;
      transition: all 0.3s ease;
    }

    .slider-container .modern-slider::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }

    .slider-container .modern-slider::-webkit-slider-track {
      height: 6px;
      border-radius: 3px;
      background: var(--slider-track-bg, #333);
    }

    .slider-container .modern-slider::-moz-range-track {
      height: 6px;
      border-radius: 3px;
      background: var(--slider-track-bg, #333);
      border: none;
    }

    .slider-container .slider-labels {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-secondary, #888);
    }

    .slider-container .slider-labels span:nth-child(2) {
      font-weight: 600;
      color: var(--accent-color, #007aff);
      background: var(--accent-bg, rgba(0, 122, 255, 0.1));
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    [data-theme='light'] .modern-select {
      --input-bg: #f8f9fa;
      --input-hover-bg: #e9ecef;
      --border-color: #dee2e6;
      --text-color: #212529;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23212529' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    }

    [data-theme='light'] .modern-select option {
      background: #f8f9fa;
      color: #212529;
    }

    [data-theme='light'] .modern-slider {
      --slider-track-bg: #dee2e6;
    }

    [data-theme='glass'] .modern-select {
      --input-bg: rgba(255, 255, 255, 0.1);
      --input-hover-bg: rgba(255, 255, 255, 0.15);
      --border-color: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }

    [data-theme='glass'] .modern-select option {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }

    [data-theme='glass'] .modern-slider {
      --slider-track-bg: rgba(255, 255, 255, 0.2);
    }

    .reset-setting-item {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px 0;
    }

    .reset-setting-item .setting-control {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .reset-btn {
      background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-width: 100px;
    }

    .reset-btn:hover {
      background: linear-gradient(135deg, var(--accent-color-dark), var(--accent-color));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .reset-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .reset-btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.3);
    }

    #stat-toast-container {
      position: fixed;
      top: 12px;
      left: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 9999;
      pointer-events: none;
    }

    .stat-toast {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--ui-bg-heavy, rgba(28, 28, 30, 0.9));
      color: var(--text-color, #fff);
      border: 1px solid var(--ui-border-color, rgba(255, 255, 255, 0.12));
      border-radius: 10px;
      padding: 6px 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      font-size: 13px;
      line-height: 1.2;
      opacity: 1;
      transform: translateY(0);
      transition:
        opacity 0.35s ease,
        transform 0.35s ease;
    }

    .stat-toast i {
      font-size: 14px;
      opacity: 0.9;
    }

    .stat-toast .label {
      opacity: 0.85;
    }

    .stat-toast .delta {
      font-weight: 700;
    }

    .stat-toast.gain .delta {
      color: #34c759;
    }

    .stat-toast.loss .delta {
      color: #ff3b30;
    }

    .stat-toast.fade-out {
      opacity: 0;
      transform: translateY(-6px);
    }
  </style>
</head>
<body data-theme="dark">
  <div id="app-container">
    <main id="content-area">
      <div id="view-novel" class="view-container active">
        <div id="background-overlay" class="background-overlay"></div>
        <div class="character-layer">
          <div class="character-container">
            <div class="character-hover-trigger"></div>
            <img id="character-sprite" class="character-sprite old-sprite" style="display: none !important" />
            <div class="character-status-tooltip">
              <div class="status-tooltip-header">
                <h3 class="character-fullname" id="character-fullname"></h3>
                <p class="character-affiliation" id="character-affiliation"></p>
              </div>
              <div class="status-tooltip-divider"></div>
              <div class="status-tooltip-body" id="status-tooltip-body"></div>
              <div class="status-tooltip-divider"></div>
              <div class="status-tooltip-footer" id="status-tooltip-footer"></div>
            </div>
          </div>
        </div>
        <div class="cg-layer" id="cg-layer">
          <img id="cg-image" class="cg-image" alt="CG" />
        </div>
        <div class="ui-layer">
          <div class="top-header-container">
            <div class="top-bar">
              <div class="game-info">
                <span class="game-date">
                  <i class="fas fa-calendar-alt"></i>
                  <span id="current-date"></span>
                </span>
                <span class="game-time-period">
                  <i class="fas fa-clock"></i>
                  <span id="current-time-period"></span>
                </span>
                <span class="game-location">
                  <i class="fas fa-map-marker-alt"></i>
                  <span id="current-location"></span>
                </span>
              </div>
              <div class="money-display">
                <span class="money-item" title="通用货币：里拉">
                  <i class="fas fa-coins"></i>
                  <span id="player-money"></span>
                </span>
              </div>
            </div>
            <nav id="main-nav">
              <button class="nav-btn" data-view="status">
                <div class="nav-icon">
                  <i class="fas fa-user-circle"></i>
                </div>
                <span class="nav-text">状态</span>
              </button>
              <button class="nav-btn" data-view="hummingbird">
                <div class="nav-icon">
                  <i class="fas fa-comments"></i>
                </div>
                <span class="nav-text">蜂鸟</span>
              </button>
              <button class="nav-btn" data-view="map">
                <div class="nav-icon">
                  <i class="fas fa-map"></i>
                </div>
                <span class="nav-text">地图</span>
              </button>
              <button class="nav-btn" data-view="memoir">
                <div class="nav-icon">
                  <i class="fas fa-journal-whills"></i>
                </div>
                <span class="nav-text">回忆录</span>
              </button>
              <button class="nav-btn" data-view="quests">
                <div class="nav-icon">
                  <i class="fas fa-tasks"></i>
                </div>
                <span class="nav-text">任务</span>
              </button>
              <button class="nav-btn" data-view="newspaper">
                <div class="nav-icon">
                  <i class="fas fa-newspaper"></i>
                </div>
                <span class="nav-text">报纸</span>
              </button>
              <button class="nav-btn" data-view="commands">
                <div class="nav-icon">
                  <i class="fas fa-list-alt"></i>
                </div>
                <span class="nav-text">行动</span>
              </button>
              <button class="nav-btn" id="settings-btn">
                <div class="nav-icon">
                  <i class="fas fa-cog"></i>
                </div>
                <span class="nav-text">设置</span>
              </button>
            </nav>
          </div>
          <div id="hover-info-bar" class="hover-info-bar">
            <div class="hover-info-trigger">
              <div class="bgm-indicator">
                <i class="fas fa-music"></i>
                <span class="bgm-status" id="bgm-status">无</span>
              </div>
              <div class="suggestions-indicator">
                <i class="fas fa-lightbulb"></i>
                <span class="suggestions-count" id="suggestions-count">0</span>
              </div>
            </div>
            <div class="hover-info-expanded">
              <div class="hover-info-section bgm-section">
                <div class="section-header">
                  <i class="fas fa-music"></i>
                  <span>正在播放</span>
                </div>
                <div class="section-content">
                  <div class="current-bgm" id="current-bgm-name">暂无音乐</div>
                </div>
              </div>
              <div class="hover-info-section quest-section">
                <div class="section-header">
                  <i class="fas fa-flag"></i>
                  <span>当前任务</span>
                </div>
                <div class="section-content">
                  <div class="current-quest-mini" id="current-quest-mini"></div>
                </div>
              </div>
              <div class="hover-info-section suggestions-section">
                <div class="section-header">
                  <i class="fas fa-lightbulb"></i>
                  <span>行动建议</span>
                </div>
                <div class="section-content">
                  <div class="action-suggestions-mini" id="action-suggestions-mini"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="dialogue-box">
            <div class="character-name" id="speaker-name"></div>
            <p class="dialogue-text" id="dialogue-content"></p>
            <div class="dialogue-bottom-controls">
              <div class="player-choice-input" id="player-choice-input" style="display: none">
                <div class="choice-input-controls">
                  <i class="fas fa-comment-dots choice-input-icon"></i>
                  <input id="choice-text-input" placeholder="输入你想要说的话或采取的行动..." />
                  <button id="add-choice-btn" class="choice-add-btn">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
              <div class="dialogue-controls">
                <button class="control-btn" id="prev-btn">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="control-btn" id="next-btn">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div id="modal-container" class="modal-view-container">
      <div class="modal-content">
        <button id="modal-close-btn" class="modal-close-btn">
          <i class="fas fa-times"></i>
        </button>
        <div id="view-status" class="view-container">
          <div class="modal-header">
            <div class="panel-tabs rpg-tabs">
              <button class="tab-btn active" data-tab="overview">
                <i class="fas fa-user-circle"></i>
                <span>概览</span>
              </button>
              <button class="tab-btn" data-tab="inventory">
                <i class="fas fa-bag-shopping"></i>
                <span>背包</span>
              </button>
            </div>
          </div>
          <div class="modal-body">
            <div id="tab-overview" class="tab-content active">
              <div class="character-overview-new">
                <div class="top-info-row">
                  <div class="character-card-expanded">
                    <div class="character-avatar user-avatar" id="user-avatar"></div>
                    <div class="character-info-expanded">
                      <h3 class="character-name" id="player-name">用户</h3>
                      <div class="character-stats-expanded">
                        <div class="stat-compact">
                          <span class="stat-label-compact">位阶</span>
                          <span class="stat-value-compact" id="status-rank">--</span>
                        </div>
                        <div class="stat-compact">
                          <span class="stat-label-compact">物品</span>
                          <span class="stat-value-compact" id="inventory-count">--</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="wealth-section-narrow">
                    <h4>财富</h4>
                    <div class="wealth-items-narrow">
                      <div class="wealth-item-narrow">
                        <i class="fas fa-coins"></i>
                        <div>
                          <span class="wealth-label-narrow">里拉(R)</span>
                          <span class="wealth-value-narrow" id="player-lira">--</span>
                        </div>
                      </div>
                      <div class="wealth-item-narrow">
                        <i class="fas fa-gem"></i>
                        <div>
                          <span class="wealth-label-narrow">白金币</span>
                          <span class="wealth-value-narrow" id="player-platinum">--</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="rpg-content-grid">
                  <div class="rpg-section abilities-section">
                    <div class="rpg-card">
                      <div class="card-header">
                        <i class="fas fa-magic"></i>
                        <h4>技能</h4>
                      </div>
                      <ul class="ability-list-compact" id="status-skills"></ul>
                    </div>
                    <div class="rpg-card">
                      <div class="card-header">
                        <i class="fas fa-star"></i>
                        <h4>祝福</h4>
                      </div>
                      <ul class="ability-list-compact" id="status-blessings"></ul>
                    </div>
                  </div>
                  <div class="rpg-section equipment-titles-section">
                    <div class="rpg-card">
                      <div class="card-header">
                        <i class="fas fa-shield-alt"></i>
                        <h4>当前装备</h4>
                      </div>
                      <div class="equipment-preview-detailed" id="equipment-preview"></div>
                    </div>
                    <div class="rpg-card">
                      <div class="card-header">
                        <i class="fas fa-crown"></i>
                        <h4>称号</h4>
                      </div>
                      <ul class="ability-list-compact" id="status-titles"></ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-inventory" class="tab-content">
              <div class="rpg-inventory-container">
                <div class="inventory-header">
                  <div class="inventory-stats">
                    <span class="inventory-count"> 物品数量: <span id="inventory-total">0</span> </span>
                  </div>
                  <div class="inventory-sorting">
                    <label for="inventory-sort-select">排序:</label>
                    <select id="inventory-sort-select" class="sort-select">
                      <option value="default">默认</option>
                      <option value="name">名称</option>
                      <option value="type">类型</option>
                      <option value="quantity">数量</option>
                    </select>
                    <button id="inventory-sort-order" class="sort-order-btn" data-order="asc" title="排序方向">
                      <i class="fas fa-sort-amount-down"></i>
                    </button>
                  </div>
                </div>
                <div class="inventory-content">
                  <div class="inventory-grid-container">
                    <div class="inventory-grid" id="inventory-grid"></div>
                  </div>
                  <div class="item-details-panel" id="item-details-panel">
                    <div class="no-item-selected">
                      <i class="fas fa-mouse-pointer"></i>
                      <p>点击物品查看详情</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="view-hummingbird" class="view-container">
          <div class="modal-header">
            <h2>蜂鸟</h2>
          </div>
          <div class="modal-body">
            <div id="contact-list"></div>
            <div id="chat-window">
              <div id="chat-messages"></div>
              <div id="chat-input">
                <input id="message-input" placeholder="输入消息..." />
                <button class="send-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            <div id="hummingbird-character-tooltip" class="character-status-tooltip hummingbird-tooltip">
              <div class="status-tooltip-header">
                <h3 class="character-fullname" id="hb-character-fullname"></h3>
                <p class="character-affiliation" id="hb-character-affiliation"></p>
              </div>
              <div class="status-tooltip-divider"></div>
              <div class="status-tooltip-body" id="hb-status-tooltip-body"></div>
              <div class="status-tooltip-divider"></div>
              <div class="status-tooltip-footer" id="hb-status-tooltip-footer"></div>
            </div>
          </div>
        </div>
        <div id="view-map" class="view-container">
          <div class="modal-body">
            <div class="map-controls">
              <div class="segmented-control" id="map-selector">
                <button class="sg-btn active" data-map="demonRealm">魔界</button>
                <button class="sg-btn" data-map="humanRealm">人界</button>
              </div>
            </div>
            <div class="map-canvas">
              <img alt="世界地图" class="map-image" id="map-image" />
            </div>
            <div id="map-tooltip"></div>
          </div>
        </div>
        <div id="view-memoir" class="view-container">
          <div class="modal-header">
            <h2>回忆录</h2>
          </div>
          <div class="modal-body">
            <div id="event-list"></div>
            <div id="event-details"></div>
          </div>
        </div>
        <div id="view-quests" class="view-container">
          <div class="modal-header">
            <h2>任务与成就</h2>
            <div class="quest-tabs">
              <button class="tab-btn active" data-tab="main">主线任务</button>
              <button class="tab-btn" data-tab="side">支线任务</button>
              <button class="tab-btn" data-tab="achievements">解锁成就</button>
            </div>
          </div>
          <div class="modal-body">
            <div class="quest-content">
              <div id="quest-list"></div>
              <div id="quest-details"></div>
            </div>
          </div>
        </div>
        <div id="view-newspaper" class="view-container">
          <div class="modal-body">
            <button id="update-newspaper-btn" class="floating-update-btn" title="更新报纸">
              <i class="fas fa-sync-alt"></i>
            </button>
            <div class="newspaper-container">
              <div class="newspaper-background">
                <img alt="阴影层" class="newspaper-shadow-image" id="newspaper-shadow-image" />
                <img alt="报纸背景" class="newspaper-bg-image" id="newspaper-bg-image" />
                <div class="newspaper-content">
                  <div class="newspaper-header">
                    <h2 class="newspaper-name" id="newspaper-name">三界日报</h2>
                  </div>
                  <div class="newspaper-headline">
                    <h1 class="main-headline" id="main-headline"></h1>
                  </div>
                  <div class="newspaper-main-news">
                    <div class="news-column left-column" id="left-column"></div>
                    <div class="news-column right-column" id="right-column"></div>
                  </div>
                  <div class="newspaper-ads" id="newspaper-ads"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="view-commands" class="view-container">
          <div class="modal-header">
            <h2>
              行动计划 (<span id="commands-count">0</span>
              )
            </h2>
          </div>
          <div class="modal-body">
            <div class="commands-content">
              <div class="commands-controls">
                <button id="send-all-commands" class="primary-btn" disabled="disabled">
                  <i class="fas fa-play"></i>
                  执行所有行动
                </button>
                <button id="clear-all-commands" class="secondary-btn" disabled="disabled">
                  <i class="fas fa-trash"></i>
                  清空计划
                </button>
              </div>
              <div class="commands-list-container">
                <div id="pending-commands-list"></div>
              </div>
              <div class="commands-help-icon">
                <i
                  class="fas fa-question-circle"
                  title="如何制定行动？&#10;• 在地图上点击地点&#10;• 在选择界面输入文字&#10;• 通过蜂鸟发送消息"
                ></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="settings-menu" class="settings-popover">
      <div class="settings-section">
        <label>主题切换</label>
        <div class="theme-buttons-container">
          <button data-theme="light" class="theme-btn" title="浅色主题">
            <i class="fas fa-sun"></i>
          </button>
          <button data-theme="dark" class="theme-btn active" title="深色主题">
            <i class="fas fa-moon"></i>
          </button>
          <button data-theme="glass" class="theme-btn" title="毛玻璃">
            <i class="fas fa-layer-group"></i>
          </button>
        </div>
      </div>
      <div class="settings-section visual-effects-section">
        <div class="section-header">
          <i class="fas fa-magic"></i>
          <label class="section-title">视觉音效</label>
        </div>
        <div class="settings-options">
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-lungs"></i>
                角色呼吸效果
              </div>
              <div class="setting-description">为角色立绘添加微妙的呼吸动画效果</div>
            </div>
            <div class="setting-control">
              <label class="modern-toggle">
                <input type="checkbox" id="breathing-toggle" checked="checked" />
                <div class="toggle-track">
                  <div class="toggle-thumb">
                    <i class="toggle-icon fas fa-check"></i>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-map-pin"></i>
                悬浮信息条位置
              </div>
              <div class="setting-description">选择悬浮信息条的显示位置</div>
            </div>
            <div class="setting-control">
              <select id="hover-bar-position" class="modern-select">
                <option value="top-right">右上角</option>
                <option value="top-left">左上角</option>
                <option value="hidden">隐藏</option>
              </select>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-keyboard"></i>
                键盘快捷键
              </div>
              <div class="setting-description">空格/方向键推进对话</div>
            </div>
            <div class="setting-control">
              <label class="modern-toggle">
                <input type="checkbox" id="keyboard-shortcuts-toggle" />
                <div class="toggle-track">
                  <div class="toggle-thumb">
                    <i class="toggle-icon fas fa-check"></i>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-expand"></i>
                双击全屏
              </div>
              <div class="setting-description">双击空白区域进入全屏模式</div>
            </div>
            <div class="setting-control">
              <label class="modern-toggle">
                <input type="checkbox" id="fullscreen-toggle" />
                <div class="toggle-track">
                  <div class="toggle-thumb">
                    <i class="toggle-icon fas fa-check"></i>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-volume-up"></i>
                背景音乐
              </div>
              <div class="setting-description">控制游戏背景音乐的播放</div>
            </div>
            <div class="setting-control">
              <label class="modern-toggle">
                <input type="checkbox" id="bgm-toggle" checked="checked" />
                <div class="toggle-track">
                  <div class="toggle-thumb">
                    <i class="toggle-icon fas fa-check"></i>
                  </div>
                </div>
              </label>
            </div>
          </div>
          <div class="setting-item disabled">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-eye"></i>
                视差滚动 <span class="coming-soon">即将推出</span>
              </div>
              <div class="setting-description">背景图层的深度滚动效果</div>
            </div>
            <div class="setting-control">
              <label class="modern-toggle disabled">
                <input type="checkbox" disabled="disabled" />
                <div class="toggle-track">
                  <div class="toggle-thumb">
                    <i class="toggle-icon fas fa-times"></i>
                  </div>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-section text-settings-section">
        <div class="section-header">
          <i class="fas fa-font"></i>
          <label class="section-title">文字设置</label>
        </div>
        <div class="settings-options">
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-keyboard"></i>
                文字显示效果
              </div>
              <div class="setting-description">选择文字出现的动画效果</div>
            </div>
            <div class="setting-control">
              <select id="text-animation-type" class="modern-select">
                <option value="typewriter">打字机效果</option>
                <option value="fade">渐显效果</option>
                <option value="instant">即时显示</option>
              </select>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-tachometer-alt"></i>
                文字速度
              </div>
              <div class="setting-description">调整文字出现的速度</div>
            </div>
            <div class="setting-control">
              <div class="slider-container">
                <input
                  type="range"
                  id="text-speed-slider"
                  class="modern-slider"
                  min="10"
                  max="200"
                  value="180"
                  step="10"
                />
                <div class="slider-labels">
                  <span>慢</span>
                  <span id="text-speed-value">30ms</span>
                  <span>快</span>
                </div>
              </div>
            </div>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-name">
                <i class="fas fa-text-height"></i>
                字体大小
              </div>
              <div class="setting-description">调整对话文字的大小</div>
            </div>
            <div class="setting-control">
              <div class="slider-container">
                <input type="range" id="font-size-slider" class="modern-slider" min="12" max="32" value="16" step="2" />
                <div class="slider-labels">
                  <span>小</span>
                  <span id="font-size-value">16px</span>
                  <span>大</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-section default-settings-section">
        <div class="settings-options">
          <div class="setting-item reset-setting-item">
            <div class="setting-control">
              <button id="reset-settings-btn" class="reset-btn">恢复默认</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
